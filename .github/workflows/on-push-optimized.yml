name: on-push

on:
  workflow_dispatch:
  push:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: global
  cancel-in-progress: false

jobs:
  analyze:
    name: Pre-analysis
    runs-on: ubuntu-24.04-arm
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_KEY: ${{ secrets.VITE_SUPABASE_KEY }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      API_KEY: ${{ secrets.GEMINI_API_KEY }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_KEY }}

    steps:
      - name: Wait in Queue
        uses: softprops/turnstyle@v2
        with:
          poll-interval-seconds: 30
          same-branch-only: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Extended Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.npm
          key: opencode-${{ runner.os }}-${{ hashFiles('.github/prompt/*.md') }}-v3
          restore-keys: |
            opencode-${{ runner.os }}-v3
            opencode-${{ runner.os }}-

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"

      - name: Check if Changes Exist
        id: check_changes
        run: |
          if [ "$(git diff --name-only HEAD~1 HEAD | wc -l)" -eq 0 ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if No Changes
        if: steps.check_changes.outputs.no_changes == 'true'
        run: |
          echo "No changes detected, skipping analysis"
          exit 0

      - name: Install OpenCode
        if: steps.check_changes.outputs.no_changes == 'false'
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Check Open Issues
        id: check_issues
        if: steps.check_changes.outputs.no_changes == 'false'
        run: |
          count=$(gh issue list --state open --json number --jq 'length')
          echo "open_issue_count=$count" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Parallel Flow Jobs - Group 1
  flow-00:
    if: needs.analyze.outputs.no_changes == 'false' && needs.analyze.outputs.open_issue_count == '0'
    needs: analyze
    name: Flow 00 (Strategist)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30
    continue-on-error: true
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Flow 00
        run: |
          if opencode run "$(cat .github/prompt/00-strategist.md)" \
            --model opencode/glm-4.7-free \
            --share false; then
            echo "✓ Flow 00 succeeded"
          else
            echo "✗ Flow 00 failed"

  flow-01:
    if: needs.analyze.outputs.no_changes == 'false' && needs.analyze.outputs.open_issue_count == '0'
    needs: analyze
    name: Flow 01 (Code Review)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30
    continue-on-error: true
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Flow 01
        run: |
          if opencode run "$(cat .github/prompt/01-code-review.md)" \
            --model opencode/glm-4.7-free \
            --share false; then
            echo "✓ Flow 01 succeeded"
          else
            echo "✗ Flow 01 failed"

  flow-02:
    if: needs.analyze.outputs.no_changes == 'false' && needs.analyze.outputs.open_issue_count == '0'
    needs: analyze
    name: Flow 02 (Docs Hygiene)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30
    continue-on-error: true
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Flow 02
        run: |
          if opencode run "$(cat .github/prompt/02-docs-hygiene.md)" \
            --model opencode/glm-4.7-free \
            --share false; then
            echo "✓ Flow 02 succeeded"
          else
            echo "✗ Flow 02 failed"

  # Parallel Flow Jobs - Group 2
  flow-03:
    if: needs.analyze.outputs.no_changes == 'false' && needs.analyze.outputs.open_issue_count == '0'
    needs: [analyze, flow-00, flow-01, flow-02]
    name: Flow 03 (Test Coverage)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30
    continue-on-error: true
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Flow 03
        run: |
          if opencode run "$(cat .github/prompt/03-test-coverage.md)" \
            --model opencode/glm-4.7-free \
            --share false; then
            echo "✓ Flow 03 succeeded"
          else
            echo "✗ Flow 03 failed"

  # Main Analysis Phase (runs after all flows)
  main-analysis:
    if: needs.analyze.outputs.open_issue_count == '0'
    needs: [analyze, flow-00, flow-01, flow-02, flow-03]
    name: Main Analysis
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 45
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_KEY: ${{ secrets.VITE_SUPABASE_KEY }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      API_KEY: ${{ secrets.GEMINI_API_KEY }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_KEY }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run Main Analysis
        run: |
          opencode run "$(cat .github/prompt/11-main.md)" \
            --model opencode/glm-4.7-free \
            --share false
