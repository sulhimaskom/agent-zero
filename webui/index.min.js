import*as t from"/js/messages.js";import*as e from"/js/api.js";import*as o from"/js/css.js";import{sleep as n}from"/js/sleep.js";import{STORAGE_KEYS as s,TIMING as r}from"/js/constants.js";import{store as a}from"/components/chat/attachments/attachmentsStore.js";import{store as i}from"/components/chat/speech/speech-store.js";import{store as l}from"/components/notifications/notification-store.js";import{store as c}from"/components/sidebar/bottom/preferences/preferences-store.js";import{store as d}from"/components/chat/input/input-store.js";import u from"/js/logger.js";import{store as m}from"/components/sidebar/chats/chats-store.js";import{store as p}from"/components/sidebar/tasks/tasks-store.js";import{store as g}from"/components/chat/top-section/chat-top-store.js";let h,f,x,y,C,S,T,E,I,b,v;globalThis.fetchApi=e.fetchApi;let w=null;globalThis.resetCounter=0;let A=!1;export async function sendMessage(){const t=document.getElementById("chat-input");if(t)try{const o=t.value.trim(),s=a.getAttachmentsForSending(),r=s.length>0;if(o||r){let i;const l="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)});if(t.value="",a.clearAttachments(),k(),r){_(l,"user",s.length>0?"Uploading attachments...":"User message",o,!1,{}),n(0);const t=new FormData;t.append("text",o),t.append("context",w),t.append("message_id",l);for(let e=0;e<s.length;e++)t.append("attachments",s[e].file);i=await e.fetchApi("/message_async",{method:"POST",body:t})}else{const t={text:o,context:w,message_id:l};i=await e.fetchApi("/message_async",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}const c=await i.json();c?setContext(c.context):toast("No response returned.","error")}}catch(t){toastFetchError("Error sending message",t)}else u.warn("chatInput not available, cannot send message")}globalThis.sendMessage=sendMessage;export function toastFetchError(t,e){u.error(t,e);const o=e?.message||e?.toString()||"Unknown error";getConnectionStatus()?toastFrontendError(`${t}: ${o}`).catch(t=>u.error("Failed to show error toast:",t)):toastFrontendError(`${t} (backend appears to be disconnected): ${o}`,"Connection Error").catch(t=>u.error("Failed to show connection error toast:",t))}globalThis.toastFetchError=toastFetchError;export function updateChatInput(t){const e=document.getElementById("chat-input");if(!e)return void u.warn("`chatInput` element not found, cannot update.");const o=e.value,n=o.length>0&&!o.endsWith(" ");e.value=o+(n?" ":"")+t+" ",k(),e.dispatchEvent(new Event("input"))}async function j(){let t=document.getElementById("time-date");for(;!t;)await n(100),t=document.getElementById("time-date");const e=new Date,o=e.getHours(),s=e.getMinutes(),r=e.getSeconds(),a=o>=12?"pm":"am",i=`${o%12||12}:${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")} ${a}`,l=e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});let c=t.querySelector("#user-date");c?t.firstChild&&(t.firstChild.textContent=i):(t.textContent=i,c=document.createElement("span"),c.id="user-date",t.appendChild(document.createElement("br")),t.appendChild(c)),c.textContent=l}j();const B=setInterval(j,1e3);function _(e,o,n,s,r,a=null){const i=t.setMessage(e,o,n,s,r,a),l=document.getElementById("chat-history");return c.autoScroll&&l&&(l.scrollTop=l.scrollHeight),i}function k(){const t=document.getElementById("chat-input");t&&(t.style.height="auto",t.style.height=t.scrollHeight+"px")}window.addEventListener("beforeunload",()=>{clearInterval(B)}),globalThis.loadKnowledge=async function(){await d.loadKnowledge()};export const sendJsonData=async function(t,o){return await e.callJsonApi(t,o)};globalThis.sendJsonData=sendJsonData;export function getConnectionStatus(){return g.connected}function D(t){g.connected=t}globalThis.getConnectionStatus=getConnectionStatus;let F=0,L="",M=0;export async function poll(){let e=!1;try{const o=Intl.DateTimeFormat().resolvedOptions().timeZone,n=F,r=await sendJsonData("/poll",{log_from:n,notifications_from:l.lastNotificationVersion||0,context:w||null,timezone:o});if(!r)return u.error("Invalid response from poll endpoint"),!1;if(r.deselect_chat)return void m.deselectChat();if(r.context!=w&&(null!==r.context||null!==w)&&null!==w)return;if(L!=r.log_guid){const t=document.getElementById("chat-history");if(t)for(;t.firstChild;)t.removeChild(t.firstChild);return F=0,L=r.log_guid,void await poll()}if(F!=r.log_version){e=!0;for(const t of r.logs){_(t.id||t.no,t.type,t.heading,t.content,t.temp,t.kvps)}!function(t){try{"true"==localStorage.getItem(s.SPEECH)&&function(t){if(A)return void(A=!1);for(let e=t.length-1;e>=0;e--){const o=t[e];if("response"==o.type)return void i.speakStream(getChatBasedId(o.no),o.content,o.kvps?.finished);if("agent"==o.type&&o.kvps&&o.kvps.headline&&o.kvps.tool_args&&"response"!=o.kvps.tool_name)return void i.speakStream(getChatBasedId(o.no),o.kvps.headline,!0)}}(t)}catch(t){}}(r.logs)}F=r.log_version,L=r.log_guid,function(e,o){const n=document.getElementById("progress-bar");if(!n)return;e||(e="");o?function(t,e){t.classList.add(e)}(n,"shiny-text"):(s="shiny-text",n.classList.remove(s));var s;e=t.convertIcons(e),n.textContent!==e&&(n.textContent=e)}(r.log_progress,r.log_progress_active),l.updateFromPoll(r),d.paused=r.paused,D(!0);let a=r.contexts||[];m.applyContexts(a);let c=r.tasks||[];if(p.applyTasks(c),w){m.setSelected(w);const t=m.contains(w),e=p.contains(w);if(e&&p.setSelected(w),!t&&!e)if(m.contexts.length>0){const t=m.firstId();t&&(setContext(t),m.setSelected(t))}else"function"==typeof deselectChat&&deselectChat()}else{const t=globalThis.Alpine&&"function"==typeof globalThis.Alpine.store?globalThis.Alpine.store("welcomeStore"):null;if(!Boolean(t&&t.isVisible)&&a.length>0){const t=m.firstId();t&&(setContext(t),m.setSelected(t))}}F=r.log_version,L=r.log_guid}catch(t){t.message?.includes("fetch")||t.message?.includes("network")||t.message?.includes("CSRF")||t.message?.includes("JSON")||u.error("Poll error:",t),D(!1)}return e}globalThis.poll=poll,globalThis.pauseAgent=async function(t){await d.pauseAgent(t)};export const newContext=function(){w=function(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let o=0;o<8;o++)e+=t.charAt(Math.floor(62*Math.random()));return e}(),setContext(w)};globalThis.newContext=newContext;export const setContext=function(t){if(t==w)return;w=t,L="",F=0,M=0,i.stopAudio();const e=document.getElementById("chat-history");if(e)for(;e.firstChild;)e.removeChild(e.firstChild);m.setSelected(t),p.setSelected(t);try{"true"==localStorage.getItem(s.SPEECH)&&(A=!0)}catch(t){}};export const deselectChat=function(){setContext(null);try{localStorage.removeItem(s.LAST_SELECTED_CHAT),localStorage.removeItem(s.LAST_SELECTED_TASK)}catch(t){}for(;C.firstChild;)C.removeChild(C.firstChild)};globalThis.deselectChat=deselectChat;export const getContext=function(){return w};globalThis.getContext=getContext,globalThis.setContext=setContext;export const getChatBasedId=function(t){return w+"-"+globalThis.resetCounter+"-"+t};export function justToast(t,e="info",o=r.TOAST_DISPLAY,n=""){l.addFrontendToastOnly(e,t,"",o/1e3,n)}globalThis.justToast=justToast;export function toast(t,e="info",o=r.TOAST_DISPLAY){const n=Math.max(o/1e3,1);switch(e.toLowerCase()){case"error":return l.frontendError(t,"Error",n);case"success":return l.frontendInfo(t,"Success",n);case"warning":return l.frontendWarning(t,"Warning",n);default:return l.frontendInfo(t,"Info",n)}}globalThis.toast=toast;export function updateAfterScroll(){const t=document.getElementById("chat-history");if(!t)return;!function(t){c.autoScroll=t}(t.scrollHeight-t.scrollTop<=t.clientHeight+10)}globalThis.updateAfterScroll=updateAfterScroll,document.addEventListener("DOMContentLoaded",function(){h=document.getElementById("left-panel"),f=document.getElementById("right-panel"),x=document.querySelector(".container"),y=document.getElementById("chat-input"),C=document.getElementById("chat-history"),S=document.getElementById("send-button"),T=document.getElementById("input-section"),E=document.getElementById("status-section"),I=document.getElementById("progress-bar"),b=document.getElementById("auto-scroll-switch"),v=document.getElementById("time-date-container"),C&&C.addEventListener("scroll",updateAfterScroll),async function(){let t=0;!async function e(){let o=250;try{await poll()&&(t=100),t>0&&t--,o=t>0?25:250}catch(t){u.error("Error:",t)}setTimeout(e.bind(this),o)}()}()}),globalThis.openTaskDetail=function(t){if(globalThis.Alpine){const e=document.getElementById("settings");if(e){e.click();const o=document.getElementById("settingsModal");if(!o)return void u.error("Settings modal element not found after clicking button");const n=globalThis.Alpine?Alpine.$data(o):null;setTimeout(()=>{n.switchTab("scheduler"),setTimeout(()=>{const e=document.querySelector('[x-data="schedulerSettings"]');if(!e)return void u.error("Scheduler component not found");(globalThis.Alpine?Alpine.$data(e):null).showTaskDetail(t)},50)},25)}else u.error("Settings button not found")}else u.error("Alpine.js not loaded")};