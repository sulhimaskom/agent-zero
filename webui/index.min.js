import*as msgs from"/js/messages.js";import*as api from"/js/api.js";import*as css from"/js/css.js";import{sleep}from"/js/sleep.js";import{STORAGE_KEYS,TIMING}from"/js/constants.js";import{store as attachmentsStore}from"/components/chat/attachments/attachmentsStore.js";import{store as speechStore}from"/components/chat/speech/speech-store.js";import{store as notificationStore}from"/components/notifications/notification-store.js";import{store as preferencesStore}from"/components/sidebar/bottom/preferences/preferences-store.js";import{store as inputStore}from"/components/chat/input/input-store.js";import Logger from"/js/logger.js";import{store as chatsStore}from"/components/sidebar/chats/chats-store.js";import{store as tasksStore}from"/components/sidebar/tasks/tasks-store.js";import{store as chatTopStore}from"/components/chat/top-section/chat-top-store.js";let leftPanel,rightPanel,container,chatInput,chatHistory,sendButton,inputSection,statusSection,progressBar,autoScrollSwitch,timeDate;globalThis.fetchApi=api.fetchApi;let autoScroll=!0,context=null;globalThis.resetCounter=0;let skipOneSpeech=!1;export async function sendMessage(){const t=document.getElementById("chat-input");if(t)try{const e=t.value.trim(),o=attachmentsStore.getAttachmentsForSending(),n=o.length>0;if(e||n){let s;const r=generateGUID();if(t.value="",attachmentsStore.clearAttachments(),adjustTextareaHeight(),n){setMessage(r,"user",o.length>0?"Uploading attachments...":"User message",e,!1,{}),sleep(0);const t=new FormData;t.append("text",e),t.append("context",context),t.append("message_id",r);for(let e=0;e<o.length;e++)t.append("attachments",o[e].file);s=await api.fetchApi("/message_async",{method:"POST",body:t})}else{const t={text:e,context:context,message_id:r};s=await api.fetchApi("/message_async",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}const a=await s.json();a?setContext(a.context):toast("No response returned.","error")}}catch(t){toastFetchError("Error sending message",t)}else Logger.warn("chatInput not available, cannot send message")}globalThis.sendMessage=sendMessage;export function toastFetchError(t,e){Logger.error(t,e);const o=e?.message||e?.toString()||"Unknown error";getConnectionStatus()?toastFrontendError(`${t}: ${o}`).catch(t=>Logger.error("Failed to show error toast:",t)):toastFrontendError(`${t} (backend appears to be disconnected): ${o}`,"Connection Error").catch(t=>Logger.error("Failed to show connection error toast:",t))}globalThis.toastFetchError=toastFetchError;export function updateChatInput(t){const e=document.getElementById("chat-input");if(!e)return void Logger.warn("`chatInput` element not found, cannot update.");const o=e.value,n=o.length>0&&!o.endsWith(" ");e.value=o+(n?" ":"")+t+" ",adjustTextareaHeight(),e.dispatchEvent(new Event("input"))}async function updateUserTime(){let t=document.getElementById("time-date");for(;!t;)await sleep(100),t=document.getElementById("time-date");const e=new Date,o=e.getHours(),n=e.getMinutes(),s=e.getSeconds(),r=o>=12?"pm":"am",a=`${o%12||12}:${n.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")} ${r}`,i=e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});let c=t.querySelector("#user-date");c?t.firstChild&&(t.firstChild.textContent=a):(t.textContent=a,c=document.createElement("span"),c.id="user-date",t.appendChild(document.createElement("br")),t.appendChild(c)),c.textContent=i}updateUserTime();const userTimeInterval=setInterval(updateUserTime,1e3);function setMessage(t,e,o,n,s,r=null){const a=msgs.setMessage(t,e,o,n,s,r),i=document.getElementById("chat-history");return preferencesStore.autoScroll&&i&&(i.scrollTop=i.scrollHeight),a}function adjustTextareaHeight(){const t=document.getElementById("chat-input");t&&(t.style.height="auto",t.style.height=t.scrollHeight+"px")}window.addEventListener("beforeunload",()=>{clearInterval(userTimeInterval)}),globalThis.loadKnowledge=async function(){await inputStore.loadKnowledge()};export const sendJsonData=async function(t,e){return await api.callJsonApi(t,e)};function generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}globalThis.sendJsonData=sendJsonData;export function getConnectionStatus(){return chatTopStore.connected}function setConnectionStatus(t){chatTopStore.connected=t}globalThis.getConnectionStatus=getConnectionStatus;let lastLogVersion=0,lastLogGuid="",lastSpokenNo=0;export async function poll(){let t=!1;try{const e=Intl.DateTimeFormat().resolvedOptions().timeZone,o=lastLogVersion,n=await sendJsonData("/poll",{log_from:o,notifications_from:notificationStore.lastNotificationVersion||0,context:context||null,timezone:e});if(!n)return"8080"===window.location.port||"file:"===window.location.protocol||Logger.error("Invalid response from poll endpoint"),!1;if(n.deselect_chat)return void chatsStore.deselectChat();if(n.context!=context&&(null!==n.context||null!==context)&&null!==context)return;if(lastLogGuid!=n.log_guid){const t=document.getElementById("chat-history");if(t)for(;t.firstChild;)t.removeChild(t.firstChild);return lastLogVersion=0,lastLogGuid=n.log_guid,void await poll()}if(lastLogVersion!=n.log_version){t=!0;for(const t of n.logs){setMessage(t.id||t.no,t.type,t.heading,t.content,t.temp,t.kvps)}afterMessagesUpdate(n.logs)}lastLogVersion=n.log_version,lastLogGuid=n.log_guid,updateProgress(n.log_progress,n.log_progress_active),notificationStore.updateFromPoll(n),inputStore.paused=n.paused,setConnectionStatus(!0);let s=n.contexts||[];chatsStore.applyContexts(s);let r=n.tasks||[];if(tasksStore.applyTasks(r),context){chatsStore.setSelected(context);const t=chatsStore.contains(context),e=tasksStore.contains(context);if(e&&tasksStore.setSelected(context),!t&&!e)if(chatsStore.contexts.length>0){const t=chatsStore.firstId();t&&(setContext(t),chatsStore.setSelected(t))}else"function"==typeof deselectChat&&deselectChat()}else{const t=globalThis.Alpine&&"function"==typeof globalThis.Alpine.store?globalThis.Alpine.store("welcomeStore"):null;if(!Boolean(t&&t.isVisible)&&s.length>0){const t=chatsStore.firstId();t&&(setContext(t),chatsStore.setSelected(t))}}lastLogVersion=n.log_version,lastLogGuid=n.log_guid}catch(t){t.message?.includes("fetch")||t.message?.includes("network")||t.message?.includes("CSRF")||t.message?.includes("JSON")||t.message?.includes("Static file mode")||t.message?.includes("backend")||t.message?.includes("backend not running")||Logger.error("Poll error:",t),setConnectionStatus(!1)}return t}function afterMessagesUpdate(t){try{"true"==localStorage.getItem(STORAGE_KEYS.SPEECH)&&speakMessages(t)}catch(t){}}function speakMessages(t){if(skipOneSpeech)skipOneSpeech=!1;else for(let e=t.length-1;e>=0;e--){const o=t[e];if("response"==o.type)return void speechStore.speakStream(getChatBasedId(o.no),o.content,o.kvps?.finished);if("agent"==o.type&&o.kvps&&o.kvps.headline&&o.kvps.tool_args&&"response"!=o.kvps.tool_name)return void speechStore.speakStream(getChatBasedId(o.no),o.kvps.headline,!0)}}function updateProgress(t,e){const o=document.getElementById("progress-bar");o&&(t||(t=""),e?addClassToElement(o,"shiny-text"):removeClassFromElement(o,"shiny-text"),t=msgs.convertIcons(t),o.textContent!==t&&(o.textContent=t))}function generateShortId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let o=0;o<8;o++)e+=t.charAt(Math.floor(62*Math.random()));return e}globalThis.poll=poll,globalThis.pauseAgent=async function(t){await inputStore.pauseAgent(t)};export const newContext=function(){context=generateShortId(),setContext(context)};globalThis.newContext=newContext;export const setContext=function(t){if(t==context)return;context=t,lastLogGuid="",lastLogVersion=0,lastSpokenNo=0,speechStore.stopAudio();const e=document.getElementById("chat-history");if(e)for(;e.firstChild;)e.removeChild(e.firstChild);chatsStore.setSelected(t),tasksStore.setSelected(t);try{"true"==localStorage.getItem(STORAGE_KEYS.SPEECH)&&(skipOneSpeech=!0)}catch(t){}};export const deselectChat=function(){setContext(null);try{localStorage.removeItem(STORAGE_KEYS.LAST_SELECTED_CHAT),localStorage.removeItem(STORAGE_KEYS.LAST_SELECTED_TASK)}catch(t){}for(;chatHistory.firstChild;)chatHistory.removeChild(chatHistory.firstChild)};globalThis.deselectChat=deselectChat;export const getContext=function(){return context};globalThis.getContext=getContext,globalThis.setContext=setContext;export const getChatBasedId=function(t){return context+"-"+globalThis.resetCounter+"-"+t};function addClassToElement(t,e){t.classList.add(e)}function removeClassFromElement(t,e){t.classList.remove(e)}export function justToast(t,e="info",o=TIMING.TOAST_DISPLAY,n=""){notificationStore.addFrontendToastOnly(e,t,"",o/1e3,n)}globalThis.justToast=justToast;export function toast(t,e="info",o=TIMING.TOAST_DISPLAY){const n=Math.max(o/1e3,1);switch(e.toLowerCase()){case"error":return notificationStore.frontendError(t,"Error",n);case"success":return notificationStore.frontendInfo(t,"Success",n);case"warning":return notificationStore.frontendWarning(t,"Warning",n);default:return notificationStore.frontendInfo(t,"Info",n)}}function scrollChanged(t){preferencesStore.autoScroll=t}globalThis.toast=toast;export function updateAfterScroll(){const t=document.getElementById("chat-history");if(!t)return;scrollChanged(t.scrollHeight-t.scrollTop<=t.clientHeight+10)}async function startPolling(){let t=0;!async function e(){let o=250;try{await poll()&&(t=100),t>0&&t--,o=t>0?25:250}catch(t){Logger.error("Error:",t)}setTimeout(e.bind(this),o)}()}function openTaskDetail(t){if(globalThis.Alpine){const e=document.getElementById("settings");if(e){e.click();const o=document.getElementById("settingsModal");if(!o)return void Logger.error("Settings modal element not found after clicking button");const n=globalThis.Alpine?Alpine.$data(o):null;setTimeout(()=>{n.switchTab("scheduler"),setTimeout(()=>{const e=document.querySelector('[x-data="schedulerSettings"]');if(!e)return void Logger.error("Scheduler component not found");(globalThis.Alpine?Alpine.$data(e):null).showTaskDetail(t)},50)},25)}else Logger.error("Settings button not found")}else Logger.error("Alpine.js not loaded")}globalThis.updateAfterScroll=updateAfterScroll,document.addEventListener("DOMContentLoaded",function(){leftPanel=document.getElementById("left-panel"),rightPanel=document.getElementById("right-panel"),container=document.querySelector(".container"),chatInput=document.getElementById("chat-input"),chatHistory=document.getElementById("chat-history"),sendButton=document.getElementById("send-button"),inputSection=document.getElementById("input-section"),statusSection=document.getElementById("status-section"),progressBar=document.getElementById("progress-bar"),autoScrollSwitch=document.getElementById("auto-scroll-switch"),timeDate=document.getElementById("time-date-container"),chatHistory&&chatHistory.addEventListener("scroll",updateAfterScroll),startPolling()}),globalThis.openTaskDetail=openTaskDetail;