import*as t from"/js/messages.min.js";import*as e from"/js/api.min.js";import*as n from"/js/css.min.js";import{sleep as o}from"/js/sleep.min.js";import{STORAGE_KEYS as s,TIMING as r}from"/js/constants.min.js";import{store as a}from"/components/chat/attachments/attachmentsStore.min.js";import{store as i}from"/components/chat/speech/speech-store.min.js";import{store as c}from"/components/notifications/notification-store.min.js";import{store as l}from"/components/sidebar/bottom/preferences/preferences-store.min.js";import{store as d}from"/components/chat/input/input-store.min.js";import u from"/js/logger.min.js";import{store as m}from"/components/sidebar/chats/chats-store.min.js";import{store as p}from"/components/sidebar/tasks/tasks-store.min.js";import{store as g}from"/components/chat/top-section/chat-top-store.min.js";import{store as h}from"/components/chat/typing-indicator/typing-indicator-store.min.js";let f,x,y,C,S,E,T,I,b,v,w;globalThis.fetchApi=e.fetchApi;let A=null;globalThis.resetCounter=0;let j=!1;export async function sendMessage(){const t=document.getElementById("chat-input");if(t)try{const n=t.value.trim(),s=a.getAttachmentsForSending(),r=s.length>0;if(n||r){let i;const c="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)});if(t.value="",a.clearAttachments(),D(),r){k(c,"user",s.length>0?"Uploading attachments...":"User message",n,!1,{}),o(0);const t=new FormData;t.append("text",n),t.append("context",A),t.append("message_id",c);for(let e=0;e<s.length;e++)t.append("attachments",s[e].file);i=await e.fetchApi("/message_async",{method:"POST",body:t})}else{const t={text:n,context:A,message_id:c};i=await e.fetchApi("/message_async",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}const l=await i.json();l?(setContext(l.context),h.show()):toast("No response returned.","error")}}catch(t){toastFetchError("Error sending message",t)}else u.warn("chatInput not available, cannot send message")}globalThis.sendMessage=sendMessage;export function toastFetchError(t,e){u.error(t,e);const n=e?.message||e?.toString()||"Unknown error";getConnectionStatus()?toastFrontendError(`${t}: ${n}`).catch(t=>u.error("Failed to show error toast:",t)):toastFrontendError(`${t} (backend appears to be disconnected): ${n}`,"Connection Error").catch(t=>u.error("Failed to show connection error toast:",t))}globalThis.toastFetchError=toastFetchError;export function updateChatInput(t){const e=document.getElementById("chat-input");if(!e)return void u.warn("`chatInput` element not found, cannot update.");const n=e.value,o=n.length>0&&!n.endsWith(" ");e.value=n+(o?" ":"")+t+" ",D(),e.dispatchEvent(new Event("input"))}async function _(){try{let t=document.getElementById("time-date");for(;!t;)await o(100),t=document.getElementById("time-date");const e=new Date,n=e.getHours(),s=e.getMinutes(),r=e.getSeconds(),a=n>=12?"pm":"am",i=`${n%12||12}:${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")} ${a}`,c={year:"numeric",month:"short",day:"numeric"},l=e.toLocaleDateString(void 0,c);let d=t.querySelector("#user-date");d?t.firstChild&&(t.firstChild.textContent=i):(t.textContent=i,d=document.createElement("span"),d.id="user-date",t.appendChild(document.createElement("br")),t.appendChild(d)),d.textContent=l}catch(t){}}_();const B=setInterval(_,r.USER_TIME_UPDATE_INTERVAL);function k(e,n,o,s,r,a=null){const i=t.setMessage(e,n,o,s,r,a),c=document.getElementById("chat-history");return l.autoScroll&&c&&(c.scrollTop=c.scrollHeight),i}function D(){const t=document.getElementById("chat-input");t&&(t.style.height="auto",t.style.height=t.scrollHeight+"px")}window.addEventListener("beforeunload",()=>{clearInterval(B)}),globalThis.loadKnowledge=async function(){await d.loadKnowledge()};export const sendJsonData=async function(t,n){return await e.callJsonApi(t,n)};globalThis.sendJsonData=sendJsonData;export function getConnectionStatus(){return g.connected}function L(t){g.connected=t}globalThis.getConnectionStatus=getConnectionStatus;let F=0,M="",O=0;export async function poll(){let e=!1;try{const n=Intl.DateTimeFormat().resolvedOptions().timeZone,o=F,r=await sendJsonData("/poll",{log_from:o,notifications_from:c.lastNotificationVersion||0,context:A||null,timezone:n});if(!r)return"8080"===window.location.port||"file:"===window.location.protocol||u.error("Invalid response from poll endpoint"),!1;if(r.deselect_chat)return void m.deselectChat();if(r.context!=A&&(null!==r.context||null!==A)&&null!==A)return;if(M!=r.log_guid){const t=document.getElementById("chat-history");if(t)for(;t.firstChild;)t.removeChild(t.firstChild);return F=0,M=r.log_guid,void await poll()}if(F!=r.log_version){e=!0;for(const t of r.logs){k(t.id||t.no,t.type,t.heading,t.content,t.temp,t.kvps)}!function(t){try{"true"==localStorage.getItem(s.SPEECH)&&function(t){if(j)return void(j=!1);for(let e=t.length-1;e>=0;e--){const n=t[e];if("response"==n.type)return void i.speakStream(getChatBasedId(n.no),n.content,n.kvps?.finished);if("agent"==n.type&&n.kvps&&n.kvps.headline&&n.kvps.tool_args&&"response"!=n.kvps.tool_name)return void i.speakStream(getChatBasedId(n.no),n.kvps.headline,!0)}}(t)}catch(t){}}(r.logs),h.hide()}F=r.log_version,M=r.log_guid,function(e,n){const o=document.getElementById("progress-bar");if(!o)return;e||(e="");n?function(t,e){t.classList.add(e)}(o,"shiny-text"):(s="shiny-text",o.classList.remove(s));var s;e=t.convertIcons(e),o.textContent!==e&&(o.textContent=e)}(r.log_progress,r.log_progress_active),c.updateFromPoll(r),d.paused=r.paused,L(!0);let a=r.contexts||[];m.applyContexts(a);let l=r.tasks||[];if(p.applyTasks(l),A){m.setSelected(A);const t=m.contains(A),e=p.contains(A);if(e&&p.setSelected(A),!t&&!e)if(m.contexts.length>0){const t=m.firstId();t&&(setContext(t),m.setSelected(t))}else"function"==typeof deselectChat&&deselectChat()}else{const t=globalThis.Alpine&&"function"==typeof globalThis.Alpine.store?globalThis.Alpine.store("welcomeStore"):null;if(!Boolean(t&&t.isVisible)&&a.length>0){const t=m.firstId();t&&(setContext(t),m.setSelected(t))}}F=r.log_version,M=r.log_guid}catch(t){t.message?.includes("fetch")||t.message?.includes("network")||t.message?.includes("CSRF")||t.message?.includes("JSON")||t.message?.includes("Static file mode")||t.message?.includes("backend")||t.message?.includes("backend not running")||u.error("Poll error:",t),L(!1)}return e}globalThis.poll=poll,globalThis.pauseAgent=async function(t){await d.pauseAgent(t)};export const newContext=function(){A=function(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let n=0;n<8;n++)e+=t.charAt(Math.floor(62*Math.random()));return e}(),setContext(A)};globalThis.newContext=newContext;export const setContext=function(t){if(t==A)return;A=t,M="",F=0,O=0,i.stopAudio();const e=document.getElementById("chat-history");if(e)for(;e.firstChild;)e.removeChild(e.firstChild);m.setSelected(t),p.setSelected(t);try{"true"==localStorage.getItem(s.SPEECH)&&(j=!0)}catch(t){}};export const deselectChat=function(){setContext(null);try{localStorage.removeItem(s.LAST_SELECTED_CHAT),localStorage.removeItem(s.LAST_SELECTED_TASK)}catch(t){}for(;S.firstChild;)S.removeChild(S.firstChild)};globalThis.deselectChat=deselectChat;export const getContext=function(){return A};globalThis.getContext=getContext,globalThis.setContext=setContext;export const getChatBasedId=function(t){return A+"-"+globalThis.resetCounter+"-"+t};export function justToast(t,e="info",n=r.TOAST_DISPLAY,o=""){c.addFrontendToastOnly(e,t,"",n/1e3,o)}globalThis.justToast=justToast;export function toast(t,e="info",n=r.TOAST_DISPLAY){const o=Math.max(n/1e3,1);switch(e.toLowerCase()){case"error":return c.frontendError(t,"Error",o);case"success":return c.frontendInfo(t,"Success",o);case"warning":return c.frontendWarning(t,"Warning",o);default:return c.frontendInfo(t,"Info",o)}}globalThis.toast=toast;export function updateAfterScroll(){const t=document.getElementById("chat-history");if(!t)return;!function(t){l.autoScroll=t}(t.scrollHeight-t.scrollTop<=t.clientHeight+10)}globalThis.updateAfterScroll=updateAfterScroll,document.addEventListener("DOMContentLoaded",function(){f=document.getElementById("left-panel"),x=document.getElementById("right-panel"),y=document.querySelector(".container"),C=document.getElementById("chat-input"),S=document.getElementById("chat-history"),E=document.getElementById("send-button"),T=document.getElementById("input-section"),I=document.getElementById("status-section"),b=document.getElementById("progress-bar"),v=document.getElementById("auto-scroll-switch"),w=document.getElementById("time-date-container"),S&&S.addEventListener("scroll",updateAfterScroll),async function(){let t=0;!async function e(){let n=250;try{await poll()&&(t=100),t>0&&t--,n=t>0?25:250}catch(t){u.error("Error:",t)}setTimeout(e.bind(this),n)}()}()}),globalThis.openTaskDetail=function(t){if(globalThis.Alpine){const e=document.getElementById("settings");if(e){e.click();const n=document.getElementById("settingsModal");if(!n)return void u.error("Settings modal element not found after clicking button");const o=globalThis.Alpine?Alpine.$data(n):null;setTimeout(()=>{o.switchTab("scheduler"),setTimeout(()=>{const e=document.querySelector('[x-data="schedulerSettings"]');if(!e)return void u.error("Scheduler component not found");(globalThis.Alpine?Alpine.$data(e):null).showTaskDetail(t)},50)},25)}else u.error("Settings button not found")}else u.error("Alpine.js not loaded")};