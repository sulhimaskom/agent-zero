import{createStore}from"/js/AlpineStore.min.js";const model={isLoading:!1,historyData:null,tokenCount:0,error:null,editor:null,closePromise:null,async open(){if(!this.isLoading){this.isLoading=!0,this.error=null,this.historyData=null,this.tokenCount=0;try{this.closePromise=window.openModal("modals/history/history.html"),this.closePromise&&"function"==typeof this.closePromise.then&&this.closePromise.then(()=>{this.destroy()}),this.updateModalTitle();const t=window.getContext(),o=await window.sendJsonData("/history_get",{context:t});this.historyData=o.history,this.tokenCount=o.tokens||0,this.isLoading=!1,this.updateModalTitle(),this.scheduleEditorInit()}catch(t){console.error("History fetch error:",t),this.error=t?.message||"Failed to load history",this.isLoading=!1,this.updateModalTitle()}}},scheduleEditorInit(){window.requestAnimationFrame(()=>{this.isLoading||this.error||window.requestAnimationFrame(()=>this.initEditor())})},initEditor(){if(!document.getElementById("history-viewer-container"))return void console.warn("History container not found, deferring editor init");if(this.editor?.destroy&&this.editor.destroy(),!window.ace?.edit)return console.error("ACE editor not available"),void(this.error="Editor library not loaded");const t=window.ace.edit("history-viewer-container");if(!t)return void console.error("Failed to create ACE editor instance");this.editor=t;const o=window.localStorage?.getItem("darkMode"),e="false"!==o?"ace/theme/github_dark":"ace/theme/tomorrow";this.editor.setTheme(e),this.editor.session.setMode("ace/mode/markdown"),this.editor.setValue(this.historyData,-1),this.editor.setReadOnly(!0),this.editor.clearSelection()},updateModalTitle(){window.requestAnimationFrame(()=>{const t=document.querySelectorAll(".modal.show .modal-title");if(!t.length)return;const o=t[t.length-1];o&&(this.error?o.textContent="History – Error":this.isLoading?o.textContent="History (loading…)":o.textContent=`History ~${this.tokenCount} tokens`)})},destroy(){this.editor?.destroy&&this.editor.destroy(),this.editor=null}};export const store=createStore("history",model);