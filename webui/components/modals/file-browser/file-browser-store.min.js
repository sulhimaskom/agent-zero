import{createStore}from"/js/AlpineStore.js";import{fetchApi}from"/js/api.js";const model={isLoading:!1,browser:{title:"File Browser",currentPath:"",entries:[],parentPath:"",sortBy:"name",sortDirection:"asc"},history:[],initialPath:"",closePromise:null,error:null,init(){},async open(e=""){if(!this.isLoading){this.isLoading=!0,this.error=null,this.history=[];try{this.closePromise=window.openModal("modals/file-browser/file-browser.html"),e=e||this.initialPath||this.browser.currentPath||"$WORK_DIR",this.browser.currentPath=e,await this.fetchFiles(this.browser.currentPath),await this.closePromise,this.destroy()}catch(e){console.error("File browser error:",e),this.error=e?.message||"Failed to load files",this.isLoading=!1}}},handleClose(){window.closeModal()},destroy(){this.isLoading=!1,this.history=[],this.initialPath="",this.browser.entries=[]},isArchive(e){const t=e.split(".").pop().toLowerCase();return["zip","tar","gz","rar","7z"].includes(t)},formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][t]},formatDate:e=>new Date(e).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),toggleSort(e){this.browser.sortBy===e?this.browser.sortDirection="asc"===this.browser.sortDirection?"desc":"asc":(this.browser.sortBy=e,this.browser.sortDirection="asc")},sortFiles(e){return[...e].sort((e,t)=>{if(e.is_dir!==t.is_dir)return e.is_dir?-1:1;const r="asc"===this.browser.sortDirection?1:-1;switch(this.browser.sortBy){case"name":return r*e.name.localeCompare(t.name);case"size":return r*(e.size-t.size);case"date":return r*(new Date(e.modified)-new Date(t.modified));default:return 0}})},async fetchFiles(e=""){this.isLoading=!0;try{const t=await fetchApi(`/get_work_dir_files?path=${encodeURIComponent(e)}`);if(t.ok){const e=await t.json();this.browser.entries=e.data.entries,this.browser.currentPath=e.data.current_path,this.browser.parentPath=e.data.parent_path}else console.error("Error fetching files:",await t.text()),this.browser.entries=[]}catch(e){window.toastFrontendError("Error fetching files: "+e.message,"File Browser Error"),this.browser.entries=[]}finally{this.isLoading=!1}},async navigateToFolder(e){e.startsWith("/")||(e="/"+e),this.browser.currentPath!==e&&this.history.push(this.browser.currentPath),await this.fetchFiles(e)},async navigateUp(){this.browser.parentPath&&(this.history.push(this.browser.currentPath),await this.fetchFiles(this.browser.parentPath))},async deleteFile(e){if(confirm(`Are you sure you want to delete ${e.name}?`))try{const t=await fetchApi("/delete_work_dir_file",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e.path,currentPath:this.browser.currentPath})});t.ok?(this.browser.entries=this.browser.entries.filter(t=>t.path!==e.path),alert("File deleted successfully.")):alert(`Error deleting file: ${await t.text()}`)}catch(e){window.toastFrontendError("Error deleting file: "+e.message,"File Delete Error")}},handleFileUpload:async e=>store._handleFileUpload(e),async _handleFileUpload(e){try{const t=e.target.files;if(!t.length)return;const r=new FormData;r.append("path",this.browser.currentPath);for(let e of t){const t=e.name.split(".").pop().toLowerCase();!["zip","tar","gz","rar","7z"].includes(t)&&e.size>104857600?alert(`File ${e.name} exceeds 100MB limit.`):r.append("files[]",e)}const i=await fetchApi("/upload_work_dir_files",{method:"POST",body:r});if(i.ok){const e=await i.json();if(this.browser.entries=e.data.entries,this.browser.currentPath=e.data.current_path,this.browser.parentPath=e.data.parent_path,e.failed&&e.failed.length){const t=e.failed.map(e=>`${e.name}: ${e.error}`).join("\n");alert(`Some files failed to upload:\n${t}`)}}else alert(await i.text())}catch(e){window.toastFrontendError("Error uploading files: "+e.message,"File Upload Error")}finally{e.target.value=""}},downloadFile(e){const t=document.createElement("a");t.href=`/download_work_dir_file?path=${encodeURIComponent(e.path)}`,t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t)}};export const store=createStore("fileBrowser",model);window.openFileLink=async function(e){try{const t=await window.sendJsonData("/file_info",{path:e});if(!t.exists)return void window.toastFrontendError("File does not exist.","File Error");t.is_dir?await store.open(t.abs_path):store.downloadFile({path:t.abs_path,name:t.file_name})}catch(e){window.toastFrontendError("Error opening file: "+e.message,"File Open Error")}};