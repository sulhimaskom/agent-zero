import{createStore}from"/js/AlpineStore.js";const model={currentImageUrl:null,currentImageName:null,baseImageUrl:null,imageLoaded:!1,imageError:!1,zoomLevel:1,refreshInterval:0,activeIntervalId:null,closePromise:null,async open(e,t){const r="number"==typeof t?{refreshInterval:t,name:null}:t||{};this.baseImageUrl=e,this.refreshInterval=r.refreshInterval||0,this.currentImageName=r.name||this.extractImageName(e),this.imageLoaded=!1,this.imageError=!1,this.zoomLevel=1,this.currentImageUrl=this.refreshInterval>0?this.addTimestamp(e):e;try{this.closePromise=window.openModal("modals/image-viewer/image-viewer.html"),this.closePromise&&"function"==typeof this.closePromise.finally&&this.closePromise.finally(()=>{this.stopRefresh(),this.resetState()}),this.refreshInterval>0&&this.setupAutoRefresh()}catch(e){console.error("Image viewer error:",e),this.imageError=!0}},setupAutoRefresh(){this.stopRefresh(),this.activeIntervalId=setInterval(()=>{this.isModalVisible()?this.preloadNextImage():this.stopRefresh()},this.refreshInterval)},async preloadNextImage(){const e=this.addTimestamp(this.baseImageUrl),t=new Promise((t,r)=>{const s=new Image;s.onload=()=>t(e),s.onerror=r,s.src=e});try{const e=await t;this.isModalVisible()&&(this.currentImageUrl=e,this.imageLoaded=!1)}catch(e){console.error("Failed to preload image:",e)}},isModalVisible(){const e=document.querySelector("#image-viewer-wrapper");if(!e)return!1;let t=e;for(;t;){const e=window.getComputedStyle(t);if("none"===e.display||"hidden"===e.visibility)return!1;t=t.parentElement}return!0},stopRefresh(){null!==this.activeIntervalId&&(clearInterval(this.activeIntervalId),this.activeIntervalId=null)},resetState(){this.currentImageUrl=null,this.currentImageName=null,this.baseImageUrl=null,this.imageLoaded=!1,this.imageError=!1,this.zoomLevel=1,this.refreshInterval=0},zoomIn(){this.zoomLevel=Math.min(1.2*this.zoomLevel,5),this.updateImageZoom()},zoomOut(){this.zoomLevel=Math.max(this.zoomLevel/1.2,.1),this.updateImageZoom()},resetZoom(){this.zoomLevel=1,this.updateImageZoom()},updateImageZoom(){const e=document.querySelector(".modal-image");e&&(e.style.transform=`scale(${this.zoomLevel})`)},addTimestamp(e){try{const t=new URL(e,window.location.origin);return t.searchParams.set("t",Date.now().toString()),t.toString()}catch(t){const r=e.includes("?")?"&":"?";return`${e}${r}t=${Date.now()}`}},extractImageName(e){try{const t=new URL(e,window.location.origin);return t.pathname.split("/").pop()||"Image"}catch(t){return e.split("/").pop()||"Image"}},destroy(){this.stopRefresh(),this.resetState()}};export const store=createStore("imageViewer",model);