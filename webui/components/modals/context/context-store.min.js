import{createStore}from"/js/AlpineStore.min.js";const model={isLoading:!1,contextData:null,tokenCount:0,error:null,editor:null,closePromise:null,async open(){if(!this.isLoading){this.isLoading=!0,this.error=null,this.contextData=null,this.tokenCount=0;try{this.closePromise=window.openModal("modals/context/context.html"),this.closePromise&&"function"==typeof this.closePromise.then&&this.closePromise.then(()=>{this.destroy()}),this.updateModalTitle();const t=window.getContext(),e=await window.sendJsonData("/ctx_window_get",{context:t});this.contextData=e.content,this.tokenCount=e.tokens||0,this.isLoading=!1,this.updateModalTitle(),this.scheduleEditorInit()}catch(t){console.error("Context fetch error:",t),this.error=t?.message||"Failed to load context window",this.isLoading=!1,this.updateModalTitle()}}},scheduleEditorInit(){window.requestAnimationFrame(()=>{this.isLoading||this.error||window.requestAnimationFrame(()=>this.initEditor())})},initEditor(){if(!document.getElementById("context-viewer-container"))return void console.warn("Context container not found, deferring editor init");if(this.editor?.destroy&&this.editor.destroy(),!window.ace?.edit)return console.error("ACE editor not available"),void(this.error="Editor library not loaded");const t=window.ace.edit("context-viewer-container");if(!t)return void console.error("Failed to create ACE editor instance");this.editor=t;const e=window.localStorage?.getItem("darkMode"),o="false"!==e?"ace/theme/github_dark":"ace/theme/tomorrow";this.editor.setTheme(o),this.editor.session.setMode("ace/mode/markdown"),this.editor.setValue(this.contextData,-1),this.editor.setReadOnly(!0),this.editor.clearSelection()},updateModalTitle(){window.requestAnimationFrame(()=>{const t=document.querySelectorAll(".modal.show .modal-title");if(!t.length)return;const e=t[t.length-1];e&&(this.error?e.textContent="Context Window – Error":this.isLoading?e.textContent="Context Window (loading…)":e.textContent=`Context Window ~${this.tokenCount} tokens`)})},destroy(){this.editor?.destroy&&this.editor.destroy(),this.editor=null}};export const store=createStore("context",model);