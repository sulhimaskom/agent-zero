import{createStore}from"/js/AlpineStore.js";import*as shortcuts from"/js/shortcuts.js";import{store as fileBrowserStore}from"/components/modals/file-browser/file-browser-store.js";import{TIMING}from"/js/constants.js";const model={paused:!1,isSending:!1,placeholderIndex:0,placeholderText:"Type your message here...",placeholderTyping:!1,placeholderInterval:null,characterCount:0,maxCharacterLimit:1e4,characterWarningThreshold:8e3,placeholderMessages:["Type your message here...","Ask me anything...","What would you like to explore?","Press Ctrl+Shift+F for fullscreen input âœ¨","Drop files or click the paperclip to attach ðŸ“Ž","Press Enter to send, Shift+Enter for new line","How can I help you today?","Try asking about code, analysis, or creative tasks...","Press ? for keyboard shortcuts âŒ¨ï¸"],init(){this.startPlaceholderRotation()},startPlaceholderRotation(){this.placeholderInterval=setInterval(()=>{this.cyclePlaceholder()},6e3)},stopPlaceholderRotation(){this.placeholderInterval&&(clearInterval(this.placeholderInterval),this.placeholderInterval=null)},async cyclePlaceholder(){const e=document.getElementById("chat-input");e&&e.value.trim().length>0||(this.placeholderTyping=!0,await this.animatePlaceholderChange(),this.placeholderIndex=(this.placeholderIndex+1)%this.placeholderMessages.length,this.placeholderText=this.placeholderMessages[this.placeholderIndex],this.placeholderTyping=!1)},animatePlaceholderChange:()=>new Promise(e=>{const t=document.getElementById("chat-input");if(!t)return void e();window.matchMedia("(prefers-reduced-motion: reduce)").matches?e():(t.style.transition=`opacity ${TIMING.ANIMATION_OPACITY_DURATION/1e3}s ease`,t.style.opacity="0.7",setTimeout(()=>{t.style.opacity="1",setTimeout(e,200)},200))}),async sendMessage(){if(!this.isSending){this.isSending=!0;try{globalThis.sendMessage&&await globalThis.sendMessage(),window.dispatchEvent(new CustomEvent("sent-message"))}finally{this.isSending=!1}}},adjustTextareaHeight(){const e=document.getElementById("chat-input");e&&(e.style.height="auto",e.style.height=e.scrollHeight+"px")},updateCharacterCount(){const e=document.getElementById("chat-input");e&&(this.characterCount=e.value.length)},getCharacterStatus(){return this.characterCount>=this.maxCharacterLimit?"critical":this.characterCount>=this.characterWarningThreshold?"warning":"normal"},async pauseAgent(e){const t=this.paused;this.paused=e;try{const t=globalThis.getContext?.();if(!globalThis.sendJsonData)throw new Error("sendJsonData not available");await globalThis.sendJsonData("/pause",{paused:e,context:t})}catch(a){this.paused=t,globalThis.toastFetchError&&globalThis.toastFetchError("Error pausing agent",a)}},async nudge(){try{const e=globalThis.getContext();await globalThis.sendJsonData("/nudge",{ctxid:e})}catch(e){globalThis.toastFetchError&&globalThis.toastFetchError("Error nudging agent",e)}},async loadKnowledge(){try{const e=await shortcuts.callJsonApi("/knowledge_path_get",{ctxid:shortcuts.getCurrentContextId()});if(!e.ok)throw new Error("Error getting knowledge path");const t=e.path;await fileBrowserStore.open(t),shortcuts.frontendNotification({type:shortcuts.NotificationType.PROGRESS,message:"Loading knowledge...",priority:shortcuts.NotificationPriority.NORMAL,displayTime:999,group:"knowledge_load",frontendOnly:!0}),await globalThis.sendJsonData("/knowledge_reindex",{ctxid:shortcuts.getCurrentContextId()}),shortcuts.frontendNotification({type:shortcuts.NotificationType.SUCCESS,message:"Knowledge loaded successfully",priority:shortcuts.NotificationPriority.NORMAL,displayTime:2,group:"knowledge_load",frontendOnly:!0})}catch(e){shortcuts.frontendNotification({type:shortcuts.NotificationType.ERROR,message:"Error loading knowledge",priority:shortcuts.NotificationPriority.NORMAL,displayTime:5,group:"knowledge_load",frontendOnly:!0})}},async _loadKnowledge(){const e=document.createElement("input");e.type="file",e.accept=".txt,.pdf,.csv,.html,.json,.md",e.multiple=!0,e.onchange=async()=>{try{const t=new FormData;for(let a of e.files)t.append("files[]",a);t.append("ctxid",globalThis.getContext());const a=await globalThis.fetchApi("/import_knowledge",{method:"POST",body:t});if(!a.ok){if(globalThis.toast)globalThis.toast(await a.text(),"error")}else{const e=await a.json();globalThis.toast&&globalThis.toast("Knowledge files imported: "+e.filenames.join(", "),"success")}}catch(e){globalThis.toastFetchError&&globalThis.toastFetchError("Error loading knowledge",e)}},e.click()},async browseFiles(e){if(!e)try{const t=await shortcuts.callJsonApi("/chat_files_path_get",{ctxid:shortcuts.getCurrentContextId()});t.ok&&(e=t.path)}catch(e){console.error("Error getting chat files path",e)}await fileBrowserStore.open(e)}};const store=createStore("chatInput",model);export{store};lobalThis.getContext?.();if(!globalThis.sendJsonData)throw new Error("sendJsonData not available");await globalThis.sendJsonData("/pause",{paused:e,context:t})}catch(e){this.paused=t,globalThis.toastFetchError&&globalThis.toastFetchError("Error pausing agent",e)}},async nudge(){try{const e=globalThis.getContext();await globalThis.sendJsonData("/nudge",{ctxid:e})}catch(e){globalThis.toastFetchError&&globalThis.toastFetchError("Error nudging agent",e)}},async loadKnowledge(){try{const e=await shortcuts.callJsonApi("/knowledge_path_get",{ctxid:shortcuts.getCurrentContextId()});if(!e.ok)throw new Error("Error getting knowledge path");const t=e.path;await fileBrowserStore.open(t),shortcuts.frontendNotification({type:shortcuts.NotificationType.PROGRESS,message:"Loading knowledge...",priority:shortcuts.NotificationPriority.NORMAL,displayTime:999,group:"knowledge_load",frontendOnly:!0}),await globalThis.sendJsonData("/knowledge_reindex",{ctxid:shortcuts.getCurrentContextId()}),shortcuts.frontendNotification({type:shortcuts.NotificationType.SUCCESS,message:"Knowledge loaded successfully",priority:shortcuts.NotificationPriority.NORMAL,displayTime:2,group:"knowledge_load",frontendOnly:!0})}catch(e){shortcuts.frontendNotification({type:shortcuts.NotificationType.ERROR,message:"Error loading knowledge",priority:shortcuts.NotificationPriority.NORMAL,displayTime:5,group:"knowledge_load",frontendOnly:!0})}},async _loadKnowledge(){const e=document.createElement("input");e.type="file",e.accept=".txt,.pdf,.csv,.html,.json,.md",e.multiple=!0,e.onchange=async()=>{try{const t=new FormData;for(let o of e.files)t.append("files[]",o);t.append("ctxid",globalThis.getContext());const o=await globalThis.fetchApi("/import_knowledge",{method:"POST",body:t});if(o.ok){const e=await o.json();globalThis.toast&&globalThis.toast("Knowledge files imported: "+e.filenames.join(", "),"success")}else globalThis.toast&&globalThis.toast(await o.text(),"error")}catch(e){globalThis.toastFetchError&&globalThis.toastFetchError("Error loading knowledge",e)}},e.click()},async browseFiles(e){if(!e)try{const t=await shortcuts.callJsonApi("/chat_files_path_get",{ctxid:shortcuts.getCurrentContextId()});t.ok&&(e=t.path)}catch(e){console.error("Error getting chat files path",e)}await fileBrowserStore.open(e)}},store=createStore("chatInput",model);export{store};