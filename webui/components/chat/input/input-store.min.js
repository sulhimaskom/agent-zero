import{createStore}from"/js/AlpineStore.min.js";import*as shortcuts from"/js/shortcuts.min.js";import{store as fileBrowserStore}from"/components/modals/file-browser/file-browser-store.min.js";import{TIMING}from"/js/constants.min.js";const model={paused:!1,isSending:!1,placeholderIndex:0,placeholderText:"Type your message here...",placeholderTyping:!1,placeholderInterval:null,characterCount:0,maxCharacterLimit:1e4,characterWarningThreshold:8e3,placeholderMessages:["Type your message here...","Ask me anything...","What would you like to explore?","Press Ctrl+Shift+F for fullscreen input âœ¨","Drop files or click the paperclip to attach ðŸ“Ž","Press Enter to send, Shift+Enter for new line","How can I help you today?","Try asking about code, analysis, or creative tasks...","Press ? for keyboard shortcuts âŒ¨ï¸"],init(){this.startPlaceholderRotation()},startPlaceholderRotation(){this.placeholderInterval=setInterval(()=>{this.cyclePlaceholder()},6e3)},stopPlaceholderRotation(){this.placeholderInterval&&(clearInterval(this.placeholderInterval),this.placeholderInterval=null)},async cyclePlaceholder(){const t=document.getElementById("chat-input");t&&t.value.trim().length>0||(this.placeholderTyping=!0,await this.animatePlaceholderChange(),this.placeholderIndex=(this.placeholderIndex+1)%this.placeholderMessages.length,this.placeholderText=this.placeholderMessages[this.placeholderIndex],this.placeholderTyping=!1)},animatePlaceholderChange:()=>new Promise(t=>{const e=document.getElementById("chat-input");if(!e)return void t();window.matchMedia("(prefers-reduced-motion: reduce)").matches?t():(e.style.transition=`opacity ${TIMING.ANIMATION_OPACITY_DURATION/1e3}s ease`,e.style.opacity="0.7",setTimeout(()=>{e.style.opacity="1",setTimeout(t,TIMING.ANIMATION_OPACITY_DURATION)},TIMING.ANIMATION_OPACITY_DURATION))}),async sendMessage(){if(!this.isSending){this.isSending=!0;try{globalThis.sendMessage&&await globalThis.sendMessage(),window.dispatchEvent(new CustomEvent("sent-message"))}finally{this.isSending=!1}}},adjustTextareaHeight(){const t=document.getElementById("chat-input");t&&(t.style.height="auto",t.style.height=t.scrollHeight+"px")},updateCharacterCount(){const t=document.getElementById("chat-input");t&&(this.characterCount=t.value.length)},getCharacterStatus(){return this.characterCount>=this.maxCharacterLimit?"critical":this.characterCount>=this.characterWarningThreshold?"warning":"normal"},async pauseAgent(t){const e=this.paused;this.paused=t;try{const e=globalThis.getContext?.();if(!globalThis.sendJsonData)throw new Error("sendJsonData not available");await globalThis.sendJsonData("/pause",{paused:t,context:e})}catch(t){this.paused=e,globalThis.toastFetchError&&globalThis.toastFetchError("Error pausing agent",t)}},async nudge(){try{const t=globalThis.getContext();await globalThis.sendJsonData("/nudge",{ctxid:t})}catch(t){globalThis.toastFetchError&&globalThis.toastFetchError("Error nudging agent",t)}},async loadKnowledge(){try{const t=await shortcuts.callJsonApi("/knowledge_path_get",{ctxid:shortcuts.getCurrentContextId()});if(!t.ok)throw new Error("Error getting knowledge path");const e=t.path;await fileBrowserStore.open(e),shortcuts.frontendNotification({type:shortcuts.NotificationType.PROGRESS,message:"Loading knowledge...",priority:shortcuts.NotificationPriority.NORMAL,displayTime:999,group:"knowledge_load",frontendOnly:!0}),await globalThis.sendJsonData("/knowledge_reindex",{ctxid:shortcuts.getCurrentContextId()}),shortcuts.frontendNotification({type:shortcuts.NotificationType.SUCCESS,message:"Knowledge loaded successfully",priority:shortcuts.NotificationPriority.NORMAL,displayTime:2,group:"knowledge_load",frontendOnly:!0})}catch(t){shortcuts.frontendNotification({type:shortcuts.NotificationType.ERROR,message:"Error loading knowledge",priority:shortcuts.NotificationPriority.NORMAL,displayTime:5,group:"knowledge_load",frontendOnly:!0})}},async _loadKnowledge(){const t=document.createElement("input");t.type="file",t.accept=".txt,.pdf,.csv,.html,.json,.md",t.multiple=!0,t.onchange=async()=>{try{const e=new FormData;for(let o of t.files)e.append("files[]",o);e.append("ctxid",globalThis.getContext());const o=await globalThis.fetchApi("/import_knowledge",{method:"POST",body:e});if(o.ok){const t=await o.json();globalThis.toast&&globalThis.toast("Knowledge files imported: "+t.filenames.join(", "),"success")}else globalThis.toast&&globalThis.toast(await o.text(),"error")}catch(t){globalThis.toastFetchError&&globalThis.toastFetchError("Error loading knowledge",t)}},t.click()},async browseFiles(t){if(!t)try{const e=await shortcuts.callJsonApi("/chat_files_path_get",{ctxid:shortcuts.getCurrentContextId()});e.ok&&(t=e.path)}catch(t){console.error("Error getting chat files path",t)}await fileBrowserStore.open(t)}},store=createStore("chatInput",model);export{store};