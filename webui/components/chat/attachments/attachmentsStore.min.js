import{createStore}from"/js/AlpineStore.js";import{fetchApi}from"/js/api.js";import{store as imageViewerStore}from"../../modals/image-viewer/image-viewer-store.js";const model={attachments:[],hasAttachments:!1,dragDropOverlayVisible:!1,async init(){await this.initialize()},async initialize(){this.setupDragDropHandlers(),this.setupPasteHandler()},addAttachment(e){this.validateDuplicates(e)&&(this.attachments.push(e),this.updateAttachmentState())},removeAttachment(e){e>=0&&e<this.attachments.length&&(this.attachments.splice(e,1),this.updateAttachmentState())},clearAttachments(){this.attachments=[],this.updateAttachmentState()},validateDuplicates(e){return!this.attachments.some(t=>t.name===e.name&&t.file&&e.file&&t.file.size===e.file.size)},updateAttachmentState(){this.hasAttachments=this.attachments.length>0},showDragDropOverlay(){this.dragDropOverlayVisible=!0},hideDragDropOverlay(){this.dragDropOverlayVisible=!1},setupDragDropHandlers(){let e=0;["dragenter","dragover","dragleave","drop"].forEach(e=>{document.addEventListener(e,e=>{e.preventDefault(),e.stopPropagation()},!1)}),document.addEventListener("dragenter",t=>{e++,1===e&&this.showDragDropOverlay()},!1),document.addEventListener("dragleave",t=>{e--,0===e&&this.hideDragDropOverlay()},!1),document.addEventListener("drop",t=>{e=0,this.hideDragDropOverlay();const a=t.dataTransfer.files;this.handleFiles(a)},!1)},setupPasteHandler(){document.addEventListener("paste",e=>{const t=e.clipboardData.items;let a=!1;for(let r=0;r<t.length;r++){const i=t[r];if(-1!==i.type.indexOf("image")){a=!0;const t=i.getAsFile();t&&(e.preventDefault(),this.handleClipboardImage(t));break}}a||"INPUT"!==e.target.tagName&&e.target.tagName})},async handleClipboardImage(e){try{const t=`clipboard-${this.generateGUID()}.png`,a=new File([e],t,{type:"image/png"}),r={file:a,type:"image",name:t,extension:"png",displayInfo:this.getAttachmentDisplayInfo(a)},i=new FileReader;i.onload=e=>{r.url=e.target.result,this.addAttachment(r)},i.readAsDataURL(a)}catch(e){console.error("Failed to handle clipboard image:",e)}},handleFileUpload(e){const t=e.target.files;this.handleFiles(t),e.target.value=""},handleFiles(e){Array.from(e).forEach(e=>{const t=e.name.split(".").pop().toLowerCase(),a=["jpg","jpeg","png","bmp","gif","webp","svg"].includes(t),r={file:e,type:a?"image":"file",name:e.name,extension:t,displayInfo:this.getAttachmentDisplayInfo(e)};if(a){const t=new FileReader;t.onload=e=>{r.url=e.target.result,this.addAttachment(r)},t.readAsDataURL(e)}else this.addAttachment(r)})},getAttachmentsForSending(){return this.attachments.map(e=>"image"===e.type?{...e,url:URL.createObjectURL(e.file)}:{...e})},getServerImgUrl:e=>`/image_get?path=/a0/tmp/uploads/${encodeURIComponent(e)}`,getServerFileUrl:e=>`/a0/tmp/uploads/${encodeURIComponent(e)}`,isImageFile(e){const t=e.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","bmp","webp","svg"].includes(t)},getAttachmentPreviewUrl(e){return"string"==typeof e?this.getServerImgUrl(e):e.name&&e.file?"image"===e.type?e.url||URL.createObjectURL(e.file):this.getServerImgUrl(e.name):null},getFilePreviewUrl:e=>`/public/${{zip:"archive",rar:"archive","7z":"archive",tar:"archive",gz:"archive",pdf:"document",doc:"document",docx:"document",txt:"document",rtf:"document",odt:"document",py:"code",js:"code",html:"code",css:"code",json:"code",xml:"code",md:"code",yml:"code",yaml:"code",sql:"code",sh:"code",bat:"code",xls:"document",xlsx:"document",csv:"document",ppt:"document",pptx:"document",odp:"document"}[e.split(".").pop().toLowerCase()]||"file"}.svg`,getAttachmentDisplayInfo(e){if("string"==typeof e){const t=e,a=t.split(".").pop(),r=this.isImageFile(t),i=r?this.getServerImgUrl(t):this.getFilePreviewUrl(t);return{filename:t,extension:a.toUpperCase(),isImage:r,previewUrl:i,clickHandler:()=>{this.isImageFile(t)?imageViewerStore.open(this.getServerImgUrl(t),{name:t}):this.downloadAttachment(t)}}}{const t=this.isImageFile(e.name),a=e.name,r=a.split(".").pop()||"",i=t?this.getServerImgUrl(e.name):this.getFilePreviewUrl(e.name);return{filename:a,extension:r.toUpperCase(),isImage:"image"===e.type,previewUrl:i,clickHandler:()=>{if("image"===e.type){const t=this.getServerImgUrl(e.name);imageViewerStore.open(t,{name:e.name})}else this.downloadAttachment(e.name)}}}},async downloadAttachment(e){try{const t=this.getServerFileUrl(e),a=await fetchApi("/download_work_dir_file?path="+t);if(!a.ok)throw new Error("Network response was not ok");const r=await a.blob(),i=document.createElement("a");i.href=window.URL.createObjectURL(r),i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(i.href)}catch(e){window.toastFetchError("Error downloading file",e),alert("Error downloading file")}},generateGUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},store=createStore("chatAttachments",model);export{store};