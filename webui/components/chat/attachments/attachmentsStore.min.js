import{createStore}from"/js/AlpineStore.js";import{fetchApi}from"/js/api.js";import{store as imageViewerStore}from"../../modals/image-viewer/image-viewer-store.js";const model={attachments:[],hasAttachments:!1,dragDropOverlayVisible:!1,dragFileCount:0,showDropSuccess:!1,async init(){await this.initialize()},async initialize(){this.setupDragDropHandlers(),this.setupPasteHandler()},addAttachment(e){this.validateDuplicates(e)&&(this.attachments.push(e),this.updateAttachmentState())},removeAttachment(e){e>=0&&e<this.attachments.length&&(this.attachments.splice(e,1),this.updateAttachmentState())},clearAttachments(){this.attachments=[],this.updateAttachmentState()},validateDuplicates(e){return!this.attachments.some((t=>t.name===e.name&&t.file&&e.file&&t.file.size===e.file.size))},updateAttachmentState(){this.hasAttachments=this.attachments.length>0},showDragDropOverlay(){this.dragDropOverlayVisible=!0},hideDragDropOverlay(){this.dragDropOverlayVisible=!1},setupDragDropHandlers(){let e=0;["dragenter","dragover","dragleave","drop"].forEach((e=>{document.addEventListener(e,(e=>{e.preventDefault(),e.stopPropagation()}),!1)})),document.addEventListener("dragenter",(t=>{if(e++,1===e){let e=0;t.dataTransfer&&(t.dataTransfer.items&&t.dataTransfer.items.length>0?e=t.dataTransfer.items.length:t.dataTransfer.files&&t.dataTransfer.files.length>0&&(e=t.dataTransfer.files.length)),this.dragFileCount=e,this.showDragDropOverlay()}}),!1),document.addEventListener("dragover",(e=>{if(this.dragDropOverlayVisible&&e.dataTransfer){let t=0;if(e.dataTransfer.items&&e.dataTransfer.items.length>0)for(let r=0;r<e.dataTransfer.items.length;r++)"file"===e.dataTransfer.items[r].kind&&t++;else e.dataTransfer.files&&e.dataTransfer.files.length>0&&(t=e.dataTransfer.files.length);t!==this.dragFileCount&&(this.dragFileCount=t)}}),!1),document.addEventListener("dragleave",(t=>{e--,0===e&&(this.hideDragDropOverlay(),this.dragFileCount=0)}),!1),document.addEventListener("drop",(t=>{e=0;const r=t.dataTransfer.files,a=r.length;this.handleFiles(r),a>0?(this.showDropSuccess=!0,setTimeout((()=>{this.showDropSuccess=!1,this.hideDragDropOverlay(),this.dragFileCount=0}),1200)):(this.hideDragDropOverlay(),this.dragFileCount=0)}),!1)},setupPasteHandler(){document.addEventListener("paste",(e=>{const t=e.clipboardData.items;let r=!1;for(let a=0;a<t.length;a++){const n=t[a];if(-1!==n.type.indexOf("image")){r=!0;const t=n.getAsFile();t&&(e.preventDefault(),this.handleClipboardImage(t));break}}!r&&("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)}))},async handleClipboardImage(e){try{const t=this.generateGUID(),r=`clipboard-${t}.png`,a=new File([e],r,{type:"image/png"}),n={file:a,type:"image",name:r,extension:"png",displayInfo:this.getAttachmentDisplayInfo(a)},s=new FileReader;s.onload=e=>{n.url=e.target.result,this.addAttachment(n)},s.readAsDataURL(a)}catch(e){console.error("Failed to handle clipboard image:",e)}},handleFileUpload(e){const t=e.target.files;this.handleFiles(t),e.target.value=""},handleFiles(e){Array.from(e).forEach((e=>{const t=e.name.split(".").pop().toLowerCase(),r=["jpg","jpeg","png","bmp","gif","webp","svg"].includes(t),a={file:e,type:r?"image":"file",name:e.name,extension:t,displayInfo:this.getAttachmentDisplayInfo(e)};if(r){const t=new FileReader;t.onload=e=>{a.url=e.target.result,this.addAttachment(a)},t.readAsDataURL(e)}else this.addAttachment(a)}))},getAttachmentsForSending(){return this.attachments.map((e=>"image"===e.type?{...e,url:URL.createObjectURL(e.file)}:{...e}))},getServerImgUrl(e){return`/image_get?path=/a0/tmp/uploads/${encodeURIComponent(e)}`},getServerFileUrl(e){return`/a0/tmp/uploads/${encodeURIComponent(e)}`},isImageFile(e){return["jpg","jpeg","png","gif","bmp","webp","svg"].includes(e.split(".").pop().toLowerCase())},getAttachmentPreviewUrl(e){if("string"==typeof e)return this.getServerImgUrl(e);if(e.name&&e.file)return"image"===e.type?e.url||URL.createObjectURL(e.file):this.getServerImgUrl(e.name);return null},getFilePreviewUrl(e){const t=e.split(".").pop().toLowerCase(),r={zip:"archive",rar:"archive","7z":"archive",tar:"archive",gz:"archive",pdf:"document",doc:"document",docx:"document",txt:"document",rtf:"document",odt:"document",py:"code",js:"code",html:"code",css:"code",json:"code",xml:"code",md:"code",yml:"code",yaml:"code",sql:"code",sh:"code",bat:"code",xls:"document",xlsx:"document",csv:"document",ppt:"document",pptx:"document",odp:"document"}[t]||"file";return`/public/${r}.svg`},getAttachmentDisplayInfo(e){if("string"==typeof e){const t=e,r=t.split(".").pop(),a=this.isImageFile(t),n=a?this.getServerImgUrl(t):this.getFilePreviewUrl(t);return{filename:t,extension:r.toUpperCase(),isImage:a,previewUrl:n,clickHandler:()=>{this.isImageFile(t)?imageViewerStore.open(this.getServerImgUrl(t),{name:t}):this.downloadAttachment(t)}}}{const t=this.isImageFile(e.name),r=e.name,a=r.split(".").pop()||"",n=t?this.getServerImgUrl(e.name):this.getFilePreviewUrl(e.name);return{filename:r,extension:a.toUpperCase(),isImage:"image"===e.type,previewUrl:n,clickHandler:()=>{if("image"===e.type){const t=this.getServerImgUrl(e.name);imageViewerStore.open(t,{name:e.name})}else this.downloadAttachment(e.name)}}}},async downloadAttachment(e){try{const t=this.getServerFileUrl(e),r=await fetchApi("/download_work_dir_file?path="+t);if(!r.ok)throw new Error("Network response was not ok");const a=await r.blob(),n=document.createElement("a");n.href=window.URL.createObjectURL(a),n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(n.href)}catch(e){window.toastFetchError("Error downloading file",e),alert("Error downloading file")}},generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}},store=createStore("chatAttachments",model);export{store};
