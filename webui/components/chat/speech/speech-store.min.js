import{createStore}from"/js/AlpineStore.min.js";import{updateChatInput,sendMessage}from"/index.min.js";import{sleep}from"/js/sleep.min.js";import{store as microphoneSettingStore}from"/components/settings/speech/microphone-setting-store.min.js";import*as shortcuts from"/js/shortcuts.min.js";import{TIMING,SPEECH}from"/js/constants.min.js";import Logger from"/js/logger.min.js";const Status={INACTIVE:"inactive",ACTIVATING:"activating",LISTENING:"listening",RECORDING:"recording",WAITING:"waiting",PROCESSING:"processing"},model={_initialized:!1,stt_model_size:SPEECH.DEFAULT_MODEL_SIZE,stt_language:SPEECH.DEFAULT_LANGUAGE,stt_silence_threshold:SPEECH.SILENCE_THRESHOLD,stt_silence_duration:SPEECH.SILENCE_DURATION,stt_waiting_timeout:SPEECH.WAITING_TIMEOUT,tts_kokoro:!1,isSpeaking:!1,speakingId:"",speakingText:"",currentAudio:null,audioEl:null,audioContext:null,userHasInteracted:!1,stopSpeechChain:!1,ttsStream:null,microphoneInput:null,isProcessingClick:!1,selectedDevice:null,get micStatus(){return this.microphoneInput?.status||Status.INACTIVE},updateMicrophoneButtonUI(){const t=document.getElementById("microphone-button");if(!t)return;const e=this.micStatus;t.classList.remove("mic-inactive","mic-activating","mic-listening","mic-recording","mic-waiting","mic-processing"),t.classList.add(`mic-${e.toLowerCase()}`),t.setAttribute("data-status",e)},async handleMicrophoneClick(){if(!this.isProcessingClick){this.isProcessingClick=!0;try{const t=microphoneSettingStore.getSelectedDevice();t!=this.selectedDevice&&(this.selectedDevice=t,this.microphoneInput=null),this.microphoneInput||await this.initMicrophone(),this.microphoneInput&&await this.microphoneInput.toggle()}finally{setTimeout(()=>{this.isProcessingClick=!1},300)}}},async init(){this._initialized||(this._initialized=!0,await this.loadSettings(),this.setupBrowserTTS(),this.setupUserInteractionHandling())},async loadSettings(){try{const t=await fetchApi("/settings_get",{method:"POST"}),e=(await t.json()).settings.sections.find(t=>"Speech"===t.title);e&&e.fields.forEach(t=>{this.hasOwnProperty(t.id)&&(this[t.id]=t.value)})}catch(t){t.message?.includes("CSRF token unavailable")||t.message?.includes("CSRF token endpoint returned")||t.message?.includes("backend not running")||t.message?.includes("Failed to fetch")||(window.toastFetchError("Failed to load speech settings",t),Logger.error("Failed to load speech settings:",t))}},setupBrowserTTS(){this.synth=window.speechSynthesis,this.browserUtterance=null},setupUserInteractionHandling(){const t=()=>{if(!this.userHasInteracted){this.userHasInteracted=!0;try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.resume()}catch(t){Logger.debug("AudioContext not available")}}};["click","touchstart","keydown","mousedown"].forEach(e=>{document.addEventListener(e,t,{once:!0,passive:!0})})},async speakStream(t,e,s=!1){if(this.ttsStream&&this.ttsStream.id===t&&this.ttsStream.text===e&&this.ttsStream.finished===s)return;if(!this.userHasInteracted)return this.showAudioPermissionPrompt();this.ttsStream&&this.ttsStream.id===t?(this.ttsStream.finished=s,this.ttsStream.text=e):this.ttsStream={id:t,text:e,finished:s,running:!1,lastChunkIndex:-1,stopped:!1,chunks:[]};const i=this.cleanText(e);if(!i.trim())return;if(this.ttsStream.chunks=this.chunkText(i),0==this.ttsStream.chunks.length)return;if(this.ttsStream.running)return;this.ttsStream.running=!0;const a=()=>this.ttsStream?.id!==t||this.ttsStream?.stopped,n=[];for(let t=this.ttsStream.lastChunkIndex+1;t<this.ttsStream.chunks.length&&(t!=this.ttsStream.chunks.length-1||this.ttsStream.finished);t++)this.ttsStream.lastChunkIndex=t,n.push(this.ttsStream.chunks[t]),await this._speak(this.ttsStream.chunks[t],t>0,()=>a());this.ttsStream.running=!1},async speak(t){const e=Math.random();return await this.speakStream(e,t,!0)},async _speak(t,e,s){if(!this.tts_kokoro)return await this.speakWithBrowser(t,e,s);try{await await this.speakWithKokoro(t,e,s)}catch(i){return console.error(i),await this.speakWithBrowser(t,e,s)}},chunkText(t,{maxChunkLength:e=135,lineSeparator:s="..."}={}){const i=t=>{const e=[];let s=0;for(let i=0;i<t.length;i++){const a=t[i];"."!==a&&"!"!==a&&"?"!==a||!/\s/.test(t[i+1]||"")||(e.push(t.slice(s,i+1)),i+=1,s=i+1)}return s<t.length&&e.push(t.slice(s)),e};let a=[];const n=t.split(/\n+/).filter(t=>t.trim());for(const t of n){if(!t.trim())continue;const e=i(t.trim());a.push(...e)}const r=[];let o="";for(let t=0;t<a.length;t++){const i=a[t];if(o){if(o.length<20){const t=o+" "+s+" "+i;t.length<=e?o=t:(r.push(o),o=i)}else r.push(o),o=i;t===a.length-1&&o&&r.push(o)}else o=i,(t===a.length-1||o.length>=20)&&(r.push(o),o="")}return r.map(t=>t.trimEnd())},showAudioPermissionPrompt(){shortcuts.frontendNotification({type:"info",message:"Click anywhere to enable audio playback",displayTime:TIMING.TOAST_DISPLAY,frontendOnly:!0})},async speakWithBrowser(t,e=!1,s=null){for(;e&&this.isSpeaking;)await sleep(25);s&&s()||(this.stopAudio(),this.browserUtterance=new SpeechSynthesisUtterance(t),this.browserUtterance.onstart=()=>{this.isSpeaking=!0},this.browserUtterance.onend=()=>{this.isSpeaking=!1},this.synth.speak(this.browserUtterance))},async speakWithKokoro(t,e=!1,s=null){try{const i=await sendJsonData("/synthesize",{text:t});for(;e&&this.isSpeaking;)await sleep(25);if(s&&s())return;if(this.stopAudio(),!i.success)throw new Error("Kokoro TTS error:",i.error);if(i.audio_parts)for(const t of i.audio_parts){if(s&&s())return;await this.playAudio(t),await sleep(100)}else i.audio&&this.playAudio(i.audio)}catch(t){throw new Error("Kokoro TTS error:",t)}},async playAudio(t){return new Promise((e,s)=>{const i=this.audioEl?this.audioEl:this.audioEl=new Audio;i.pause(),i.currentTime=0,i.onplay=()=>{this.isSpeaking=!0},i.onended=()=>{this.isSpeaking=!1,this.currentAudio=null,e()},i.onerror=t=>{this.isSpeaking=!1,this.currentAudio=null,s(t)},i.src=`data:audio/wav;base64,${t}`,this.currentAudio=i,i.play().catch(t=>{this.isSpeaking=!1,this.currentAudio=null,"NotAllowedError"===t.name&&(this.showAudioPermissionPrompt(),this.userHasInteracted=!1),s(t)})})},stop(){this.stopAudio(),this.ttsStream&&(this.ttsStream.stopped=!0)},stopAudio(){this.synth?.speaking&&this.synth.cancel(),this.audioEl&&(this.audioEl.pause(),this.audioEl.currentTime=0),this.currentAudio=null,this.isSpeaking=!1},cleanText(t){const e="code",s="table";function i(t,e,s,i){let a=t.replace(e,i||"");if(a!==t)return a;if(t.match(s))return t.replace(s,i||"");return t}if(t=i(t,/```(?:[a-zA-Z0-9]*\n)?[\s\S]*?```/g,/```(?:[a-zA-Z0-9]*\n)?[\s\S]*$/g,e),t=i(t=t.replace(/`([^`]*)`/g,"$1"),/<[a-zA-Z][a-zA-Z0-9]*>.*?<\/[a-zA-Z][a-zA-Z0-9]*>/gs,/<[a-zA-Z][a-zA-Z0-9]*>[\s\S]*$/g,""),(t=(t=(t=i(t,/<[a-zA-Z][a-zA-Z0-9]*(\/| [^>]*\/>)/g,/<[a-zA-Z][a-zA-Z0-9]* [^>]*$/g,"")).replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1")).replace(/[*_#]+/g,"")).includes("|")){const e=t.split("\n").filter(t=>t.includes("|")&&t.trim().startsWith("|"));if(e.length>0)for(const i of e)t=t.replace(i,s);else t=t.replace(/\|[^\n]*\|/g,s)}function a(t,e,s){const i=new RegExp(e+"\\s*"+e,"g");for(;i.test(t);)t=t.replace(i,e);return t.replace(new RegExp(e,"g"),s)}return t=a(t=(t=(t=(t=t.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g,"")).replace(/https?:\/\/[^\s]+/g,t=>{try{return new URL(t).hostname}catch{return""}})).replace(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/g,"UUID")).replace(/[ \t]+/g," "),e,"See code attached ..."),t=(t=a(t,s,"See table attached ...")).trim()},async initMicrophone(){if(this.microphoneInput)return this.microphoneInput;this.microphoneInput=new MicrophoneInput(async(t,e)=>{e&&this.sendMessage(t)});return await this.microphoneInput.initialize()?this.microphoneInput:null},async sendMessage(t){updateChatInput(t="(voice) "+t),this.microphoneInput.messageSent||(this.microphoneInput.messageSent=!0,await sendMessage())},async requestMicrophonePermission(){return this.microphoneInput?this.microphoneInput.requestPermission():MicrophoneInput.prototype.requestPermission.call(null)}};class MicrophoneInput{constructor(t){this.mediaRecorder=null,this.audioChunks=[],this.lastChunk=[],this.updateCallback=t,this.messageSent=!1,this.audioContext=null,this.mediaStreamSource=null,this.analyserNode=null,this._status=Status.INACTIVE,this.lastAudioTime=null,this.waitingTimer=null,this.silenceStartTime=null,this.hasStartedRecording=!1,this.analysisFrame=null}get status(){return this._status}set status(t){if(this._status===t)return;const e=this._status;this._status=t,this.handleStatusChange(e,t)}async initialize(){this.status=Status.ACTIVATING;try{const t=microphoneSettingStore.getSelectedDevice(),e=await navigator.mediaDevices.getUserMedia({audio:{deviceId:t&&t.deviceId?{exact:t.deviceId}:void 0,echoCancellation:!0,noiseSuppression:!0,channelCount:1}});return this.mediaRecorder=new MediaRecorder(e),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&(this.status===Status.RECORDING||this.status===Status.WAITING)?(this.lastChunk&&(this.audioChunks.push(this.lastChunk),this.lastChunk=null),this.audioChunks.push(t.data)):this.status===Status.LISTENING&&(this.lastChunk=t.data)},this.setupAudioAnalysis(e),!0}catch(t){return console.error("Microphone initialization error:",t),toast("Failed to access microphone. Please check permissions.","error"),!1}}handleStatusChange(t,e){switch(e!=Status.RECORDING&&(this.lastChunk=null),e){case Status.INACTIVE:this.handleInactiveState();break;case Status.LISTENING:this.handleListeningState();break;case Status.RECORDING:this.handleRecordingState();break;case Status.WAITING:this.handleWaitingState();break;case Status.PROCESSING:this.handleProcessingState()}}handleInactiveState(){this.stopRecording(),this.stopAudioAnalysis(),this.waitingTimer&&(clearTimeout(this.waitingTimer),this.waitingTimer=null)}handleListeningState(){this.stopRecording(),this.audioChunks=[],this.hasStartedRecording=!1,this.silenceStartTime=null,this.lastAudioTime=null,this.messageSent=!1,this.startAudioAnalysis()}handleRecordingState(){this.hasStartedRecording||"recording"===this.mediaRecorder.state||(this.hasStartedRecording=!0,this.mediaRecorder.start(SPEECH.RECORDER_CHUNK_SIZE)),this.waitingTimer&&(clearTimeout(this.waitingTimer),this.waitingTimer=null)}handleWaitingState(){this.waitingTimer=setTimeout(()=>{this.status===Status.WAITING&&(this.status=Status.PROCESSING)},store.stt_waiting_timeout)}handleProcessingState(){this.stopRecording(),this.process()}setupAudioAnalysis(t){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.mediaStreamSource=this.audioContext.createMediaStreamSource(t),this.analyserNode=this.audioContext.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.minDecibels=-90,this.analyserNode.maxDecibels=-10,this.analyserNode.smoothingTimeConstant=.85,this.mediaStreamSource.connect(this.analyserNode)}startAudioAnalysis(){const t=()=>{if(this.status===Status.INACTIVE)return;const e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);let s=0;for(let t=0;t<e.length;t++){const i=(e[t]-128)/128;s+=i*i}const i=Math.sqrt(s/e.length),a=Date.now();if(i>this.densify(store.stt_silence_threshold))this.lastAudioTime=a,this.silenceStartTime=null,this.status!==Status.LISTENING&&this.status!==Status.WAITING||store.isSpeaking||(this.status=Status.RECORDING);else if(this.status===Status.RECORDING){this.silenceStartTime||(this.silenceStartTime=a);a-this.silenceStartTime>=store.stt_silence_duration&&(this.status=Status.WAITING)}this.analysisFrame=requestAnimationFrame(t)};this.analysisFrame=requestAnimationFrame(t)}stopAudioAnalysis(){this.analysisFrame&&(cancelAnimationFrame(this.analysisFrame),this.analysisFrame=null)}stopRecording(){"recording"===this.mediaRecorder?.state&&(this.mediaRecorder.stop(),this.hasStartedRecording=!1)}densify(t){return Math.exp(-5*(1-t))}async process(){if(0===this.audioChunks.length)return void(this.status=Status.LISTENING);const t=new Blob(this.audioChunks,{type:"audio/wav"}),e=await this.convertBlobToBase64Wav(t);try{const t=await sendJsonData("/transcribe",{audio:e});this.filterResult(t.text||"")&&await this.updateCallback(t.text,!0)}catch(t){window.toastFetchError("Transcription error",t),Logger.error("Transcription error:",t)}finally{this.audioChunks=[],this.status=Status.LISTENING}}convertBlobToBase64Wav(t){return new Promise((e,s)=>{const i=new FileReader;i.onloadend=()=>{const t=i.result.split(",")[1];e(t)},i.onerror=t=>s(t),i.readAsDataURL(t)})}filterResult(t){t=t.trim();let e=!1;for(;!e&&t&&("{"!==t[0]||"}"!==t[t.length-1])&&("("!==t[0]||")"!==t[t.length-1])&&("["!==t[0]||"]"!==t[t.length-1]);)e=!0;if(e)return t}async toggle(){await this.requestPermission()&&(this.status===Status.INACTIVE||this.status===Status.ACTIVATING?this.status=Status.LISTENING:this.status=Status.INACTIVE)}async requestPermission(){try{return await navigator.mediaDevices.getUserMedia({audio:!0}),!0}catch(t){return Logger.error("Error accessing microphone:",t),toast("Microphone access denied. Please enable microphone access in your browser settings.","error"),!1}}}export const store=createStore("speech",model);document.addEventListener("settings-updated",()=>store.loadSettings());