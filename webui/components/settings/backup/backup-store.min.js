import{createStore}from"/js/AlpineStore.js";import{DEFAULTS,TIMING}from"/js/constants.js";const sendJsonData=globalThis.sendJsonData,toast=globalThis.toast,fetchApi=globalThis.fetchApi,model={mode:"backup",loading:!1,loadingMessage:"",error:"",fileOperationsLog:"",backupMetadataConfig:null,includeHidden:!1,previewStats:{total:0,truncated:!1},backupEditor:null,previewMode:"grouped",previewFiles:[],previewGroups:[],filteredPreviewFiles:[],fileSearchFilter:"",expandedGroups:new Set,progressData:null,progressEventSource:null,backupFile:null,backupMetadata:null,restorePatterns:"",overwritePolicy:"overwrite",cleanBeforeRestore:!1,restoreEditor:null,restoreResult:null,async initBackup(){this.mode="backup",this.resetState(),await this.initBackupEditor(),await this.updatePreview()},async initRestore(){this.mode="restore",this.resetState(),await this.initRestoreEditor()},resetState(){this.loading=!1,this.error="",this.backupFile=null,this.backupMetadata=null,this.restoreResult=null,this.fileOperationsLog=""},addFileOperation(e){const t=(new Date).toLocaleTimeString();this.fileOperationsLog+=`[${t}] ${e}\n`,setTimeout(()=>{const e=document.getElementById("backup"===this.mode?"backup-file-list":"restore-file-list");e&&(e.scrollTop=e.scrollHeight)},0)},clearFileOperations(){this.fileOperationsLog=""},onClose(){this.resetState(),this.backupEditor&&(this.backupEditor.destroy(),this.backupEditor=null),this.restoreEditor&&(this.restoreEditor.destroy(),this.restoreEditor=null)},async getDefaultBackupMetadata(){const e=(new Date).toISOString();try{const t=await sendJsonData("backup_get_defaults",{});if(t.success){const r=t.default_patterns.include_patterns,a=t.default_patterns.exclude_patterns;return{backup_name:`agent-zero-backup-${e.slice(0,10)}`,include_hidden:!1,include_patterns:r,exclude_patterns:a,backup_config:{compression_level:6,integrity_check:!0}}}}catch(e){console.warn("Failed to get default patterns from backend, using fallback")}return{backup_name:`agent-zero-backup-${e.slice(0,10)}`,include_hidden:!1,include_patterns:["# Loading default patterns from backend..."],exclude_patterns:[],backup_config:{compression_level:6,integrity_check:!0}}},async initBackupEditor(){if(document.getElementById("backup-metadata-editor")){const e=ace.edit("backup-metadata-editor");let t="true";try{t=localStorage.getItem("darkMode")}catch(e){}"false"!=t?e.setTheme("ace/theme/github_dark"):e.setTheme("ace/theme/tomorrow"),e.session.setMode("ace/mode/json");const r=await this.getDefaultBackupMetadata();let a;e.setValue(JSON.stringify(r,null,2)),e.clearSelection(),e.on("change",()=>{clearTimeout(a),a=setTimeout(()=>{this.updatePreview()},TIMING.DEBOUNCE_INPUT)}),this.backupEditor=e}},async initRestoreEditor(){if(document.getElementById("restore-metadata-editor")){const e=ace.edit("restore-metadata-editor");let t="true";try{t=localStorage.getItem("darkMode")}catch(e){}"false"!=t?e.setTheme("ace/theme/github_dark"):e.setTheme("ace/theme/tomorrow"),e.session.setMode("ace/mode/json"),e.setValue("{}"),e.clearSelection(),e.on("change",()=>{this.validateRestoreMetadata()}),this.restoreEditor=e}},getEditorValue(){const e="backup"===this.mode?this.backupEditor:this.restoreEditor;return e?e.getValue():"{}"},formatJson(){const e="backup"===this.mode?this.backupEditor:this.restoreEditor;if(e)try{const t=e.getValue(),r=JSON.parse(t),a=JSON.stringify(r,null,2);e.setValue(a),e.clearSelection(),e.navigateFileStart()}catch(e){console.error("Failed to format JSON:",e),this.error="Invalid JSON: "+e.message}},async updatePreview(){try{const e=this.getEditorValue(),t=JSON.parse(e);if(!t.include_patterns||0===t.include_patterns.length)return this.previewStats={total:0,truncated:!1},this.previewFiles=[],void(this.previewGroups=[]);const r=this.convertPatternsToString(t.include_patterns,t.exclude_patterns),a=await sendJsonData("backup_preview_grouped",{patterns:r,include_hidden:t.include_hidden||!1,max_depth:3,search_filter:this.fileSearchFilter});a.success?(this.previewGroups=a.groups,this.previewStats=a.stats,this.previewFiles=[],a.groups.forEach(e=>{this.previewFiles.push(...e.files)}),this.applyFileSearch()):this.error=a.error}catch(e){this.error=`Preview error: ${e.message}`}},convertPatternsToString(e,t){const r=[];return e&&r.push(...e),t&&t.forEach(e=>{r.push(`!${e}`)}),r.join("\n")},validateBackupMetadata(){try{const e=this.getEditorValue(),t=JSON.parse(e);if(!Array.isArray(t.include_patterns))throw new Error("include_patterns must be an array");if(!Array.isArray(t.exclude_patterns))throw new Error("exclude_patterns must be an array");if(!t.backup_name||"string"!=typeof t.backup_name)throw new Error("backup_name must be a non-empty string");return this.backupMetadataConfig=t,this.error="",!0}catch(e){return this.error=`Invalid backup metadata: ${e.message}`,!1}},initFilePreview(){this.fileSearchFilter="",this.expandedGroups.clear();try{this.previewMode=localStorage.getItem("backupPreviewMode")||"grouped"}catch(e){this.previewMode="grouped"}},togglePreviewMode(){this.previewMode="grouped"===this.previewMode?"flat":"grouped";try{localStorage.setItem("backupPreviewMode",this.previewMode)}catch(e){}},toggleGroup(e){this.expandedGroups.has(e)?this.expandedGroups.delete(e):this.expandedGroups.add(e)},isGroupExpanded(e){return this.expandedGroups.has(e)},debounceFileSearch(){clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.applyFileSearch()},300)},clearFileSearch(){this.fileSearchFilter="",this.applyFileSearch()},applyFileSearch(){if(this.fileSearchFilter.trim()){const e=this.fileSearchFilter.toLowerCase();this.filteredPreviewFiles=this.previewFiles.filter(t=>t.path.toLowerCase().includes(e))}else this.filteredPreviewFiles=this.previewFiles},async exportFileList(){const e=this.previewFiles.map(e=>e.path).join("\n"),t=new Blob([e],{type:"text/plain"}),r=URL.createObjectURL(t),a=document.createElement("a");a.href=r,a.download="backup-file-list.txt",a.click(),URL.revokeObjectURL(r)},async copyFileListToClipboard(){const e=this.previewFiles.map(e=>e.path).join("\n");try{await navigator.clipboard.writeText(e),window.toastFrontendInfo("File list copied to clipboard","Clipboard")}catch(e){window.toastFrontendError("Failed to copy to clipboard","Clipboard Error")}},async createBackup(){if(this.validateBackupMetadata())try{this.loading=!0,this.error="",this.clearFileOperations(),this.addFileOperation("Starting backup creation...");const e=this.backupMetadataConfig,t=await fetchApi("/backup_create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({include_patterns:e.include_patterns,exclude_patterns:e.exclude_patterns,include_hidden:e.include_hidden||!1,backup_name:e.backup_name})});if(t.ok){const r=await t.blob(),a=window.URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download=`${e.backup_name}.zip`,i.click(),window.URL.revokeObjectURL(a),this.addFileOperation("Backup created and downloaded successfully!"),window.toastFrontendInfo("Backup created and downloaded successfully","Backup Status")}else{const e=await t.text();try{const t=JSON.parse(e);this.error=t.error||"Backup creation failed"}catch{this.error=`Backup creation failed: ${t.status} ${t.statusText}`}this.addFileOperation(`Error: ${this.error}`)}}catch(e){this.error=`Backup error: ${e.message}`,this.addFileOperation(`Error: ${e.message}`)}finally{this.loading=!1}},async downloadBackup(e,t){try{const r=await fetchApi("/backup_download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({backup_path:e})});if(r.ok){const e=await r.blob(),a=window.URL.createObjectURL(e),i=document.createElement("a");i.href=a,i.download=`${t}.zip`,i.click(),window.URL.revokeObjectURL(a)}}catch(e){console.error("Download error:",e)}},cancelBackup(){this.progressEventSource&&(this.progressEventSource.close(),this.progressEventSource=null),this.loading=!1,this.progressData=null},resetToDefaults(){this.getDefaultBackupMetadata().then(e=>{this.backupEditor&&(this.backupEditor.setValue(JSON.stringify(e,null,2)),this.backupEditor.clearSelection()),this.updatePreview()})},async dryRun(){"backup"===this.mode?await this.dryRunBackup():"restore"===this.mode&&await this.dryRunRestore()},async dryRunBackup(){if(this.validateBackupMetadata())try{this.loading=!0,this.loadingMessage="Performing dry run...",this.clearFileOperations(),this.addFileOperation("Starting backup dry run...");const e=this.backupMetadataConfig,t=this.convertPatternsToString(e.include_patterns,e.exclude_patterns),r=await sendJsonData("backup_test",{patterns:t,include_hidden:e.include_hidden||!1,max_files:DEFAULTS.BACKUP_MAX_FILES});r.success?(this.addFileOperation(`Found ${r.files.length} files that would be backed up:`),r.files.forEach((e,t)=>{this.addFileOperation(`${t+1}. ${e.path} (${this.formatFileSize(e.size)})`)}),this.addFileOperation(`\nTotal: ${r.files.length} files, ${this.formatFileSize(r.files.reduce((e,t)=>e+t.size,0))}`),this.addFileOperation("Dry run completed successfully.")):(this.error=r.error,this.addFileOperation(`Error: ${r.error}`))}catch(e){this.error=`Dry run error: ${e.message}`,this.addFileOperation(`Error: ${e.message}`)}finally{this.loading=!1}},async dryRunRestore(){if(this.backupFile)try{this.loading=!0,this.loadingMessage="Performing restore dry run...",this.clearFileOperations(),this.addFileOperation("Starting restore dry run...");const e=new FormData;e.append("backup_file",this.backupFile),e.append("metadata",this.getEditorValue()),e.append("overwrite_policy",this.overwritePolicy),e.append("clean_before_restore",this.cleanBeforeRestore);const t=await fetchApi("/backup_restore_preview",{method:"POST",body:e}),r=await t.json();if(r.success){r.files_to_delete&&r.files_to_delete.length>0&&(this.addFileOperation(`Clean before restore - ${r.files_to_delete.length} files would be deleted:`),r.files_to_delete.forEach((e,t)=>{this.addFileOperation(`${t+1}. DELETE: ${e.path}`)}),this.addFileOperation("")),r.files_to_restore&&r.files_to_restore.length>0&&(this.addFileOperation(`${r.files_to_restore.length} files would be restored:`),r.files_to_restore.forEach((e,t)=>{this.addFileOperation(`${t+1}. RESTORE: ${e.original_path} -> ${e.target_path}`)})),r.skipped_files&&r.skipped_files.length>0&&(this.addFileOperation(`\nSkipped ${r.skipped_files.length} files:`),r.skipped_files.forEach((e,t)=>{this.addFileOperation(`${t+1}. ${e.original_path} (${e.reason})`)}));const e=r.delete_count||0,t=r.restore_count||0,a=r.skipped_files?.length||0;this.addFileOperation(`\nSummary: ${e} to delete, ${t} to restore, ${a} skipped`),this.addFileOperation("Dry run completed successfully.")}else this.error=r.error,this.addFileOperation(`Error: ${r.error}`)}catch(e){this.error=`Dry run error: ${e.message}`,this.addFileOperation(`Error: ${e.message}`)}finally{this.loading=!1}else this.error="Please select a backup file first"},async handleFileUpload(e){const t=e.target.files[0];if(t){this.backupFile=t,this.error="",this.restoreResult=null;try{this.loading=!0,this.loadingMessage="Inspecting backup archive...";const e=new FormData;e.append("backup_file",t);const r=await fetchApi("/backup_inspect",{method:"POST",body:e}),a=await r.json();a.success?(this.backupMetadata=a.metadata,this.restoreMetadata=JSON.parse(JSON.stringify(a.metadata)),this.restoreEditor&&(this.restoreEditor.setValue(JSON.stringify(this.restoreMetadata,null,2)),this.restoreEditor.clearSelection()),this.validateBackupCompatibility()):(this.error=a.error,this.backupMetadata=null)}catch(e){this.error=`Inspection error: ${e.message}`,this.backupMetadata=null}finally{this.loading=!1}}},validateBackupCompatibility(){if(!this.backupMetadata)return;const e=[],t=this.backupMetadata.agent_zero_version,r="current";t!==r&&"development"!==t&&e.push(`Backup created with Agent Zero ${t}, current version is ${r}`);const a=new Date(this.backupMetadata.timestamp),i=(Date.now()-a)/864e5;i>30&&e.push(`Backup is ${Math.floor(i)} days old`);const s=this.backupMetadata.system_info;s&&s.system,e.length>0&&window.toastFrontendWarning(`Compatibility warnings: ${e.join(", ")}`,"Backup Compatibility")},async performRestore(){if(this.backupFile)try{this.loading=!0,this.loadingMessage="Restoring files...",this.error="",this.clearFileOperations(),this.addFileOperation("Starting file restoration...");const e=new FormData;e.append("backup_file",this.backupFile),e.append("metadata",this.getEditorValue()),e.append("overwrite_policy",this.overwritePolicy),e.append("clean_before_restore",this.cleanBeforeRestore);const t=await fetchApi("/backup_restore",{method:"POST",body:e}),r=await t.json();if(r.success){r.deleted_files&&r.deleted_files.length>0&&(this.addFileOperation(`Clean before restore - Successfully deleted ${r.deleted_files.length} files:`),r.deleted_files.forEach((e,t)=>{this.addFileOperation(`${t+1}. DELETED: ${e.path}`)}),this.addFileOperation("")),this.addFileOperation(`Successfully restored ${r.restored_files.length} files:`),r.restored_files.forEach((e,t)=>{this.addFileOperation(`${t+1}. RESTORED: ${e.archive_path} -> ${e.target_path}`)}),r.skipped_files&&r.skipped_files.length>0&&(this.addFileOperation(`\nSkipped ${r.skipped_files.length} files:`),r.skipped_files.forEach((e,t)=>{this.addFileOperation(`${t+1}. ${e.original_path} (${e.reason})`)})),r.errors&&r.errors.length>0&&(this.addFileOperation("\nErrors during restoration:"),r.errors.forEach((e,t)=>{this.addFileOperation(`${t+1}. ${e.original_path}: ${e.error}`)}));const e=r.deleted_files?.length||0,t=r.restored_files.length,a=r.skipped_files?.length||0,i=r.errors?.length||0;this.addFileOperation(`\nRestore completed: ${e} deleted, ${t} restored, ${a} skipped, ${i} errors`),this.restoreResult=r,window.toastFrontendInfo("Restore completed successfully","Restore Status")}else this.error=r.error,this.addFileOperation(`Error: ${r.error}`)}catch(e){this.error=`Restore error: ${e.message}`,this.addFileOperation(`Error: ${e.message}`)}finally{this.loading=!1}else this.error="Please select a backup file"},validateRestoreMetadata(){try{const e=this.getEditorValue(),t=JSON.parse(e);if(!Array.isArray(t.include_patterns))throw new Error("include_patterns must be an array");if(!Array.isArray(t.exclude_patterns))throw new Error("exclude_patterns must be an array");return this.restoreMetadata=t,this.error="",!0}catch(e){return this.error=`Invalid JSON metadata: ${e.message}`,!1}},getCurrentRestoreMetadata(){return this.validateRestoreMetadata()?this.restoreMetadata:null},resetToOriginalMetadata(){this.backupMetadata&&(this.restoreMetadata=JSON.parse(JSON.stringify(this.backupMetadata)),this.restoreEditor&&(this.restoreEditor.setValue(JSON.stringify(this.restoreMetadata,null,2)),this.restoreEditor.clearSelection()))},formatTimestamp:e=>e?new Date(e).toLocaleString():"Unknown",formatFileSize(e){if(!e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,t)).toFixed(1)} ${["B","KB","MB","GB"][t]}`},formatDate:e=>e?new Date(e).toLocaleDateString():"Unknown"},store=createStore("backupStore",model);export{store};