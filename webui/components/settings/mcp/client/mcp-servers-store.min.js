import{createStore}from"/js/AlpineStore.min.js";import{scrollModal}from"/js/modals.min.js";import sleep from"/js/sleep.min.js";import*as API from"/js/api.min.js";import{TIMING}from"/js/constants.min.js";const model={editor:null,servers:[],loading:!0,statusCheck:!1,serverLog:"",async initialize(){if(document.getElementById("mcp-servers-config-json")){const e=ace.edit("mcp-servers-config-json");"false"!=localStorage.getItem("darkMode")?e.setTheme("ace/theme/github_dark"):e.setTheme("ace/theme/tomorrow"),e.session.setMode("ace/mode/json");const s=this.getSettingsFieldConfigJson().value;e.setValue(s),e.clearSelection(),this.editor=e}this.startStatusCheck()},formatJson(){try{const e=this.editor.getValue(),s=JSON.parse(e),t=JSON.stringify(s,null,2);this.editor.setValue(t),this.editor.clearSelection(),this.editor.navigateFileStart()}catch(e){console.error("Failed to format JSON:",e),alert("Invalid JSON: "+e.message)}},getEditorValue(){return this.editor.getValue()},getSettingsFieldConfigJson:()=>settingsModalProxy.settings.sections.filter(e=>"mcp_client"==e.id)[0].fields.filter(e=>"mcp_servers"==e.id)[0],onClose(){const e=this.getEditorValue();this.getSettingsFieldConfigJson().value=e,this.stopStatusCheck()},async startStatusCheck(){this.statusCheck=!0;let e=!0;for(;this.statusCheck;)await this._statusCheck(),e&&(this.loading=!1,e=!1),await sleep(TIMING.MCP_POLL_INTERVAL)},async _statusCheck(){const e=await API.callJsonApi("mcp_servers_status",null);e.success&&(this.servers=e.status,this.servers.sort((e,s)=>e.name.localeCompare(s.name)))},async stopStatusCheck(){this.statusCheck=!1},async applyNow(){if(!this.loading){this.loading=!0;try{scrollModal("mcp-servers-status");const e=await API.callJsonApi("mcp_servers_apply",{mcp_servers:this.getEditorValue()});e.success&&(this.servers=e.status,this.servers.sort((e,s)=>e.name.localeCompare(s.name))),this.loading=!1,await sleep(100),scrollModal("mcp-servers-status")}catch(e){console.error("Failed to apply MCP servers:",e)}this.loading=!1}},async getServerLog(e){this.serverLog="";const s=await API.callJsonApi("mcp_server_get_log",{server_name:e});s.success&&(this.serverLog=s.log,openModal("settings/mcp/client/mcp-servers-log.html"))},async onToolCountClick(e){const s=await API.callJsonApi("mcp_server_get_detail",{server_name:e});s.success&&(this.serverDetail=s.detail,openModal("settings/mcp/client/mcp-server-tools.html"))}},store=createStore("mcpServersStore",model);export{store};