import{createStore}from"/js/AlpineStore.js";import*as Sleep from"/js/sleep.js";import{QR_CODE,TIMING}from"/js/constants.js";import Logger from"/js/logger.min.js";const model={isLoading:!1,tunnelLink:"",linkGenerated:!1,loadingText:"",qrCodeInstance:null,provider:"cloudflared",init(){this.checkTunnelStatus()},generateQRCode(){if(!this.tunnelLink)return;const e=document.getElementById("qrcode-tunnel");if(e){e.innerHTML="";try{this.qrCodeInstance=new QRCode(e,{text:this.tunnelLink,width:QR_CODE.WIDTH,height:QR_CODE.HEIGHT,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M})}catch(n){console.error("Error generating QR code:",n),e.innerHTML='<div class="qr-error">QR code generation failed</div>'}}},async checkTunnelStatus(){if("undefined"!=typeof fetchApi)try{const e=await fetchApi("/tunnel_proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"get"})}),n=await e.json();if(n.success&&n.tunnel_url){if(this.tunnelLink!==n.tunnel_url){this.tunnelLink=n.tunnel_url;try{localStorage.setItem("agent_zero_tunnel_url",n.tunnel_url)}catch(e){}}this.linkGenerated=!0,Sleep.Skip().then(()=>this.generateQRCode())}else{let e=null;try{e=localStorage.getItem("agent_zero_tunnel_url")}catch(e){}if(e){const n=await fetchApi("/tunnel_proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"verify",url:e})}),t=await n.json();if(t.success&&t.is_valid)this.tunnelLink=e,this.linkGenerated=!0,Sleep.Skip().then(()=>this.generateQRCode());else{try{localStorage.removeItem("agent_zero_tunnel_url")}catch(e){}this.tunnelLink="",this.linkGenerated=!1}}else this.tunnelLink="",this.linkGenerated=!1}}catch(e){e.message?.includes("CSRF token unavailable")||e.message?.includes("CSRF token endpoint returned")||e.message?.includes("backend not running")||e.message?.includes("Failed to fetch")||console.error("Error checking tunnel status:",e),this.tunnelLink="",this.linkGenerated=!1}else Logger.debug("fetchApi not available yet, skipping tunnel status check")},async refreshLink(){if(confirm("Are you sure you want to generate a new tunnel URL? The old URL will no longer work.")){this.isLoading=!0,this.loadingText="Refreshing tunnel...";const e=document.querySelector("#tunnel-settings-section .refresh-link-button"),n=e.innerHTML;e.innerHTML='<span class="icon material-symbols-outlined spin">progress_activity</span> Refreshing...',e.disabled=!0,e.classList.add("refreshing");try{const e=await fetchApi("/tunnel_proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"stop"})});(await e.json()).success||console.warn("Warning: Couldn't stop existing tunnel cleanly"),await this.generateLink()}catch(e){console.error("Error refreshing tunnel:",e),window.toastFrontendError("Error refreshing tunnel","Tunnel Error"),this.isLoading=!1,this.loadingText=""}finally{e.innerHTML=n,e.disabled=!1,e.classList.remove("refreshing")}}},async generateLink(){try{const e=await fetchApi("/settings_get"),n=await e.json();let t=!1;if(n&&n.settings&&n.settings.sections)for(const e of n.settings.sections)if(e.fields){const n=e.fields.find(e=>"auth_login"===e.id),o=e.fields.find(e=>"auth_password"===e.id);if(n&&o&&n.value&&o.value){t=!0;break}}if(!t){if(!confirm("WARNING: No authentication is configured for your Agent Zero instance.\n\nCreating a public tunnel without authentication means anyone with the URL can access your Agent Zero instance.\n\nIt is recommended to set up authentication in the Settings > Authentication section before creating a public tunnel.\n\nDo you want to proceed anyway?"))return}}catch(e){console.error("Error checking authentication status:",e)}this.isLoading=!0,this.loadingText="Creating tunnel...";const e=document.querySelector("#tunnel-settings-section .tunnel-actions .btn-ok");e&&(e.innerHTML='<span class="icon material-symbols-outlined spin">progress_activity</span> Creating...',e.disabled=!0,e.classList.add("creating"));try{const e=await fetchApi("/tunnel_proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create",provider:this.provider})}),n=await e.json();if(n.success&&n.tunnel_url){try{localStorage.setItem("agent_zero_tunnel_url",n.tunnel_url)}catch(e){}this.tunnelLink=n.tunnel_url,this.linkGenerated=!0,Sleep.Skip().then(()=>this.generateQRCode()),window.toastFrontendInfo("Tunnel created successfully","Tunnel Status")}else{this.loadingText="Tunnel creation taking longer than expected...",await new Promise(e=>setTimeout(e,TIMING.TUNNEL_STATUS_TIMEOUT));try{const e=await fetchApi("/tunnel_proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"get"})}),n=await e.json();if(n.success&&n.tunnel_url){try{localStorage.setItem("agent_zero_tunnel_url",n.tunnel_url)}catch(e){}return this.tunnelLink=n.tunnel_url,this.linkGenerated=!0,Sleep.Skip().then(()=>this.generateQRCode()),void window.toastFrontendInfo("Tunnel created successfully","Tunnel Status")}}catch(e){console.error("Error checking tunnel status:",e)}const e=n.message||"Failed to create tunnel. Please try again.";window.toastFrontendError(e,"Tunnel Error"),console.error("Tunnel creation failed:",n)}}catch(e){window.toastFrontendError("Error creating tunnel","Tunnel Error"),console.error("Error creating tunnel:",e)}finally{this.isLoading=!1,this.loadingText="";const e=document.querySelector("#tunnel-settings-section .tunnel-actions .btn-ok");e&&(e.innerHTML='<span class="icon material-symbols-outlined">play_circle</span> Create Tunnel',e.disabled=!1,e.classList.remove("creating"))}},async stopTunnel(){if(confirm("Are you sure you want to stop the tunnel? The URL will no longer be accessible.")){this.isLoading=!0,this.loadingText="Stopping tunnel...";try{const e=await fetchApi("/tunnel_proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"stop"})});if((await e.json()).success){try{localStorage.removeItem("agent_zero_tunnel_url")}catch(e){}const e=document.getElementById("qrcode-tunnel");e&&(e.innerHTML=""),this.qrCodeInstance=null,this.tunnelLink="",this.linkGenerated=!1,window.toastFrontendInfo("Tunnel stopped successfully","Tunnel Status")}else window.toastFrontendError("Failed to stop tunnel","Tunnel Error"),stopButton.innerHTML=originalStopContent,stopButton.disabled=!1,stopButton.classList.remove("stopping")}catch(e){window.toastFrontendError("Error stopping tunnel","Tunnel Error"),console.error("Error stopping tunnel:",e),stopButton.innerHTML=originalStopContent,stopButton.disabled=!1,stopButton.classList.remove("stopping")}finally{this.isLoading=!1,this.loadingText=""}}},copyToClipboard(){this.tunnelLink&&navigator.clipboard.writeText(this.tunnelLink).then(()=>{window.dispatchEvent(new CustomEvent("copy-success",{detail:{component:"tunnel"}})),window.toastFrontendInfo("Tunnel URL copied to clipboard!","Clipboard")}).catch(e=>{console.error("Failed to copy URL: ",e),window.dispatchEvent(new CustomEvent("copy-error",{detail:{component:"tunnel"}})),window.toastFrontendError("Failed to copy tunnel URL","Clipboard Error")})}},store=createStore("tunnelStore",model);export{store};