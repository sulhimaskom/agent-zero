import{createStore}from"/js/AlpineStore.js";import{getContext}from"/index.js";import*as API from"/js/api.js";import{openModal,closeModal}from"/js/modals.js";import{store as notificationStore}from"/components/notifications/notification-store.js";import{LIMITS,STORAGE_KEYS,DEFAULTS,TIMING}from"/js/constants.js";function justToast(e,t="info",o=TIMING.TOAST_DISPLAY){notificationStore.addFrontendToastOnly(t,e,"",o/1e3)}const memoryDashboardStore={memories:[],currentPage:1,itemsPerPage:LIMITS.MEMORY_DASHBOARD_ITEMS_PER_PAGE,loading:!1,loadingSubdirs:!1,initializingMemory:!1,error:null,message:null,memorySubdirs:[],selectedMemorySubdir:"default",memoryInitialized:{},searchQuery:"",areaFilter:"",threshold:parseFloat((()=>{try{return localStorage.getItem(STORAGE_KEYS.MEMORY_DASHBOARD_THRESHOLD)||DEFAULTS.MEMORY_THRESHOLD}catch(e){return DEFAULTS.MEMORY_THRESHOLD}})()),limit:parseInt((()=>{try{return localStorage.getItem(STORAGE_KEYS.MEMORY_DASHBOARD_LIMIT)||DEFAULTS.MEMORY_LIMIT}catch(e){return DEFAULTS.MEMORY_LIMIT}})()),totalCount:0,totalDbCount:0,knowledgeCount:0,conversationCount:0,areasCount:{},detailMemory:null,editMode:!1,editMemoryBackup:null,pollingInterval:null,pollingEnabled:!1,recentlyCopied:{},copyFeedbackTimers:{},async openModal(){await openModal("settings/memory/memory-dashboard.html")},init(){this.initialize()},async onOpen(){await this.getCurrentMemorySubdir(),await this.loadMemorySubdirs(),await this.searchMemories(),this.startPolling()},async initialize(){this.currentPage=1,this.searchQuery="",this.areaFilter=""},async getCurrentMemorySubdir(){try{const e=await API.callJsonApi("memory_dashboard",{action:"get_current_memory_subdir",context_id:getContext()});e.success&&e.memory_subdir?this.selectedMemorySubdir=e.memory_subdir:this.selectedMemorySubdir="default"}catch(e){console.error("Failed to get current memory subdirectory:",e),this.selectedMemorySubdir="default"}},async loadMemorySubdirs(){this.loadingSubdirs=!0,this.error=null;try{const e=await API.callJsonApi("memory_dashboard",{action:"get_memory_subdirs"});if(e.success){let t=e.subdirs||["default"];t=t.filter(e=>"default"!==e).sort(),e.subdirs&&e.subdirs.includes("default"),t.unshift("default"),this.memorySubdirs=t,this.memorySubdirs.includes(this.selectedMemorySubdir)||(this.selectedMemorySubdir="default")}else this.error=e.error||"Failed to load memory subdirectories",this.memorySubdirs=["default"],this.selectedMemorySubdir="default"}catch(e){this.error=e.message||"Failed to load memory subdirectories",this.memorySubdirs=["default"],this.memorySubdirs.includes(this.selectedMemorySubdir)||(this.selectedMemorySubdir="default"),console.error("Memory subdirectory loading error:",e)}finally{this.loadingSubdirs=!1}},async searchMemories(e=!1){try{localStorage.setItem("memoryDashboard_limit",this.limit.toString()),localStorage.setItem("memoryDashboard_threshold",this.threshold.toString())}catch(e){}e||(this.loading=!0,this.error=null,this.message=null,this.memoryInitialized[this.selectedMemorySubdir]||(this.initializingMemory=!0));try{const t=await API.callJsonApi("memory_dashboard",{action:"search",memory_subdir:this.selectedMemorySubdir,area:this.areaFilter,search:this.searchQuery,limit:this.limit,threshold:this.threshold});if(t.success){const o={};e&&this.memories&&this.memories.forEach(e=>{e.selected&&(o[e.id]=!0)}),this.memories=(t.memories||[]).map(e=>({...e,selected:o[e.id]||!1})),this.totalCount=t.total_count||0,this.totalDbCount=t.total_db_count||0,this.knowledgeCount=t.knowledge_count||0,this.conversationCount=t.conversation_count||0,e?this.currentPage>this.totalPages&&this.totalPages>0&&(this.currentPage=this.totalPages):(this.message=t.message||null,this.currentPage=1),this.memoryInitialized[this.selectedMemorySubdir]=!0}else e?console.warn("Memory dashboard polling failed:",t.error):(this.error=t.error||"Failed to search memories",this.memories=[],this.message=null)}catch(t){e?console.warn("Memory dashboard polling error:",t):(this.error=t.message||"Failed to search memories",this.memories=[],this.message=null,console.error("Memory search error:",t))}finally{e||(this.loading=!1,this.initializingMemory=!1)}},async clearSearch(){this.areaFilter="",this.searchQuery="",this.currentPage=1,await this.searchMemories()},async onMemorySubdirChange(){await this.clearSearch()},get totalPages(){return Math.ceil(this.memories.length/this.itemsPerPage)},get paginatedMemories(){const e=(this.currentPage-1)*this.itemsPerPage,t=e+this.itemsPerPage;return this.memories.slice(e,t)},goToPage(e){e>=1&&e<=this.totalPages&&(this.currentPage=e)},nextPage(){this.currentPage<this.totalPages&&this.currentPage++},prevPage(){this.currentPage>1&&this.currentPage--},get selectedMemories(){return this.memories.filter(e=>e.selected)},get selectedCount(){return this.selectedMemories.length},get allSelected(){return this.memories.length>0&&this.memories.every(e=>e.selected)},get someSelected(){return this.memories.some(e=>e.selected)},toggleSelectAll(){const e=!this.allSelected;this.memories.forEach(t=>{t.selected=e})},clearSelection(){this.memories.forEach(e=>{e.selected=!1})},async bulkDeleteMemories(){const e=this.selectedMemories;if(0===e.length)return;const t=`Are you sure you want to delete ${e.length} selected memories? This cannot be undone.`;if(confirm(t))try{this.loading=!0;const t=await API.callJsonApi("memory_dashboard",{action:"bulk_delete",memory_subdir:this.selectedMemorySubdir,memory_ids:e.map(e=>e.id)});t.success?(justToast(`Successfully deleted ${e.length} memories`,"success"),await this.searchMemories(!0)):justToast(t.error||"Failed to delete selected memories","error")}catch(e){justToast(e.message||"Failed to delete selected memories","error")}finally{this.loading=!1}},formatMemoryForCopy(e){let t=`=== Memory ID: ${e.id} ===\nArea: ${e.area}\nTimestamp: ${this.formatTimestamp(e.timestamp)}\nSource: ${e.knowledge_source?"Knowledge":"Conversation"}\n${e.source_file?`File: ${e.source_file}`:""}\n${e.tags&&e.tags.length>0?`Tags: ${e.tags.join(", ")}`:""}`;if(e.metadata&&"object"==typeof e.metadata&&Object.keys(e.metadata).length>0){t+="\n\nMetadata:";for(const[o,r]of Object.entries(e.metadata)){t+=`\n${o}: ${"object"==typeof r?JSON.stringify(r,null,2):r}`}}return t+=`\n\nContent:\n${e.content_full}\n\n`,t},bulkCopyMemories(){const e=this.selectedMemories;if(0===e.length)return;const t=e.map(e=>this.formatMemoryForCopy(e)).join("\n");this.copyToClipboard(t,!1),justToast(`Copied ${e.length} memories with metadata to clipboard`,"success")},bulkExportMemories(){const e=this.selectedMemories;if(0===e.length)return;const t={export_timestamp:(new Date).toISOString(),memory_subdir:this.selectedMemorySubdir,total_memories:e.length,memories:e.map(e=>({id:e.id,area:e.area,timestamp:e.timestamp,content:e.content_full,tags:e.tags||[],knowledge_source:e.knowledge_source,source_file:e.source_file||null,metadata:e.metadata||{}}))},o=JSON.stringify(t,null,2),r=new Blob([o],{type:"application/json"}),s=URL.createObjectURL(r),i=(new Date).toISOString().split("T")[0],a=`memories_${this.selectedMemorySubdir}_selected_${e.length}_${i}.json`,l=document.createElement("a");l.href=s,l.download=a,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(s),justToast(`Exported ${e.length} selected memories to ${a}`,"success")},showMemoryDetails(e){this.detailMemory=e,this.editMode=!1,this.editMemoryBackup=null,openModal("settings/memory/memory-detail-modal.html")},closeMemoryDetails(){this.detailMemory=null},formatTimestamp(e,t=!1){if(!e||"unknown"===e)return"Unknown";const o=new Date(e);return isNaN(o.getTime())?"Invalid Date":t?o.toLocaleDateString("en-US",{month:"2-digit",day:"2-digit"})+" "+o.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit"}):o.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})+" at "+o.toLocaleTimeString("en-US",{hour12:!0,hour:"numeric",minute:"2-digit"})},formatTags:e=>Array.isArray(e)&&0!==e.length?e.join(", "):"None",getAreaColor:e=>({main:"#3b82f6",fragments:"#10b981",solutions:"#8b5cf6",instruments:"#f59e0b"}[e]||"#6c757d"),copyToClipboard(e,t=!0,o=null){const r=()=>{o&&this.showCopyFeedback(o)};navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{r(),t&&justToast("Copied to clipboard!","success")}).catch(r=>{console.error("Clipboard copy failed:",r),this.fallbackCopyToClipboard(e,t,o)}):this.fallbackCopyToClipboard(e,t,o)},fallbackCopyToClipboard(e,t=!0,o=null){const r=document.createElement("textarea");r.value=e,r.style.position="fixed",r.style.left="-999999px",r.style.top="-999999px",document.body.appendChild(r),r.focus(),r.select();try{document.execCommand("copy"),o&&this.showCopyFeedback(o),t&&justToast("Copied to clipboard!","success")}catch(e){console.error("Fallback clipboard copy failed:",e),justToast("Failed to copy to clipboard","error")}document.body.removeChild(r)},showCopyFeedback(e){this.copyFeedbackTimers[e]&&clearTimeout(this.copyFeedbackTimers[e]),this.recentlyCopied[e]=!0;const t=setTimeout(()=>{delete this.recentlyCopied[e],delete this.copyFeedbackTimers[e]},1500);this.copyFeedbackTimers[e]=t},async deleteMemory(e){if(confirm(`Are you sure you want to delete this memory from ${e.area}?`))try{const t=this.detailMemory&&this.detailMemory.id===e.id,o=await API.callJsonApi("memory_dashboard",{action:"delete",memory_subdir:this.selectedMemorySubdir,memory_id:e.id});o.success?(justToast("Memory deleted successfully","success"),t&&(this.detailMemory=null,closeModal()),await this.searchMemories(!0)):justToast(`Failed to delete memory: ${o.error}`,"error")}catch(e){console.error("Memory deletion error:",e),justToast("Failed to delete memory","error")}},exportMemories(){if(0!==this.memories.length)try{const e={memory_subdir:this.selectedMemorySubdir,export_timestamp:(new Date).toISOString(),total_memories:this.memories.length,search_query:this.searchQuery,area_filter:this.areaFilter,memories:this.memories.map(e=>({id:e.id,area:e.area,timestamp:e.timestamp,content:e.content_full,metadata:e.metadata}))},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(t),r=document.createElement("a");r.href=o,r.download=`memory-export-${this.selectedMemorySubdir}-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),justToast("Memory export completed","success")}catch(e){console.error("Memory export error:",e),justToast("Failed to export memories","error")}else justToast("No memories to export","warning")},startPolling(){this.pollingEnabled&&!this.pollingInterval&&(this.pollingInterval=setInterval(async()=>{await this.searchMemories(!0)},TIMING.MEMORY_DASHBOARD_POLL_INTERVAL))},stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)},cleanup(){this.stopPolling(),this.areaFilter="",this.searchQuery="",this.memories=[],this.totalCount=0,this.totalDbCount=0,this.knowledgeCount=0,this.conversationCount=0,this.areasCount={},this.message=null,this.currentPage=1,this.editMemoryBackup},enableEditMode(){this.editMode=!0,this.editMemoryBackup=JSON.stringify(this.detailMemory)},cancelEditMode(){this.editMode=!1,this.detailMemory=JSON.parse(this.editMemoryBackup)},async confirmEditMode(){try{const e=await API.callJsonApi("memory_dashboard",{action:"update",memory_subdir:this.selectedMemorySubdir,original:JSON.parse(this.editMemoryBackup),edited:this.detailMemory});e.success?(justToast("Memory updated successfully","success"),await this.searchMemories(!0)):justToast(`Failed to update memory: ${e.error}`,"error"),this.editMode=!1,this.editMemoryBackup=null}catch(e){console.error("Error confirming edit mode:",e),justToast("Failed to save memory changes.","error")}}},store=createStore("memoryDashboardStore",memoryDashboardStore);export{store};