import{createStore}from"/js/AlpineStore.js";import*as api from"/js/api.js";import*as modals from"/js/modals.js";import*as notifications from"/components/notifications/notification-store.js";import{store as chatsStore}from"/components/sidebar/chats/chats-store.js";import{store as browserStore}from"/components/modals/file-browser/file-browser-store.js";import*as shortcuts from"/js/shortcuts.js";const listModal="projects/project-list.html",createModal="projects/project-create.html",editModal="projects/project-edit.html",model={projectList:[],selectedProject:null,editData:null,colors:["#7b2cbf","#8338ec","#9b5de5","#d0bfff","#002975ff","#3a86ff","#0077b6","#4cc9f0","#00bbf9","#a5d8ff","#00f5d4","#06d6a0","#1a7431","#2a9d8f","#b2f2bb","#9ef01a","#e9c46a","#fee440","#ffec99","#ff9f43","#fb5607","#ffddb5","#f95738","#e76f51","#ff6b6b","#ffc9c9","#f15bb5","#ff006e","#ffafcc","#adb5bd","#6c757d"],_toFolderName(t){if(!t)return"";return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9\s-]/g,"_").replace(/\s+/g,"_").replace(/_{2,}/g,"_").replace(/^-+|-+$/g,"").replace(/^_+|_+$/g,"")},async openProjectsModal(){await this.loadProjectsList(),await modals.openModal(listModal)},async openCreateModal(){this.selectedProject=this._createNewProjectData(),await modals.openModal(createModal),this.selectedProject=null},async openEditModal(t){this.selectedProject=await this._createEditProjectData(t),await modals.openModal(editModal),this.selectedProject=null},async cancelCreate(){await modals.closeModal(createModal)},async cancelEdit(){await modals.closeModal(editModal)},async confirmCreate(){this.selectedProject.name=this._toFolderName(this.selectedProject.title);const t=await this.saveSelectedProject(!0);await this.loadProjectsList(),await modals.closeModal(createModal),await this.openEditModal(t.name)},async confirmEdit(){await this.saveSelectedProject(!1);await this.loadProjectsList(),await modals.closeModal(editModal)},async activateProject(t){try{const e=await api.callJsonApi("projects",{action:"activate",context_id:chatsStore.getSelectedChatId(),name:t});e?.ok?notifications.toastFrontendSuccess("Project activated successfully","Project activated",3,"projects",notifications.NotificationPriority.NORMAL,!0):notifications.toastFrontendWarning(e?.error||"Project activation reported issues","Project activation",5,"projects",notifications.NotificationPriority.NORMAL,!0)}catch(t){console.error("Error activating project:",t),notifications.toastFrontendError("Error activating project: "+t,"Error activating project",5,"projects",notifications.NotificationPriority.NORMAL,!0)}await this.loadProjectsList()},async deactivateProject(){try{const t=await api.callJsonApi("projects",{action:"deactivate",context_id:chatsStore.getSelectedChatId()});t?.ok?notifications.toastFrontendSuccess("Project deactivated successfully","Project deactivated",3,"projects",notifications.NotificationPriority.NORMAL,!0):notifications.toastFrontendWarning(t?.error||"Project deactivation reported issues","Project deactivated",5,"projects",notifications.NotificationPriority.NORMAL,!0)}catch(t){console.error("Error deactivating project:",t),notifications.toastFrontendError("Error deactivating project: "+t,"Error deactivating project",5,"projects",notifications.NotificationPriority.NORMAL,!0)}await this.loadProjectsList()},async deleteProjectAndCloseModal(){await this.deleteProject(this.selectedProject.name),await modals.closeModal(editModal)},async deleteProject(t){if(window.confirm("Are you sure you want to permanently delete this project? This action is irreversible and ALL FILES will be deleted."))try{const e=await api.callJsonApi("projects",{action:"delete",name:t});e.ok?(notifications.toastFrontendSuccess("Project deleted successfully","Project deleted",3,"projects",notifications.NotificationPriority.NORMAL,!0),await this.loadProjectsList()):notifications.toastFrontendWarning(e.error||"Project deletion blocked","Project delete",5,"projects",notifications.NotificationPriority.NORMAL,!0)}catch(t){console.error("Error deleting project:",t),notifications.toastFrontendError("Error deleting project: "+t,"Error deleting project",5,"projects",notifications.NotificationPriority.NORMAL,!0)}},async loadProjectsList(){this.loading=!0;try{const t=await api.callJsonApi("projects",{action:"list"});this.projectList=t.data||[]}catch(t){t.message?.includes("CSRF token unavailable")||t.message?.includes("CSRF token endpoint returned")||t.message?.includes("backend not running")||t.message?.includes("Failed to fetch")||console.error("Error loading projects list:",t)}finally{this.loading=!1}},async saveSelectedProject(t){try{const e={...this.selectedProject,memory:this.selectedProject._ownMemory?"own":"global"};for(const t of Object.entries(e))t[0].startsWith("_")&&delete e[t[0]];const o=await api.callJsonApi("projects",{action:t?"create":"update",project:e});return o.ok?(notifications.toastFrontendSuccess("Project saved successfully","Project saved",3,"projects",notifications.NotificationPriority.NORMAL,!0),o.data):(notifications.toastFrontendError(o.error||"Error saving project","Error saving project",5,"projects",notifications.NotificationPriority.NORMAL,!0),null)}catch(t){return console.error("Error saving project:",t),notifications.toastFrontendError("Error saving project: "+t,"Error saving project",5,"projects",notifications.NotificationPriority.NORMAL,!0),null}},_createNewProjectData(){return{_meta:{creating:!0},_ownMemory:!0,name:"",title:`Project #${this.projectList.length+1}`,description:"",color:""}},async _createEditProjectData(t){const e=(await api.callJsonApi("projects",{action:"load",name:t})).data;return{_meta:{creating:!1},...e,_ownMemory:"own"==e.memory}},async browseSelected(...t){const e=this.getSelectedAbsPath(...t);return await browserStore.open(e)},async browseInstructionFiles(){await this.browseSelected(".a0proj","instructions");try{const t=await this._createEditProjectData(this.selectedProject.name);this.selectedProject.instruction_files_count=t.instruction_files_count}catch(t){}},async browseKnowledgeFiles(){await this.browseSelected(".a0proj","knowledge");try{shortcuts.frontendNotification({type:shortcuts.NotificationType.PROGRESS,message:"Loading knowledge...",priority:shortcuts.NotificationPriority.NORMAL,displayTime:999,group:"knowledge_load",frontendOnly:!0});const t=api.callJsonApi("/knowledge_reindex",{ctxid:shortcuts.getCurrentContextId()}),e=await this._createEditProjectData(this.selectedProject.name);this.selectedProject.knowledge_files_count=e.knowledge_files_count,await t,shortcuts.frontendNotification({type:shortcuts.NotificationType.SUCCESS,message:"Knowledge loaded successfully",priority:shortcuts.NotificationPriority.NORMAL,displayTime:2,group:"knowledge_load",frontendOnly:!0})}catch(t){shortcuts.frontendNotification({type:shortcuts.NotificationType.ERROR,message:"Error loading knowledge",priority:shortcuts.NotificationPriority.NORMAL,displayTime:5,group:"knowledge_load",frontendOnly:!0})}},getSelectedAbsPath(...t){return["/a0/usr/projects",this.selectedProject.name,...t].join("/").replace(/\/+/g,"/")},async editActiveProject(){const t=shortcuts.getCurrentContext();t&&this.openEditModal(t.project.name)},async testFileStructure(){try{const t=await api.callJsonApi("projects",{action:"file_structure",name:this.selectedProject.name,settings:this.selectedProject.file_structure});this.fileStructureTestOutput=t.data,shortcuts.openModal("projects/project-file-structure-test.html")}catch(t){console.error("Error testing file structure:",t),shortcuts.frontendNotification({type:shortcuts.NotificationType.ERROR,message:"Error testing file structure",priority:shortcuts.NotificationPriority.NORMAL,displayTime:3,frontendOnly:!0})}}},store=createStore("projects",model);export{store};