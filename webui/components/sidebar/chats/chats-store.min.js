import{createStore}from"/js/AlpineStore.min.js";import{sendJsonData,getContext,setContext,poll as triggerPoll,updateAfterScroll,toastFetchError,toast,justToast,getConnectionStatus}from"/index.min.js";import{store as notificationStore}from"/components/notifications/notification-store.min.js";import{store as tasksStore}from"/components/sidebar/tasks/tasks-store.min.js";import{RETRY,TIMING}from"/js/constants.min.js";const model={contexts:[],selected:"",selectedContext:null,isLoading:!0,getSelectedChatId(){return this.selected},getSelectedContext(){return this.selectedContext},init(){try{const t=localStorage.getItem("lastSelectedChat");t&&this.selectChat(t)}catch(t){}},applyContexts(t){this.contexts=t.sort((t,e)=>(e.created_at||0)-(t.created_at||0)),this.isLoading=!1},async selectChat(t){t!==getContext()&&(setContext(t),this.setSelected(t),triggerPoll(),updateAfterScroll())},async killChat(t){if(t)try{this.selected===t&&await this.switchFromContext(t),await sendJsonData("/chat_remove",{context:t});const e=this.contexts.filter(e=>e.id!==t);this.contexts=[...e],justToast("Chat deleted successfully","success",TIMING.NOTIFICATION_DISPLAY,"chat-removal")}catch(t){console.error("Error deleting chat:",t),toastFetchError("Error deleting chat",t)}else console.error("No chat ID provided for deletion")},async switchFromContext(t){let e=null;for(let s=0;s<this.contexts.length;s++)if(this.contexts[s].id!==t){e=this.contexts[s];break}e?await this.selectChat(e.id):this.deselectChat()},async resetChat(t=null){try{const e=t||this.selected||getContext();await sendJsonData("/chat_reset",{context:e}),"number"==typeof globalThis.resetCounter&&(globalThis.resetCounter=globalThis.resetCounter+1),updateAfterScroll()}catch(t){toastFetchError("Error resetting chat",t)}},async newChat(){try{const t=await sendJsonData("/chat_create",{current_context:this.selected});if(t.ok)return void this.selectChat(t.ctxid)}catch(t){toastFetchError("Error creating new chat",t)}},deselectChat(){globalThis.deselectChat()},_scrollChatsToTop(){const t=document.querySelector("#chats-section .chats-config-list");t&&t.scrollTo({top:0,behavior:"smooth"})},async loadChats(){try{const t=await this.readJsonFiles(),e=await sendJsonData("/chat_load",{chats:t});e?(e.ctxids?.[0]&&setContext(e.ctxids[0]),toast("Chats loaded.","success")):toast("No response returned.","error")}catch(t){toastFetchError("Error loading chats",t)}},async saveChat(){try{const t=this.selected||getContext(),e=await sendJsonData("/chat_export",{ctxid:t});e?(this.downloadFile(e.ctxid+".json",e.content),toast("Chat file downloaded.","success")):toast("No response returned.","error")}catch(t){toastFetchError("Error saving chat",t)}},readJsonFiles:()=>new Promise((t,e)=>{const s=document.createElement("input");s.type="file",s.accept=".json",s.multiple=!0,s.click(),s.onchange=async()=>{const o=s.files;if(!o.length)return void t([]);const r=Array.from(o).map(t=>new Promise((e,s)=>{const o=new FileReader;o.onload=()=>e(o.result),o.onerror=s,o.readAsText(t)}));try{const e=await Promise.all(r);t(e)}catch(t){e(t)}}}),downloadFile(t,e){const s=new Blob([e],{type:"application/json"}),o=document.createElement("a"),r=URL.createObjectURL(s);o.href=r,o.download=t,o.click(),setTimeout(()=>{URL.revokeObjectURL(r)},0)},contains(t){return this.contexts.some(e=>e.id===t)},firstId(){return this.contexts.length>0?this.contexts[0].id:null},setSelected(t){this.selected=t,this.selectedContext=this.contexts.find(e=>e.id===t),this.selectedContext||(this.selectedContext=tasksStore.tasks.find(e=>e.id===t));try{localStorage.setItem("lastSelectedChat",t)}catch(t){}},async restart(){try{if(!1===getConnectionStatus())return void await notificationStore.frontendError("Backend disconnected, cannot restart.","Restart Error");await sendJsonData("/restart",{})}catch(t){await notificationStore.frontendInfo("Restarting...","System Restart",9999,"restart");let e=0;const s=RETRY.MAX_RETRIES;for(;e<s;)try{await sendJsonData("/health",{});return await new Promise(t=>setTimeout(t,RETRY.INTERVAL_MS)),void await notificationStore.frontendSuccess("Restarted","System Restart",5,"restart")}catch(t){e++,await new Promise(t=>setTimeout(t,RETRY.INTERVAL_MS))}await notificationStore.frontendError("Restart timed out or failed","Restart Error",8,"restart")}}},store=createStore("chats",model);export{store};