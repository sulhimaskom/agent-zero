import{createStore}from"/js/AlpineStore.js";import*as API from"/js/api.js";import{openModal}from"/js/modals.js";import{LIMITS,DEFAULTS}from"/js/constants.js";export const NotificationType={INFO:"info",SUCCESS:"success",WARNING:"warning",ERROR:"error",PROGRESS:"progress"};export const NotificationPriority={NORMAL:10,HIGH:20};export const defaultPriority=NotificationPriority.NORMAL;const maxNotifications=LIMITS.MAX_NOTIFICATIONS,maxToasts=DEFAULTS.MAX_TOASTS,model={notifications:[],loading:!1,lastNotificationVersion:0,lastNotificationGuid:"",unreadCount:0,unreadPrioCount:0,toastStack:[],init(){this.initialize()},initialize(){this.loading=!0,this.updateUnreadCount(),this.toastStack=[]},updateFromPoll(t){t&&(t.notifications_guid!==this.lastNotificationGuid&&(this.lastNotificationVersion=0,this.notifications=[],this.toastStack=[],this.lastNotificationGuid=t.notifications_guid||""),t.notifications&&t.notifications.length>0&&t.notifications.forEach(t=>{const i=!t.read;this.adjustNotificationData(t);const o=!this.notifications.find(i=>i.id===t.id);this.addOrUpdateNotification(t),o&&i&&this.addToToastStack(t)}),this.lastNotificationVersion=t.notifications_version||0,this.lastNotificationGuid=t.notifications_guid||"",this.updateUnreadCount())},adjustNotificationData(t){t.priority||(t.priority=defaultPriority)},addToToastStack(t){if(t.group&&""!==t.group.trim()){const i=this.toastStack.find(i=>i.group===t.group);i&&i.toastId&&this.removeFromToastStack(i.toastId)}const i={...t,toastId:`toast-${t.id}`,addedAt:Date.now(),autoRemoveTimer:null,isPaused:!1,remainingTime:1e3*t.display_time,pauseStartTime:null};for(this.toastStack.push(i);this.toastStack.length>maxToasts;){const t=this.toastStack[0];t&&t.toastId&&this.removeFromToastStack(t.toastId)}i.autoRemoveTimer=setTimeout(()=>{this.removeFromToastStack(i.toastId)},i.remainingTime)},removeFromToastStack(t,i=!1){const o=this.toastStack.findIndex(i=>i.toastId===t);if(o>=0){const t=this.toastStack[o];t.autoRemoveTimer&&clearTimeout(t.autoRemoveTimer),this.toastStack.splice(o,1),this.afterToastRemoved(t,i)}},dismissToast(t){this.removeFromToastStack(t,!0)},pauseToastTimer(t){const i=this.toastStack.find(i=>i.toastId===t);i&&!i.isPaused&&(i.isPaused=!0,i.pauseStartTime=Date.now(),i.autoRemoveTimer&&(clearTimeout(i.autoRemoveTimer),i.autoRemoveTimer=null))},resumeToastTimer(t){const i=this.toastStack.find(i=>i.toastId===t);if(!i||!i.isPaused)return;i.isPaused=!1;const o=Date.now()-i.pauseStartTime;i.remainingTime=Math.max(0,i.remainingTime-o),i.pauseStartTime=null,i.remainingTime>0?i.autoRemoveTimer=setTimeout(()=>{this.removeFromToastStack(t)},i.remainingTime):this.removeFromToastStack(t)},async afterToastRemoved(t,i=!1){(i||t.priority<=NotificationPriority.NORMAL)&&this.markAsRead(t.id)},clearToastStack(t=!0,i=!1){this.toastStack.forEach(o=>{o.autoRemoveTimer&&(clearTimeout(o.autoRemoveTimer),t&&this.afterToastRemoved(o,i))}),this.toastStack=[]},cleanupExpiredToasts(){const t=Date.now();this.toastStack=this.toastStack.filter(i=>!(t-i.addedAt>1e3*i.display_time)||(i.autoRemoveTimer&&clearTimeout(i.autoRemoveTimer),!1))},async handleToastClick(t){await this.openModal()},addOrUpdateNotification(t){const i=this.notifications.findIndex(i=>i.id===t.id);i>=0?this.notifications[i]=t:this.notifications.unshift(t),this.notifications.length>maxNotifications&&(this.notifications=this.notifications.slice(0,maxNotifications))},updateUnreadCount(){const t=this.notifications.filter(t=>!t.read).length,i=this.notifications.filter(t=>!t.read&&t.priority>NotificationPriority.NORMAL).length;this.unreadCount!==t&&(this.unreadCount=t),this.unreadPrioCount!==i&&(this.unreadPrioCount=i)},async markAsRead(t){const i=this.notifications.find(i=>i.id===t);if(i&&!i.read){i.read=!0,this.updateUnreadCount();try{await API.callJsonApi("notifications_mark_read",{notification_ids:[t]})}catch(t){console.error("Failed to sync notification read status:",t)}}},async markAllAsRead(){if(0!==this.notifications.filter(t=>!t.read).length){this.notifications.forEach(t=>{t.read=!0}),this.updateUnreadCount(),this.clearToastStack(!1);try{await API.callJsonApi("notifications_mark_read",{mark_all:!0})}catch(t){console.error("Failed to sync mark all as read:",t)}}},async clearAll(t=!0){this.notifications=[],this.unreadCount=0,this.clearToastStack(!1),this.clearBackendNotifications()},async clearBackendNotifications(){try{await API.callJsonApi("notifications_clear",null)}catch(t){console.error("Failed to clear notifications:",t)}},getNotificationsByType(t){return this.notifications.filter(i=>i.type===t)},getDisplayNotifications(){const t=new Date(Date.now()-3e5);return this.notifications.filter(i=>{if(!i.read)return!0;return new Date(i.timestamp)>t})},getRecentNotifications(){return this.notifications.slice(0,5)},getNotificationById(t){return this.notifications.find(i=>i.id===t)},removeOldNotifications(){const t=new Date(Date.now()-36e5),i=this.notifications.length;this.notifications=this.notifications.filter(i=>new Date(i.timestamp)>t),this.notifications.length!==i&&this.updateUnreadCount()},formatTimestamp(t){const i=new Date(t),o=new Date-i,a=o/6e4,n=o/36e5,e=o/864e5;return a<.15?"Just now":a<1?"Less than a minute ago":a<60?`${Math.round(a)}m ago`:n<24?`${Math.round(n)}h ago`:e<7?`${Math.round(e)}d ago`:i.toLocaleDateString()},getNotificationClass:t=>({info:"notification-info",success:"notification-success",warning:"notification-warning",error:"notification-error",progress:"notification-progress"}[t]||"notification-info"),getNotificationItemClass(t){return`notification-item ${this.getNotificationClass(t.type)} ${t.read?"read":"unread"}`},getNotificationIcon:t=>`<span class="material-symbols-outlined">${{info:"info",success:"check_circle",warning:"warning",error:"error",progress:"hourglass_empty"}[t]||"info"}</span>`,async createNotification(t,i,o="",a="",n=3,e="",s=defaultPriority){try{const r=await globalThis.sendJsonData("/notification_create",{type:t,message:i,title:o,detail:a,display_time:n,group:e,priority:s});return r.success?r.notification_id:(console.error("Failed to create notification:",r.error),null)}catch(t){return console.error("Error creating notification:",t),null}},async info(t,i="",o="",a=3,n="",e=defaultPriority){return await this.createNotification(NotificationType.INFO,t,i,o,a,n,e)},async success(t,i="",o="",a=3,n="",e=defaultPriority){return await this.createNotification(NotificationType.SUCCESS,t,i,o,a,n,e)},async warning(t,i="",o="",a=3,n="",e=defaultPriority){return await this.createNotification(NotificationType.WARNING,t,i,o,a,n,e)},async error(t,i="",o="",a=3,n="",e=defaultPriority){return await this.createNotification(NotificationType.ERROR,t,i,o,a,n,e)},async progress(t,i="",o="",a=3,n="",e=defaultPriority){return await this.createNotification(NotificationType.PROGRESS,t,i,o,a,n,e)},async openModal(){this.clearToastStack(!1),await openModal("notifications/notification-modal.html"),this.markAllAsRead()},toggleNotifications(){this.openModal()},isConnected:()=>!1!==("function"==typeof globalThis.getConnectionStatus?globalThis.getConnectionStatus():void 0),addFrontendToastOnly(t,i,o="",a=5,n="",e=defaultPriority){const s=(new Date).toISOString(),r={id:`frontend-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:t,title:o,message:i,detail:"",timestamp:s,display_time:a,read:!1,frontend:!0,group:n,priority:e};if(this.adjustNotificationData(r),n&&""!==String(n).trim()){const t=this.toastStack.findIndex(t=>t.group===n);if(t>=0){const i=this.toastStack[t];i.autoRemoveTimer&&clearTimeout(i.autoRemoveTimer),this.toastStack.splice(t,1)}}const c={...r,toastId:`toast-${r.id}`,addedAt:Date.now(),autoRemoveTimer:null,isPaused:!1,remainingTime:1e3*r.display_time,pauseStartTime:null};if(this.toastStack.push(c),this.toastStack.length>this.maxToastStack){const t=this.toastStack.shift();t.autoRemoveTimer&&clearTimeout(t.autoRemoveTimer)}return c.autoRemoveTimer=setTimeout(()=>{this.removeFromToastStack(c.toastId)},c.remainingTime),r.id},async addFrontendToast(t,i,o="",a=5,n="",e=defaultPriority,s=!1){if(!s)if(this.isConnected())try{const s=await this.createNotification(t,i,o,"",a,n,e);if(s)return s}catch(t){console.log(`Backend unavailable for notification, showing as frontend-only: ${t.message||t}`)}else console.log("Backend disconnected, showing as frontend-only toast");return this.addFrontendToastOnly(t,i,o,a,n,e)},async frontendError(t,i="Connection Error",o=8,a="",n=defaultPriority,e=!1){return await this.addFrontendToast(NotificationType.ERROR,t,i,o,a,n,e)},async frontendWarning(t,i="Warning",o=5,a="",n=defaultPriority){return await this.addFrontendToast(NotificationType.WARNING,t,i,o,a,n,frontendOnly)},async frontendInfo(t,i="Info",o=3,a="",n=defaultPriority,e=!1){return await this.addFrontendToast(NotificationType.INFO,t,i,o,a,n,e)},async frontendSuccess(t,i="Success",o=3,a="",n=defaultPriority,e=!1){return await this.addFrontendToast(NotificationType.SUCCESS,t,i,o,a,n,e)},async frontendProgress(t,i="Progress",o=3,a="",n=defaultPriority,e=!1){return await this.addFrontendToast(NotificationType.PROGRESS,t,i,o,a,n,e)},async frontendNotification({type:t,message:i,title:o="",displayTime:a=5,group:n="",priority:e=defaultPriority,frontendOnly:s=!1}){return await this.addFrontendToast(t,i,o,a,n,e,s)}},store=createStore("notificationStore",model);export{store};const toastFrontendInfo=store.frontendInfo.bind(store),toastFrontendSuccess=store.frontendSuccess.bind(store),toastFrontendWarning=store.frontendWarning.bind(store),toastFrontendError=store.frontendError.bind(store),toastFrontendProgress=store.frontendProgress.bind(store);export{toastFrontendInfo,toastFrontendSuccess,toastFrontendWarning,toastFrontendError,toastFrontendProgress};globalThis.toastFrontendInfo=toastFrontendInfo,globalThis.toastFrontendSuccess=toastFrontendSuccess,globalThis.toastFrontendWarning=toastFrontendWarning,globalThis.toastFrontendError=toastFrontendError,globalThis.toastFrontendProgress=toastFrontendProgress;