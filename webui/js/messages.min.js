import{store as imageViewerStore}from"../components/modals/image-viewer/image-viewer-store.js";import{marked}from"../vendor/marked/marked.esm.js";import{store as _messageResizeStore}from"/components/messages/resize/message-resize-store.js";import{store as attachmentsStore}from"/components/chat/attachments/attachmentsStore.js";import{addActionButtonsToElement}from"/components/messages/action-buttons/simple-action-buttons.js";import{LIMITS,TIMING}from"./constants.js";let messageGroup=null;function getChatHistory(){return document.getElementById("chat-history")}export function setMessage(e,t,s,n,a,r=null){let o=document.getElementById(`message-${e}`),l=!1;if(o);else{l=!0;const s="user"===t?"user":"ai";o=document.createElement("div"),o.id=`message-${e}`,o.classList.add("message-container",`${s}-container`)}if(getHandler(t)(o,e,t,s,n,a,r),!document.getElementById(`message-${e}`)){const s={agent:!0},n={user:"right",info:"mid",warning:"mid",error:"mid",rate_limit:"mid",util:"mid",hint:"mid"}[t]||"left";messageGroup&&!document.getElementById(messageGroup.id)&&(messageGroup=null),messageGroup&&!s[t]&&n==messageGroup.getAttribute("data-group-type")||(messageGroup=document.createElement("div"),messageGroup.id=`message-group-${e}`,messageGroup.classList.add("message-group",`message-group-${n}`),messageGroup.setAttribute("data-group-type",n)),messageGroup.appendChild(o);const a=getChatHistory();a&&a.appendChild(messageGroup)}return o}export function getHandler(e){switch(e){case"user":return drawMessageUser;case"agent":return drawMessageAgent;case"response":return drawMessageResponse;case"tool":return drawMessageTool;case"code_exe":return drawMessageCodeExe;case"browser":return drawMessageBrowser;case"warning":case"rate_limit":return drawMessageWarning;case"error":return drawMessageError;case"info":case"hint":return drawMessageInfo;case"util":return drawMessageUtil;default:return drawMessageDefault}}export function _drawMessage(e,t,s,n,a,r="",o=null,l=[],i=[],c=!1,m=!1,d=!0){let g=e.querySelector(".message");if(g||(g=document.createElement("div"),g.classList.add("message"),e.appendChild(g)),g.className=`message ${r} ${l.join(" ")}`,t){let e=g.querySelector(".msg-heading");e||(e=document.createElement("div"),e.classList.add("msg-heading"),g.insertBefore(e,g.firstChild));let s=e.querySelector("h4");if(s||(s=document.createElement("h4"),e.appendChild(s)),s.innerHTML=convertIcons(escapeHTML(t)),d){let t=e.querySelector(".msg-min-max-btns");t||(t=document.createElement("div"),t.classList.add("msg-min-max-btns"),t.innerHTML=`\n          <a href="#" class="msg-min-max-btn" @click.prevent="$store.messageResize.minimizeMessageClass('${r}', $event)"><span class="material-symbols-outlined" x-text="$store.messageResize.getSetting('${r}').minimized ? 'expand_content' : 'minimize'"></span></a>\n          <a href="#" class="msg-min-max-btn" x-show="!$store.messageResize.getSetting('${r}').minimized" @click.prevent="$store.messageResize.maximizeMessageClass('${r}', $event)"><span class="material-symbols-outlined" x-text="$store.messageResize.getSetting('${r}').maximized ? 'expand' : 'expand_all'"></span></a>\n        `,e.appendChild(t))}}else{const e=g.querySelector(".msg-heading");e&&e.remove()}let p=g.querySelector(".message-body");p||(p=document.createElement("div"),p.classList.add("message-body"),g.appendChild(p));const u=new Scroller(p);if(drawKvpsIncremental(p,o,!1),s&&s.trim().length>0)if(m){let e=p.querySelector(".msg-content");e||(e=document.createElement("div"),p.appendChild(e)),e.className=`msg-content ${i.join(" ")}`;let t=e.querySelector("span");t||(t=document.createElement("span"),e.appendChild(t));let n=s;n=convertImageTags(n),n=convertImgFilePaths(n),n=marked.parse(n,{breaks:!0}),n=convertPathsToLinks(n),n=addBlankTargetsToLinks(n),t.innerHTML=n,c&&t.querySelectorAll("latex").forEach(e=>{katex.render(e.innerHTML,e,{throwOnError:!1})}),addActionButtonsToElement(p),adjustMarkdownRender(e)}else{let e=p.querySelector(".msg-content");e?e.className=`msg-content ${i.join(" ")}`:(e=document.createElement("pre"),e.classList.add("msg-content",...i),e.style.whiteSpace="pre-wrap",e.style.wordBreak="break-word",p.appendChild(e));let t=e.querySelector("span");t||(t=document.createElement("span"),e.appendChild(t)),t.innerHTML=convertHTML(s),addActionButtonsToElement(p)}else{const e=p.querySelector(".msg-content");e&&e.remove()}return u.reApplyScroll(),a&&e.classList.add("message-followup"),g}export function addBlankTargetsToLinks(e){const t=(new DOMParser).parseFromString(e,"text/html");return t.querySelectorAll("a").forEach(e=>{const t=e.getAttribute("href")||"";if(t.startsWith("#")||t.trim().toLowerCase().startsWith("javascript"))return;e.hasAttribute("target")&&""!==e.getAttribute("target")||e.setAttribute("target","_blank");const s=(e.getAttribute("rel")||"").split(/\s+/).filter(Boolean);s.includes("noopener")||s.push("noopener"),s.includes("noreferrer")||s.push("noreferrer"),e.setAttribute("rel",s.join(" "))}),t.body.innerHTML}export function drawMessageDefault(e,t,s,n,a,r,o=null){_drawMessage(e,n,a,r,!1,"message-default",o,["message-ai"],["msg-json"],!1,!1)}export function drawMessageAgent(e,t,s,n,a,r,o=null){let l=null;o&&(l={...o,...o.tool_args||{}},delete l.tool_args),_drawMessage(e,n,a,r,!1,"message-agent",l,["message-ai"],["msg-json"],!1,!1)}export function drawMessageResponse(e,t,s,n,a,r,o=null){_drawMessage(e,n,a,r,!0,"message-agent-response",null,["message-ai"],[],!0,!0)}export function drawMessageDelegation(e,t,s,n,a,r,o=null){_drawMessage(e,n,a,r,!0,"message-agent-delegation",o,["message-ai","message-agent"],[],!0,!1)}export function drawMessageUser(e,t,s,n,a,r,o=null,l=!1){let i=e.querySelector(".message");i?i.className="message message-user":(i=document.createElement("div"),i.classList.add("message","message-user"),e.appendChild(i));let c=i.querySelector(".msg-heading");c||(c=document.createElement("h4"),c.classList.add("msg-heading"),i.insertBefore(c,i.firstChild)),c.innerHTML=`${n} <span class='icon material-symbols-outlined'>person</span>`;let m=i.querySelector(".message-text");if(a&&a.trim().length>0){m||(m=document.createElement("div"),m.classList.add("message-text"),i.appendChild(m));let e=m.querySelector("pre");e||(e=document.createElement("pre"),m.appendChild(e)),e.innerHTML=escapeHTML(a),addActionButtonsToElement(m)}else m&&m.remove();let d=i.querySelector(".attachments-container");o&&o.attachments&&o.attachments.length>0?(d||(d=document.createElement("div"),d.classList.add("attachments-container"),i.appendChild(d)),d.innerHTML="",o.attachments.forEach(e=>{const t=document.createElement("div");t.classList.add("attachment-item");const s=attachmentsStore.getAttachmentDisplayInfo(e);if(s.isImage){t.classList.add("image-type");const e=document.createElement("img");e.src=s.previewUrl,e.alt=s.filename,e.classList.add("attachment-preview"),e.style.cursor="pointer",t.appendChild(e)}else{if(t.classList.add("file-type"),s.previewUrl&&s.previewUrl!==s.filename){const e=document.createElement("img");e.src=s.previewUrl,e.alt=`${s.extension} file`,e.classList.add("file-icon"),t.appendChild(e)}const e=document.createElement("div");e.classList.add("file-title"),e.textContent=s.filename,t.appendChild(e)}t.addEventListener("click",s.clickHandler),d.appendChild(t)})):d&&d.remove()}export function drawMessageTool(e,t,s,n,a,r,o=null){_drawMessage(e,n,a,r,!0,"message-tool",o,["message-ai"],["msg-output"],!1,!1)}export function drawMessageCodeExe(e,t,s,n,a,r,o=null){_drawMessage(e,n,a,r,!0,"message-code-exe",null,["message-ai"],[],!1,!1)}export function drawMessageBrowser(e,t,s,n,a,r,o=null){_drawMessage(e,n,a,r,!0,"message-browser",o,["message-ai"],["msg-json"],!1,!1)}export function drawMessageAgentPlain(e,t,s,n,a,r,o,l=null){_drawMessage(t,a,r,o,!1,e,l,[],[],!1,!1),t.classList.add("center-container")}export function drawMessageInfo(e,t,s,n,a,r,o=null){return drawMessageAgentPlain("message-info",e,t,s,n,a,r,o)}export function drawMessageUtil(e,t,s,n,a,r,o=null){_drawMessage(e,n,a,r,!1,"message-util",o,[],["msg-json"],!1,!1),e.classList.add("center-container")}export function drawMessageWarning(e,t,s,n,a,r,o=null){return drawMessageAgentPlain("message-warning",e,t,s,n,a,r,o)}export function drawMessageError(e,t,s,n,a,r,o=null){return drawMessageAgentPlain("message-error",e,t,s,n,a,r,o)}function drawKvps(e,t,s){if(t){const a=document.createElement("table");a.classList.add("msg-kvps");for(let[r,o]of Object.entries(t)){const l=a.insertRow();l.classList.add("kvps-row"),"thoughts"!==r&&"reasoning"!==r||l.classList.add("msg-thoughts");const i=l.insertCell();i.textContent=convertToTitleCase(r),i.classList.add("kvps-key");const c=l.insertCell(),m=document.createElement("div");if(m.classList.add("kvps-val"),c.appendChild(m),Array.isArray(o))for(const d of o)n(d);else n(o);function n(e){if("object"==typeof e&&(e=JSON.stringify(e,null,2)),"string"==typeof e&&e.startsWith("img://")){const t=document.createElement("img");t.classList.add("kvps-img"),t.src=e.replace("img://","/image_get?path="),t.alt="Image Attachment",m.appendChild(t),t.style.cursor="pointer",t.addEventListener("click",()=>{openImageModal(t.src,LIMITS.IMAGE_MODAL_SIZE)})}else{const t=document.createElement("pre"),n=document.createElement("span");n.innerHTML=convertHTML(e),t.appendChild(n),m.appendChild(t),s&&n.querySelectorAll("latex").forEach(e=>{katex.render(e.innerHTML,e,{throwOnError:!1})})}}addActionButtonsToElement(m),setTimeout(()=>{m.scrollTop=m.scrollHeight},0)}e.appendChild(a)}}function drawKvpsIncremental(e,t,s){if(t){let a=e.querySelector(".msg-kvps");a||(a=document.createElement("table"),a.classList.add("msg-kvps"),e.appendChild(a));let r=a.querySelectorAll(".kvps-row");const o=Object.entries(t);for(o.forEach(([e,t],s)=>{let o=r[s];o||(o=a.insertRow(),o.classList.add("kvps-row")),o.className="kvps-row","thoughts"!==e&&"reasoning"!==e||o.classList.add("msg-thoughts");let l=o.querySelector(".kvps-key");l||(l=o.insertCell(0),l.classList.add("kvps-key")),l.textContent=convertToTitleCase(e);let i=o.cells[1];i||(i=o.insertCell(1));let c=i.querySelector(".kvps-val");c||(c=document.createElement("div"),c.classList.add("kvps-val"),i.appendChild(c));const m=new Scroller(c);if(c.innerHTML="",addActionButtonsToElement(c),Array.isArray(t))for(const e of t)n(e,c);else n(t,c);m.reApplyScroll()});r.length>o.length;){r[r.length-1].remove(),r=a.querySelectorAll(".kvps-row")}function n(e,t){if("object"==typeof e&&(e=JSON.stringify(e,null,2)),"string"==typeof e&&e.startsWith("img://")){const s=document.createElement("img");s.classList.add("kvps-img"),s.src=e.replace("img://","/image_get?path="),s.alt="Image Attachment",t.appendChild(s),s.style.cursor="pointer",s.addEventListener("click",()=>{imageViewerStore.open(s.src,{refreshInterval:TIMING.IMAGE_REFRESH_INTERVAL})})}else{const n=document.createElement("pre"),a=document.createElement("span");a.innerHTML=convertHTML(e),n.appendChild(a),t.appendChild(n),s&&a.querySelectorAll("latex").forEach(e=>{katex.render(e.innerHTML,e,{throwOnError:!1})})}}}else{const l=e.querySelector(".msg-kvps");l&&l.remove()}}function convertToTitleCase(e){return e.replace(/_/g," ").toLowerCase().replace(/\b\w/g,function(e){return e.toUpperCase()})}function convertImageTags(e){return e.replace(/<image>(.*?)<\/image>/g,(e,t)=>`<img src="data:image/jpeg;base64,${t}" alt="Image Attachment" style="max-width: 250px !important;"/>`)}function convertHTML(e){"string"!=typeof e&&(e=JSON.stringify(e,null,2));let t=escapeHTML(e);return t=convertImageTags(t),t=convertPathsToLinks(t),t}function convertImgFilePaths(e){return e.replace(/img:\/\//g,"/image_get?path=")}export function convertIcons(e){return e.replace(/icon:\/\/([a-zA-Z0-9_]+)/g,'<span class="icon material-symbols-outlined">$1</span>')}function escapeHTML(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"};return e.replace(/[&<>'"]/g,e=>t[e])}function convertPathsToLinks(e){function t(e){const t=e.split("/");t[0]||t.shift();let s="",n="";for(const e of t)s+="/"+e,n+=`/<a href="#" class="path-link" onclick="openFileLink('${s}');">${e}</a>`;return n}const s=new RegExp("(?<=(?:^|[> `'\"\\n]|&#39;|&quot;))\\/[a-zA-Z0-9_\\/.\\-]*[a-zA-Z0-9_\\-\\/](?<!\\.)","g");return e.split(/(<(?:[^<>"']+|"[^"]*"|'[^']*')*>)/g).map(e=>e.startsWith("<")?e:e.replace(s,t)).join("")}function adjustMarkdownRender(e){e.querySelectorAll("table").forEach(e=>{const t=document.createElement("div");t.className="message-markdown-table-wrap",e.parentNode.insertBefore(t,e),t.appendChild(e)})}class Scroller{constructor(e){this.element=e,this.wasAtBottom=this.isAtBottom()}isAtBottom(e=10){const t=this.element.scrollHeight,s=this.element.clientHeight;return t-this.element.scrollTop-s<=e}reApplyScroll(){this.wasAtBottom&&(this.element.scrollTop=this.element.scrollHeight)}}