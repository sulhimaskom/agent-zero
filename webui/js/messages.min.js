import{store as imageViewerStore}from"../components/modals/image-viewer/image-viewer-store.min.js";import{marked}from"../vendor/marked/marked.esm.js";import{store as _messageResizeStore}from"/components/messages/resize/message-resize-store.min.js";import{store as attachmentsStore}from"/components/chat/attachments/attachmentsStore.min.js";import{addActionButtonsToElement}from"/components/messages/action-buttons/simple-action-buttons.min.js";import{sanitizeHTML}from"./utils/sanitize.js";import{LIMITS,TIMING}from"./constants.js";let messageGroup=null;function getChatHistory(){return document.getElementById("chat-history")}export function setMessage(id,type,heading,content,temp,kvps=null){let messageContainer=document.getElementById(`message-${id}`);let isNewMessage=false;if(messageContainer){}else{isNewMessage=true;const sender=type==="user"?"user":"ai";messageContainer=document.createElement("div");messageContainer.id=`message-${id}`;messageContainer.classList.add("message-container",`${sender}-container`)}const handler=getHandler(type);handler(messageContainer,id,type,heading,content,temp,kvps);if(!document.getElementById(`message-${id}`)){const groupTypeMap={user:"right",info:"mid",warning:"mid",error:"mid",rate_limit:"mid",util:"mid",hint:"mid"};const groupStart={agent:true};const groupType=groupTypeMap[type]||"left";if(messageGroup&&!document.getElementById(messageGroup.id))messageGroup=null;if(!messageGroup||groupStart[type]||groupType!=messageGroup.getAttribute("data-group-type")){messageGroup=document.createElement("div");messageGroup.id=`message-group-${id}`;messageGroup.classList.add("message-group",`message-group-${groupType}`);messageGroup.setAttribute("data-group-type",groupType)}messageGroup.appendChild(messageContainer);const chatHistory=getChatHistory();if(chatHistory){chatHistory.appendChild(messageGroup)}}return messageContainer}export function getHandler(type){switch(type){case"user":return drawMessageUser;case"agent":return drawMessageAgent;case"response":return drawMessageResponse;case"tool":return drawMessageTool;case"code_exe":return drawMessageCodeExe;case"browser":return drawMessageBrowser;case"warning":return drawMessageWarning;case"rate_limit":return drawMessageWarning;case"error":return drawMessageError;case"info":return drawMessageInfo;case"util":return drawMessageUtil;case"hint":return drawMessageInfo;default:return drawMessageDefault}}export function _drawMessage(messageContainer,heading,content,temp,followUp,mainClass="",kvps=null,messageClasses=[],contentClasses=[],latex=false,markdown=false,resizeBtns=true){let messageDiv=messageContainer.querySelector(".message");if(!messageDiv){messageDiv=document.createElement("div");messageDiv.classList.add("message");messageContainer.appendChild(messageDiv)}messageDiv.className=`message ${mainClass} ${messageClasses.join(" ")}`;if(heading){let headingElement=messageDiv.querySelector(".msg-heading");if(!headingElement){headingElement=document.createElement("div");headingElement.classList.add("msg-heading");messageDiv.insertBefore(headingElement,messageDiv.firstChild)}let headingH4=headingElement.querySelector("h4");if(!headingH4){headingH4=document.createElement("h4");headingElement.appendChild(headingH4)}headingH4.innerHTML=convertIcons(escapeHTML(heading));if(resizeBtns){let minMaxBtn=headingElement.querySelector(".msg-min-max-btns");if(!minMaxBtn){minMaxBtn=document.createElement("div");minMaxBtn.classList.add("msg-min-max-btns");minMaxBtn.innerHTML=`\n          <a href="#" class="msg-min-max-btn" @click.prevent="$store.messageResize.minimizeMessageClass('${mainClass}', $event)"><span class="material-symbols-outlined" x-text="$store.messageResize.getSetting('${mainClass}').minimized ? 'expand_content' : 'minimize'"></span></a>\n          <a href="#" class="msg-min-max-btn" x-show="!$store.messageResize.getSetting('${mainClass}').minimized" @click.prevent="$store.messageResize.maximizeMessageClass('${mainClass}', $event)"><span class="material-symbols-outlined" x-text="$store.messageResize.getSetting('${mainClass}').maximized ? 'expand' : 'expand_all'"></span></a>\n        `;headingElement.appendChild(minMaxBtn)}}}else{const existingHeading=messageDiv.querySelector(".msg-heading");if(existingHeading){existingHeading.remove()}}let bodyDiv=messageDiv.querySelector(".message-body");if(!bodyDiv){bodyDiv=document.createElement("div");bodyDiv.classList.add("message-body");messageDiv.appendChild(bodyDiv)}const scroller=new Scroller(bodyDiv);drawKvpsIncremental(bodyDiv,kvps,false);if(content&&content.trim().length>0){if(markdown){let contentDiv=bodyDiv.querySelector(".msg-content");if(!contentDiv){contentDiv=document.createElement("div");bodyDiv.appendChild(contentDiv)}contentDiv.className=`msg-content ${contentClasses.join(" ")}`;let spanElement=contentDiv.querySelector("span");if(!spanElement){spanElement=document.createElement("span");contentDiv.appendChild(spanElement)}let processedContent=content;processedContent=convertImageTags(processedContent);processedContent=convertImgFilePaths(processedContent);processedContent=marked.parse(processedContent,{breaks:true});processedContent=convertPathsToLinks(processedContent);processedContent=addBlankTargetsToLinks(processedContent);spanElement.innerHTML=sanitizeHTML(processedContent);if(latex){spanElement.querySelectorAll("latex").forEach(element=>{katex.render(element.innerHTML,element,{throwOnError:false})})}addActionButtonsToElement(bodyDiv);adjustMarkdownRender(contentDiv)}else{let preElement=bodyDiv.querySelector(".msg-content");if(!preElement){preElement=document.createElement("pre");preElement.classList.add("msg-content",...contentClasses);preElement.style.whiteSpace="pre-wrap";preElement.style.wordBreak="break-word";bodyDiv.appendChild(preElement)}else{preElement.className=`msg-content ${contentClasses.join(" ")}`}let spanElement=preElement.querySelector("span");if(!spanElement){spanElement=document.createElement("span");preElement.appendChild(spanElement)}spanElement.innerHTML=convertHTML(content);addActionButtonsToElement(bodyDiv)}}else{const existingContent=bodyDiv.querySelector(".msg-content");if(existingContent){existingContent.remove()}}scroller.reApplyScroll();if(followUp){messageContainer.classList.add("message-followup")}return messageDiv}export function addBlankTargetsToLinks(str){const doc=(new DOMParser).parseFromString(str,"text/html");doc.querySelectorAll("a").forEach(anchor=>{const href=anchor.getAttribute("href")||"";if(href.startsWith("#")||href.trim().toLowerCase().startsWith("javascript"))return;if(!anchor.hasAttribute("target")||anchor.getAttribute("target")===""){anchor.setAttribute("target","_blank")}const rel=(anchor.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(!rel.includes("noopener"))rel.push("noopener");if(!rel.includes("noreferrer"))rel.push("noreferrer");anchor.setAttribute("rel",rel.join(" "))});return doc.body.innerHTML}export function drawMessageDefault(messageContainer,id,type,heading,content,temp,kvps=null){_drawMessage(messageContainer,heading,content,temp,false,"message-default",kvps,["message-ai"],["msg-json"],false,false)}export function drawMessageAgent(messageContainer,id,type,heading,content,temp,kvps=null){let kvpsFlat=null;if(kvps){kvpsFlat={...kvps,...kvps["tool_args"]||{}};delete kvpsFlat["tool_args"]}_drawMessage(messageContainer,heading,content,temp,false,"message-agent",kvpsFlat,["message-ai"],["msg-json"],false,false)}export function drawMessageResponse(messageContainer,id,type,heading,content,temp,kvps=null){_drawMessage(messageContainer,heading,content,temp,true,"message-agent-response",null,["message-ai"],[],true,true)}export function drawMessageDelegation(messageContainer,id,type,heading,content,temp,kvps=null){_drawMessage(messageContainer,heading,content,temp,true,"message-agent-delegation",kvps,["message-ai","message-agent"],[],true,false)}export function drawMessageUser(messageContainer,id,type,heading,content,temp,kvps=null,latex=false){let messageDiv=messageContainer.querySelector(".message");if(!messageDiv){messageDiv=document.createElement("div");messageDiv.classList.add("message","message-user");messageContainer.appendChild(messageDiv)}else{messageDiv.className="message message-user"}let headingElement=messageDiv.querySelector(".msg-heading");if(!headingElement){headingElement=document.createElement("h4");headingElement.classList.add("msg-heading");messageDiv.insertBefore(headingElement,messageDiv.firstChild)}headingElement.innerHTML=`${escapeHTML(heading)} <span class='icon material-symbols-outlined'>person</span>`;let textDiv=messageDiv.querySelector(".message-text");if(content&&content.trim().length>0){if(!textDiv){textDiv=document.createElement("div");textDiv.classList.add("message-text");messageDiv.appendChild(textDiv)}let spanElement=textDiv.querySelector("pre");if(!spanElement){spanElement=document.createElement("pre");textDiv.appendChild(spanElement)}spanElement.innerHTML=escapeHTML(content);addActionButtonsToElement(textDiv)}else{if(textDiv)textDiv.remove()}let attachmentsContainer=messageDiv.querySelector(".attachments-container");if(kvps&&kvps.attachments&&kvps.attachments.length>0){if(!attachmentsContainer){attachmentsContainer=document.createElement("div");attachmentsContainer.classList.add("attachments-container");messageDiv.appendChild(attachmentsContainer)}attachmentsContainer.innerHTML="";kvps.attachments.forEach(attachment=>{const attachmentDiv=document.createElement("div");attachmentDiv.classList.add("attachment-item");const displayInfo=attachmentsStore.getAttachmentDisplayInfo(attachment);if(displayInfo.isImage){attachmentDiv.classList.add("image-type");const img=document.createElement("img");img.src=displayInfo.previewUrl;img.alt=displayInfo.filename;img.classList.add("attachment-preview");img.style.cursor="pointer";attachmentDiv.appendChild(img)}else{attachmentDiv.classList.add("file-type");if(displayInfo.previewUrl&&displayInfo.previewUrl!==displayInfo.filename){const iconImg=document.createElement("img");iconImg.src=displayInfo.previewUrl;iconImg.alt=`${displayInfo.extension} file`;iconImg.classList.add("file-icon");attachmentDiv.appendChild(iconImg)}const fileTitle=document.createElement("div");fileTitle.classList.add("file-title");fileTitle.textContent=displayInfo.filename;attachmentDiv.appendChild(fileTitle)}attachmentDiv.addEventListener("click",displayInfo.clickHandler);attachmentsContainer.appendChild(attachmentDiv)})}else{if(attachmentsContainer)attachmentsContainer.remove()}}export function drawMessageTool(messageContainer,id,type,heading,content,temp,kvps=null){_drawMessage(messageContainer,heading,content,temp,true,"message-tool",kvps,["message-ai"],["msg-output"],false,false)}export function drawMessageCodeExe(messageContainer,id,type,heading,content,temp,kvps=null){_drawMessage(messageContainer,heading,content,temp,true,"message-code-exe",null,["message-ai"],[],false,false)}export function drawMessageBrowser(messageContainer,id,type,heading,content,temp,kvps=null){_drawMessage(messageContainer,heading,content,temp,true,"message-browser",kvps,["message-ai"],["msg-json"],false,false)}export function drawMessageAgentPlain(mainClass,messageContainer,id,type,heading,content,temp,kvps=null){_drawMessage(messageContainer,heading,content,temp,false,mainClass,kvps,[],[],false,false);messageContainer.classList.add("center-container")}export function drawMessageInfo(messageContainer,id,type,heading,content,temp,kvps=null){return drawMessageAgentPlain("message-info",messageContainer,id,type,heading,content,temp,kvps)}export function drawMessageUtil(messageContainer,id,type,heading,content,temp,kvps=null){_drawMessage(messageContainer,heading,content,temp,false,"message-util",kvps,[],["msg-json"],false,false);messageContainer.classList.add("center-container")}export function drawMessageWarning(messageContainer,id,type,heading,content,temp,kvps=null){return drawMessageAgentPlain("message-warning",messageContainer,id,type,heading,content,temp,kvps)}export function drawMessageError(messageContainer,id,type,heading,content,temp,kvps=null){return drawMessageAgentPlain("message-error",messageContainer,id,type,heading,content,temp,kvps)}function drawKvps(container,kvps,latex){if(kvps){const table=document.createElement("table");table.classList.add("msg-kvps");for(const[key,value]of Object.entries(kvps)){const row=table.insertRow();row.classList.add("kvps-row");if(key==="thoughts"||key==="reasoning")row.classList.add("msg-thoughts");const th=row.insertCell();th.textContent=convertToTitleCase(key);th.classList.add("kvps-key");const td=row.insertCell();const tdiv=document.createElement("div");tdiv.classList.add("kvps-val");td.appendChild(tdiv);if(Array.isArray(value)){for(const item of value){addValue(item)}}else{addValue(value)}addActionButtonsToElement(tdiv);setTimeout(()=>{tdiv.scrollTop=tdiv.scrollHeight},0);function addValue(value){if(typeof value==="object")value=JSON.stringify(value,null,2);if(typeof value==="string"&&value.startsWith("img://")){const imgElement=document.createElement("img");imgElement.classList.add("kvps-img");imgElement.src=value.replace("img://","/image_get?path=");imgElement.alt="Image Attachment";tdiv.appendChild(imgElement);imgElement.style.cursor="pointer";imgElement.addEventListener("click",()=>{openImageModal(imgElement.src,LIMITS.IMAGE_MODAL_SIZE)})}else{const pre=document.createElement("pre");const span=document.createElement("span");span.innerHTML=convertHTML(value);pre.appendChild(span);tdiv.appendChild(pre);if(latex){span.querySelectorAll("latex").forEach(element=>{katex.render(element.innerHTML,element,{throwOnError:false})})}}}}container.appendChild(table)}}function drawKvpsIncremental(container,kvps,latex){if(kvps){let table=container.querySelector(".msg-kvps");if(!table){table=document.createElement("table");table.classList.add("msg-kvps");container.appendChild(table)}let existingRows=table.querySelectorAll(".kvps-row");const kvpEntries=Object.entries(kvps);kvpEntries.forEach(([key,value],index)=>{let row=existingRows[index];if(!row){row=table.insertRow();row.classList.add("kvps-row")}row.className="kvps-row";if(key==="thoughts"||key==="reasoning"){row.classList.add("msg-thoughts")}let th=row.querySelector(".kvps-key");if(!th){th=row.insertCell(0);th.classList.add("kvps-key")}th.textContent=convertToTitleCase(key);let td=row.cells[1];if(!td){td=row.insertCell(1)}let tdiv=td.querySelector(".kvps-val");if(!tdiv){tdiv=document.createElement("div");tdiv.classList.add("kvps-val");td.appendChild(tdiv)}const scroller=new Scroller(tdiv);tdiv.innerHTML="";addActionButtonsToElement(tdiv);if(Array.isArray(value)){for(const item of value){addValue(item,tdiv)}}else{addValue(value,tdiv)}scroller.reApplyScroll()});while(existingRows.length>kvpEntries.length){const lastRow=existingRows[existingRows.length-1];lastRow.remove();existingRows=table.querySelectorAll(".kvps-row")}function addValue(value,tdiv){if(typeof value==="object")value=JSON.stringify(value,null,2);if(typeof value==="string"&&value.startsWith("img://")){const imgElement=document.createElement("img");imgElement.classList.add("kvps-img");imgElement.src=value.replace("img://","/image_get?path=");imgElement.alt="Image Attachment";tdiv.appendChild(imgElement);imgElement.style.cursor="pointer";imgElement.addEventListener("click",()=>{imageViewerStore.open(imgElement.src,{refreshInterval:TIMING.IMAGE_REFRESH_INTERVAL})})}else{const pre=document.createElement("pre");const span=document.createElement("span");span.innerHTML=convertHTML(value);pre.appendChild(span);tdiv.appendChild(pre);if(latex){span.querySelectorAll("latex").forEach(element=>{katex.render(element.innerHTML,element,{throwOnError:false})})}}}}else{const existingTable=container.querySelector(".msg-kvps");if(existingTable){existingTable.remove()}}}function convertToTitleCase(str){return str.replace(/_/g," ").toLowerCase().replace(/\b\w/g,match=>match.toUpperCase())}function convertImageTags(content){const imageTagRegex=/<image>(.*?)<\/image>/g;const updatedContent=content.replace(imageTagRegex,(match,base64Content)=>`<img src="data:image/jpeg;base64,${base64Content}" alt="Image Attachment" style="max-width: 250px !important;"/>`);return updatedContent}function convertHTML(str){if(typeof str!=="string")str=JSON.stringify(str,null,2);let result=escapeHTML(str);result=convertImageTags(result);result=convertPathsToLinks(result);return result}function convertImgFilePaths(str){return str.replace(/img:\/\//g,"/image_get?path=")}export function convertIcons(str){return str.replace(/icon:\/\/([a-zA-Z0-9_]+)/g,'<span class="icon material-symbols-outlined">$1</span>')}function escapeHTML(str){const escapeChars={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"};return str.replace(/[&<>'"]/g,char=>escapeChars[char])}function convertPathsToLinks(str){function generateLinks(match){const parts=match.split("/");if(!parts[0])parts.shift();let conc="";let html="";for(const part of parts){conc+=`/${part}`;html+=`/<a href="#" class="path-link" onclick="openFileLink('${conc.replace(/\\/g,"\\\\").replace(/'/g,"\\'")}');">${part}</a>`}return html}const prefix="(?:^|[> `'\"\\n]|&#39;|&quot;)";const folder="[a-zA-Z0-9_\\/.\\-]";const file="[a-zA-Z0-9_\\-\\/]";const suffix="(?<!\\.)";const pathRegex=new RegExp(`(?<=${prefix})\\/${folder}*${file}${suffix}`,"g");const tagRegex=/(<(?:[^<>"']+|"[^"]*"|'[^']*')*>)/g;return str.split(tagRegex).map(chunk=>{if(chunk.startsWith("<"))return chunk;return chunk.replace(pathRegex,generateLinks)}).join("")}function adjustMarkdownRender(element){const elements=element.querySelectorAll("table");elements.forEach(el=>{const wrapper=document.createElement("div");wrapper.className="message-markdown-table-wrap";el.parentNode.insertBefore(wrapper,el);wrapper.appendChild(el)})}class Scroller{constructor(element){this.element=element;this.wasAtBottom=this.isAtBottom()}isAtBottom(tolerance=10){const scrollHeight=this.element.scrollHeight;const clientHeight=this.element.clientHeight;const distanceFromBottom=scrollHeight-this.element.scrollTop-clientHeight;return distanceFromBottom<=tolerance}reApplyScroll(){if(this.wasAtBottom)this.element.scrollTop=this.element.scrollHeight}}