import{store as e}from"../components/modals/image-viewer/image-viewer-store.js";import{marked as t}from"../vendor/marked/marked.esm.js";import{store as s}from"/components/messages/resize/message-resize-store.js";import{store as a}from"/components/chat/attachments/attachmentsStore.js";import{addActionButtonsToElement as n}from"/components/messages/action-buttons/simple-action-buttons.js";import{LIMITS as r,TIMING as l}from"./constants.js";let o=null;export function setMessage(e,t,s,a,n,r=null){let l=document.getElementById(`message-${e}`),i=!1;if(l);else{i=!0;const s="user"===t?"user":"ai";l=document.createElement("div"),l.id=`message-${e}`,l.classList.add("message-container",`${s}-container`)}if(getHandler(t)(l,e,t,s,a,n,r),!document.getElementById(`message-${e}`)){const s={agent:!0},a={user:"right",info:"mid",warning:"mid",error:"mid",rate_limit:"mid",util:"mid",hint:"mid"}[t]||"left";o&&!document.getElementById(o.id)&&(o=null),o&&!s[t]&&a==o.getAttribute("data-group-type")||(o=document.createElement("div"),o.id=`message-group-${e}`,o.classList.add("message-group",`message-group-${a}`),o.setAttribute("data-group-type",a)),o.appendChild(l);const n=document.getElementById("chat-history");n&&n.appendChild(o)}return l}export function getHandler(e){switch(e){case"user":return drawMessageUser;case"agent":return drawMessageAgent;case"response":return drawMessageResponse;case"tool":return drawMessageTool;case"code_exe":return drawMessageCodeExe;case"browser":return drawMessageBrowser;case"warning":case"rate_limit":return drawMessageWarning;case"error":return drawMessageError;case"info":case"hint":return drawMessageInfo;case"util":return drawMessageUtil;default:return drawMessageDefault}}export function _drawMessage(s,a,r,o,u,h="",f=null,w=[],y=[],M=!1,v=!1,x=!0){let E=s.querySelector(".message");if(E||(E=document.createElement("div"),E.classList.add("message"),s.appendChild(E)),E.className=`message ${h} ${w.join(" ")}`,a){let e=E.querySelector(".msg-heading");e||(e=document.createElement("div"),e.classList.add("msg-heading"),E.insertBefore(e,E.firstChild));let t=e.querySelector("h4");if(t||(t=document.createElement("h4"),e.appendChild(t)),t.innerHTML=convertIcons(d(a)),x){let t=e.querySelector(".msg-min-max-btns");t||(t=document.createElement("div"),t.classList.add("msg-min-max-btns"),t.innerHTML=`\n          <a href="#" class="msg-min-max-btn" @click.prevent="$store.messageResize.minimizeMessageClass('${h}', $event)"><span class="material-symbols-outlined" x-text="$store.messageResize.getSetting('${h}').minimized ? 'expand_content' : 'minimize'"></span></a>\n          <a href="#" class="msg-min-max-btn" x-show="!$store.messageResize.getSetting('${h}').minimized" @click.prevent="$store.messageResize.maximizeMessageClass('${h}', $event)"><span class="material-symbols-outlined" x-text="$store.messageResize.getSetting('${h}').maximized ? 'expand' : 'expand_all'"></span></a>\n        `,e.appendChild(t))}}else{const e=E.querySelector(".msg-heading");e&&e.remove()}let L=E.querySelector(".message-body");L||(L=document.createElement("div"),L.classList.add("message-body"),E.appendChild(L));const S=new p(L);if(function(t,s,a){if(s){let r=t.querySelector(".msg-kvps");r||(r=document.createElement("table"),r.classList.add("msg-kvps"),t.appendChild(r));let o=r.querySelectorAll(".kvps-row");const c=Object.entries(s);for(c.forEach(([e,t],s)=>{let a=o[s];a||(a=r.insertRow(),a.classList.add("kvps-row")),a.className="kvps-row","thoughts"!==e&&"reasoning"!==e||a.classList.add("msg-thoughts");let l=a.querySelector(".kvps-key");l||(l=a.insertCell(0),l.classList.add("kvps-key")),l.textContent=i(e);let c=a.cells[1];c||(c=a.insertCell(1));let m=c.querySelector(".kvps-val");m||(m=document.createElement("div"),m.classList.add("kvps-val"),c.appendChild(m));const g=new p(m);if(m.innerHTML="",n(m),Array.isArray(t))for(const e of t)d(e,m);else d(t,m);g.reApplyScroll()});o.length>c.length;){o[o.length-1].remove(),o=r.querySelectorAll(".kvps-row")}function d(t,s){if("object"==typeof t&&(t=JSON.stringify(t,null,2)),"string"==typeof t&&t.startsWith("img://")){const a=document.createElement("img");a.classList.add("kvps-img"),a.src=t.replace("img://","/image_get?path="),a.alt="Image Attachment",s.appendChild(a),a.style.cursor="pointer",a.addEventListener("click",()=>{e.open(a.src,{refreshInterval:l.IMAGE_REFRESH_INTERVAL})})}else{const e=document.createElement("pre"),n=document.createElement("span");n.innerHTML=m(t),e.appendChild(n),s.appendChild(e),a&&n.querySelectorAll("latex").forEach(e=>{katex.render(e.innerHTML,e,{throwOnError:!1})})}}}else{const g=t.querySelector(".msg-kvps");g&&g.remove()}}(L,f,!1),r&&r.trim().length>0)if(v){let e=L.querySelector(".msg-content");e||(e=document.createElement("div"),L.appendChild(e)),e.className=`msg-content ${y.join(" ")}`;let s=e.querySelector("span");s||(s=document.createElement("span"),e.appendChild(s));let a=r;a=c(a),a=a.replace(/img:\/\//g,"/image_get?path="),a=t.parse(a,{breaks:!0}),a=g(a),a=addBlankTargetsToLinks(a),s.innerHTML=a,M&&s.querySelectorAll("latex").forEach(e=>{katex.render(e.innerHTML,e,{throwOnError:!1})}),n(L),e.querySelectorAll("table").forEach(e=>{const t=document.createElement("div");t.className="message-markdown-table-wrap",e.parentNode.insertBefore(t,e),t.appendChild(e)})}else{let e=L.querySelector(".msg-content");e?e.className=`msg-content ${y.join(" ")}`:(e=document.createElement("pre"),e.classList.add("msg-content",...y),e.style.whiteSpace="pre-wrap",e.style.wordBreak="break-word",L.appendChild(e));let t=e.querySelector("span");t||(t=document.createElement("span"),e.appendChild(t)),t.innerHTML=m(r),n(L)}else{const e=L.querySelector(".msg-content");e&&e.remove()}return S.reApplyScroll(),u&&s.classList.add("message-followup"),E}export function addBlankTargetsToLinks(e){const t=(new DOMParser).parseFromString(e,"text/html");return t.querySelectorAll("a").forEach(e=>{const t=e.getAttribute("href")||"";if(t.startsWith("#")||t.trim().toLowerCase().startsWith("javascript"))return;e.hasAttribute("target")&&""!==e.getAttribute("target")||e.setAttribute("target","_blank");const s=(e.getAttribute("rel")||"").split(/\s+/).filter(Boolean);s.includes("noopener")||s.push("noopener"),s.includes("noreferrer")||s.push("noreferrer"),e.setAttribute("rel",s.join(" "))}),t.body.innerHTML}export function drawMessageDefault(e,t,s,a,n,r,l=null){_drawMessage(e,a,n,r,!1,"message-default",l,["message-ai"],["msg-json"],!1,!1)}export function drawMessageAgent(e,t,s,a,n,r,l=null){let o=null;l&&(o={...l,...l.tool_args||{}},delete o.tool_args),_drawMessage(e,a,n,r,!1,"message-agent",o,["message-ai"],["msg-json"],!1,!1)}export function drawMessageResponse(e,t,s,a,n,r,l=null){_drawMessage(e,a,n,r,!0,"message-agent-response",null,["message-ai"],[],!0,!0)}export function drawMessageDelegation(e,t,s,a,n,r,l=null){_drawMessage(e,a,n,r,!0,"message-agent-delegation",l,["message-ai","message-agent"],[],!0,!1)}export function drawMessageUser(e,t,s,r,l,o,i=null,c=!1){let m=e.querySelector(".message");m?m.className="message message-user":(m=document.createElement("div"),m.classList.add("message","message-user"),e.appendChild(m));let g=m.querySelector(".msg-heading");g||(g=document.createElement("h4"),g.classList.add("msg-heading"),m.insertBefore(g,m.firstChild)),g.innerHTML=`${r} <span class='icon material-symbols-outlined'>person</span>`;let p=m.querySelector(".message-text");if(l&&l.trim().length>0){p||(p=document.createElement("div"),p.classList.add("message-text"),m.appendChild(p));let e=p.querySelector("pre");e||(e=document.createElement("pre"),p.appendChild(e)),e.innerHTML=d(l),n(p)}else p&&p.remove();let u=m.querySelector(".attachments-container");i&&i.attachments&&i.attachments.length>0?(u||(u=document.createElement("div"),u.classList.add("attachments-container"),m.appendChild(u)),u.innerHTML="",i.attachments.forEach(e=>{const t=document.createElement("div");t.classList.add("attachment-item");const s=a.getAttachmentDisplayInfo(e);if(s.isImage){t.classList.add("image-type");const e=document.createElement("img");e.src=s.previewUrl,e.alt=s.filename,e.classList.add("attachment-preview"),e.style.cursor="pointer",t.appendChild(e)}else{if(t.classList.add("file-type"),s.previewUrl&&s.previewUrl!==s.filename){const e=document.createElement("img");e.src=s.previewUrl,e.alt=`${s.extension} file`,e.classList.add("file-icon"),t.appendChild(e)}const e=document.createElement("div");e.classList.add("file-title"),e.textContent=s.filename,t.appendChild(e)}t.addEventListener("click",s.clickHandler),u.appendChild(t)})):u&&u.remove()}export function drawMessageTool(e,t,s,a,n,r,l=null){_drawMessage(e,a,n,r,!0,"message-tool",l,["message-ai"],["msg-output"],!1,!1)}export function drawMessageCodeExe(e,t,s,a,n,r,l=null){_drawMessage(e,a,n,r,!0,"message-code-exe",null,["message-ai"],[],!1,!1)}export function drawMessageBrowser(e,t,s,a,n,r,l=null){_drawMessage(e,a,n,r,!0,"message-browser",l,["message-ai"],["msg-json"],!1,!1)}export function drawMessageAgentPlain(e,t,s,a,n,r,l,o=null){_drawMessage(t,n,r,l,!1,e,o,[],[],!1,!1),t.classList.add("center-container")}export function drawMessageInfo(e,t,s,a,n,r,l=null){return drawMessageAgentPlain("message-info",e,t,s,a,n,r,l)}export function drawMessageUtil(e,t,s,a,n,r,l=null){_drawMessage(e,a,n,r,!1,"message-util",l,[],["msg-json"],!1,!1),e.classList.add("center-container")}export function drawMessageWarning(e,t,s,a,n,r,l=null){return drawMessageAgentPlain("message-warning",e,t,s,a,n,r,l)}export function drawMessageError(e,t,s,a,n,r,l=null){return drawMessageAgentPlain("message-error",e,t,s,a,n,r,l)}function i(e){return e.replace(/_/g," ").toLowerCase().replace(/\b\w/g,function(e){return e.toUpperCase()})}function c(e){return e.replace(/<image>(.*?)<\/image>/g,(e,t)=>`<img src="data:image/jpeg;base64,${t}" alt="Image Attachment" style="max-width: 250px !important;"/>`)}function m(e){"string"!=typeof e&&(e=JSON.stringify(e,null,2));let t=d(e);return t=c(t),t=g(t),t}export function convertIcons(e){return e.replace(/icon:\/\/([a-zA-Z0-9_]+)/g,'<span class="icon material-symbols-outlined">$1</span>')}function d(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"};return e.replace(/[&<>'"]/g,e=>t[e])}function g(e){function t(e){const t=e.split("/");t[0]||t.shift();let s="",a="";for(const e of t)s+="/"+e,a+=`/<a href="#" class="path-link" onclick="openFileLink('${s}');">${e}</a>`;return a}const s=new RegExp("(?<=(?:^|[> `'\"\\n]|&#39;|&quot;))\\/[a-zA-Z0-9_\\/.\\-]*[a-zA-Z0-9_\\-\\/](?<!\\.)","g");return e.split(/(<(?:[^<>"']+|"[^"]*"|'[^']*')*>)/g).map(e=>e.startsWith("<")?e:e.replace(s,t)).join("")}class p{constructor(e){this.element=e,this.wasAtBottom=this.isAtBottom()}isAtBottom(e=10){const t=this.element.scrollHeight,s=this.element.clientHeight;return t-this.element.scrollTop-s<=e}reApplyScroll(){this.wasAtBottom&&(this.element.scrollTop=this.element.scrollHeight)}}