import Logger from"./logger.js";import{API}from"./constants.js";function showErrorToast(e,o="Connection Error"){"function"==typeof globalThis.toastFrontendError&&globalThis.toastFrontendError(e,o,8,"",20,!0)}let isStaticMode=!1,staticModeChecked=!1;function detectStaticMode(){const e=new URL(window.location.href);if("file:"===e.protocol)return!0;return!!(window.ENV_CONFIG?.STATIC_PORTS||["8080","5002","3000","5000","8000","5500","3001","50001","8888"]).includes(e.port)}function isStaticFileMode(){return staticModeChecked||(isStaticMode=detectStaticMode(),staticModeChecked=!0),isStaticMode}export async function callJsonApi(e,o){const r=await fetchApi(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(o)});if(!r.ok){const o=await r.text();throw showErrorToast(`API Error: ${r.status} - ${e}`,"Request Failed"),new Error(o)}return await r.json()}export async function fetchApi(e,o){const r=await async function r(t){const n=await getCsrfToken(),i=o||{};i.headers=i.headers||{},i.headers["X-CSRF-Token"]=n;const a=await fetch(e,i);return 403===a.status&&t?(csrfToken=null,await r(!1)):a.redirected&&a.url.endsWith("/login")?void(window.location.href=a.url):a}(!0);return r}let csrfToken=null,csrfTokenFailed=!1;const csrfTokenErrorLogged=!1;async function getCsrfToken(){if(csrfToken)return csrfToken;if(csrfTokenFailed)throw new Error("CSRF token unavailable - backend not running");if(isStaticFileMode())throw csrfTokenFailed=!0,Logger.once("static_mode_skip",()=>{Logger.debug("Static file mode detected - skipping CSRF token fetch")}),new Error("Static file mode - no backend available");try{const e=await fetch(API.CSRF_TOKEN_ENDPOINT,{credentials:"same-origin"});if(e.redirected&&e.url.endsWith("/login"))return void(window.location.href=e.url);if(!e.ok)throw csrfTokenFailed=!0,Logger.once("csrf_error",()=>{Logger.debug("Backend API not available - CSRF token endpoint returned",e.status)}),new Error(`CSRF token endpoint returned ${e.status}`);let o;try{o=await e.json()}catch(e){throw csrfTokenFailed=!0,Logger.once("csrf_json_error",()=>{Logger.warn("Backend API not available - CSRF endpoint returned non-JSON response")}),new Error("Invalid JSON response from CSRF endpoint")}if(o.ok)return csrfToken=o.token,document.cookie=`csrf_token_${o.runtime_id}=${csrfToken}; SameSite=Strict; Path=/`,csrfToken;throw o.error&&showErrorToast(o.error),new Error(o.error||"Failed to get CSRF token")}catch(e){throw csrfTokenFailed=!0,showErrorToast("Backend connection failed. Please check if the server is running.","Connection Error"),Logger.once("backend_connection_error",()=>{Logger.debug("Backend connection not available - API calls will not work:",e.message)}),e}}