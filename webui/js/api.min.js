import e from"./logger.js";export async function callJsonApi(e,n){const r=await fetchApi(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(n)});if(!r.ok){const e=await r.text();throw new Error(e)}return await r.json()}export async function fetchApi(t,o){const a=await async function a(i){const c=await async function(){if(n)return n;if(r)throw new Error("CSRF token unavailable - backend not running");try{const t=await fetch("/csrf_token",{credentials:"same-origin"});if(t.redirected&&t.url.endsWith("/login"))return void(window.location.href=t.url);if(!t.ok)throw r=!0,e.once("csrf_error",()=>{e.debug("Backend API not available - CSRF token endpoint returned",t.status)}),new Error(`CSRF token endpoint returned ${t.status}`);let o;try{o=await t.json()}catch(n){throw r=!0,e.once("csrf_json_error",()=>{e.warn("Backend API not available - CSRF endpoint returned non-JSON response")}),new Error("Invalid JSON response from CSRF endpoint")}if(o.ok)return n=o.token,document.cookie=`csrf_token_${o.runtime_id}=${n}; SameSite=Strict; Path=/`,n;throw o.error&&alert(o.error),new Error(o.error||"Failed to get CSRF token")}catch(n){throw r=!0,e.once("backend_connection_error",()=>{e.debug("Backend connection not available - API calls will not work:",n.message)}),n}}(),s=o||{};s.headers=s.headers||{},s.headers["X-CSRF-Token"]=c;const d=await fetch(t,s);return 403===d.status&&i?(n=null,await a(!1)):d.redirected&&d.url.endsWith("/login")?void(window.location.href=d.url):d}(!0);return a}let n=null,r=!1;