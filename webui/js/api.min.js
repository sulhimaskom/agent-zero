import Logger from"./logger.js";let isStaticMode=!1,staticModeChecked=!1;function detectStaticMode(){const e=new URL(window.location.href);return"file:"===e.protocol||"8080"===e.port}function isStaticFileMode(){return staticModeChecked||(isStaticMode=detectStaticMode(),staticModeChecked=!0),isStaticMode}export async function callJsonApi(e,o){const t=await fetchApi(e,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(o)});if(!t.ok){const e=await t.text();throw new Error(e)}return await t.json()}export async function fetchApi(e,o){const t=await async function t(r){const n=await getCsrfToken(),i=o||{};i.headers=i.headers||{},i.headers["X-CSRF-Token"]=n;const c=await fetch(e,i);return 403===c.status&&r?(csrfToken=null,await t(!1)):c.redirected&&c.url.endsWith("/login")?void(window.location.href=c.url):c}(!0);return t}let csrfToken=null,csrfTokenFailed=!1,csrfTokenErrorLogged=!1;async function getCsrfToken(){if(csrfToken)return csrfToken;if(csrfTokenFailed)throw new Error("CSRF token unavailable - backend not running");if(isStaticFileMode())throw csrfTokenFailed=!0,Logger.once("static_mode_skip",()=>{Logger.debug("Static file mode detected - skipping CSRF token fetch")}),new Error("Static file mode - no backend available");try{const e=await fetch("/csrf_token",{credentials:"same-origin"});if(e.redirected&&e.url.endsWith("/login"))return void(window.location.href=e.url);if(!e.ok)throw csrfTokenFailed=!0,Logger.once("csrf_error",()=>{Logger.debug("Backend API not available - CSRF token endpoint returned",e.status)}),new Error(`CSRF token endpoint returned ${e.status}`);let o;try{o=await e.json()}catch(e){throw csrfTokenFailed=!0,Logger.once("csrf_json_error",()=>{Logger.warn("Backend API not available - CSRF endpoint returned non-JSON response")}),new Error("Invalid JSON response from CSRF endpoint")}if(o.ok)return csrfToken=o.token,document.cookie=`csrf_token_${o.runtime_id}=${csrfToken}; SameSite=Strict; Path=/`,csrfToken;throw o.error&&alert(o.error),new Error(o.error||"Failed to get CSRF token")}catch(e){throw csrfTokenFailed=!0,Logger.once("backend_connection_error",()=>{Logger.debug("Backend connection not available - API calls will not work:",e.message)}),e}}