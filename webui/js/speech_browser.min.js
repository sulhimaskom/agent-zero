import{pipeline as t,read_audio as e}from"./transformers@3.0.2.js";import{updateChatInput as i,sendMessage as s}from"../index.js";import{TIMING as a,SPEECH as n}from"./constants.js";const r=document.getElementById("microphone-button");let o=null,h=!1;const c="inactive",l="activating",u="listening",d="recording",m="waiting",g="processing";class p{constructor(t,e={}){this.mediaRecorder=null,this.audioChunks=[],this.lastChunk=[],this.updateCallback=t,this.messageSent=!1,this.audioContext=null,this.mediaStreamSource=null,this.analyserNode=null,this._status=c,this.lastAudioTime=null,this.waitingTimer=null,this.silenceStartTime=null,this.hasStartedRecording=!1,this.analysisFrame=null,this.options={modelSize:n.DEFAULT_MODEL_SIZE,language:n.DEFAULT_LANGUAGE,silenceThreshold:n.SILENCE_THRESHOLD,silenceDuration:n.SILENCE_DURATION,waitingTimeout:n.WAITING_TIMEOUT,minSpeechDuration:n.MIN_SPEECH_DURATION,...e}}get status(){return this._status}set status(t){if(this._status===t)return;const e=this._status;this._status=t,r.classList.remove(`mic-${e.toLowerCase()}`),r.classList.add(`mic-${t.toLowerCase()}`),r.setAttribute("data-status",t),this.handleStatusChange(e,t)}handleStatusChange(t,e){switch(e!=d&&(this.lastChunk=null),e){case c:this.handleInactiveState();break;case u:this.handleListeningState();break;case d:this.handleRecordingState();break;case m:this.handleWaitingState();break;case g:this.handleProcessingState()}}handleInactiveState(){this.stopRecording(),this.stopAudioAnalysis(),this.waitingTimer&&(clearTimeout(this.waitingTimer),this.waitingTimer=null)}handleListeningState(){this.stopRecording(),this.audioChunks=[],this.hasStartedRecording=!1,this.silenceStartTime=null,this.lastAudioTime=null,this.messageSent=!1,this.startAudioAnalysis()}handleRecordingState(){this.hasStartedRecording||"recording"===this.mediaRecorder.state||(this.hasStartedRecording=!0,this.mediaRecorder.start(n.RECORDER_CHUNK_SIZE)),this.waitingTimer&&(clearTimeout(this.waitingTimer),this.waitingTimer=null)}handleWaitingState(){this.waitingTimer=setTimeout(()=>{this.status===m&&(this.status=g)},this.options.waitingTimeout)}handleProcessingState(){this.stopRecording(),this.process()}stopRecording(){"recording"===this.mediaRecorder?.state&&(this.mediaRecorder.stop(),this.hasStartedRecording=!1)}async initialize(){try{this.transcriber=await t("automatic-speech-recognition",`Xenova/whisper-${this.options.modelSize}.${this.options.language}`);const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,channelCount:1}});return this.mediaRecorder=new MediaRecorder(e),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&(this.status===d||this.status===m)?(this.lastChunk&&(this.audioChunks.push(this.lastChunk),this.lastChunk=null),this.audioChunks.push(t.data)):this.status===u&&(this.lastChunk=t.data)},this.setupAudioAnalysis(e),!0}catch(t){return console.error("Microphone initialization error:",t),window.toastFrontendError("Failed to access microphone. Please check permissions.","Microphone Error"),!1}}setupAudioAnalysis(t){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.mediaStreamSource=this.audioContext.createMediaStreamSource(t),this.analyserNode=this.audioContext.createAnalyser(),this.analyserNode.fftSize=n.FFT_SIZE,this.analyserNode.minDecibels=n.MIN_DECIBELS,this.analyserNode.maxDecibels=n.MAX_DECIBELS,this.analyserNode.smoothingTimeConstant=n.SMOOTHING_TIME_CONSTANT,this.mediaStreamSource.connect(this.analyserNode)}startAudioAnalysis(){const t=()=>{if(this.status===c)return;const e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);let i=0;for(let t=0;t<e.length;t++){const s=(e[t]-128)/128;i+=s*s}const s=Math.sqrt(i/e.length),a=Date.now();if(s>this.options.silenceThreshold)this.lastAudioTime=a,this.silenceStartTime=null,this.status!==u&&this.status!==m||speech.isSpeaking()||(this.status=d);else if(this.status===d){this.silenceStartTime||(this.silenceStartTime=a);a-this.silenceStartTime>=this.options.silenceDuration&&(this.status=m)}this.analysisFrame=requestAnimationFrame(t)};this.analysisFrame=requestAnimationFrame(t)}stopAudioAnalysis(){this.analysisFrame&&(cancelAnimationFrame(this.analysisFrame),this.analysisFrame=null)}async process(){if(0===this.audioChunks.length)return void(this.status=u);const t=new Blob(this.audioChunks,{type:"audio/wav"}),i=URL.createObjectURL(t);try{const t=16e3,s=await e(i,t),a=await this.transcriber(s);this.filterResult(a.text||"")&&await this.updateCallback(a.text,!0)}catch(t){console.error("Transcription error:",t),window.toastFrontendError("Transcription failed.","Speech Recognition Error")}finally{URL.revokeObjectURL(i),this.audioChunks=[],this.status=u}}filterResult(t){t=t.trim();let e=!1;for(;!e&&t&&("{"!==t[0]||"}"!==t[t.length-1])&&("("!==t[0]||")"!==t[t.length-1])&&("["!==t[0]||"]"!==t[t.length-1]);)e=!0;return e?t:null}}r.addEventListener("click",async()=>{if(h)return;h=!0;if(await async function(){try{return await navigator.mediaDevices.getUserMedia({audio:!0}),!0}catch(t){return console.error("Error accessing microphone:",t),window.toastFrontendError("Microphone access denied. Please enable microphone access in your browser settings.","Microphone Error"),!1}}())try{if(!o&&!await async function(){return o=new p(async(t,e)=>{e&&(i(t),o.messageSent||(o.messageSent=!0,await s()))},{modelSize:n.DEFAULT_MODEL_SIZE,language:n.DEFAULT_LANGUAGE,silenceThreshold:.07,silenceDuration:n.SILENCE_DURATION,waitingTimeout:1500}),o.status=l,await o.initialize()}())return;o.status=o.status===c||o.status===l?u:c}finally{setTimeout(()=>{h=!1},a.UI_DELAY)}});export const speech=new class{constructor(){this.synth=window.speechSynthesis,this.utterance=null}stripEmojis(t){return t.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g,"").replace(/\s+/g," ").trim()}speak(t){this.stop(),t=this.stripEmojis(t),this.utterance=new SpeechSynthesisUtterance(t),this.synth.speak(this.utterance)}stop(){this.isSpeaking()&&this.synth.cancel()}isSpeaking(){return this.synth?.speaking||!1}};window.speech=speech;