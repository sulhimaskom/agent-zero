import{importComponent}from"/js/components.js";import{UI}from"./constants.js";const modalStack=[],backdrop=document.createElement("div");function updateModalZIndexes(){const e=UI.BASE_Z_INDEX;if(modalStack.forEach((t,o)=>{t.element.style.zIndex=e+o*UI.Z_INDEX_STEP}),backdrop.style.display="block",modalStack.length>1){const t=modalStack.length-1,o=e+(t-1)*UI.Z_INDEX_STEP;backdrop.style.zIndex=o+UI.BACKDROP_OFFSET}else 1===modalStack.length?backdrop.style.zIndex=e-1:backdrop.style.display="none"}function createModalElement(e){const t=document.createElement("div");t.className="modal",t.path=e;let o=null;t.addEventListener("mousedown",e=>{o=e.target}),t.addEventListener("mouseup",e=>{e.target===t&&o===t&&closeModal(),o=null});const l=document.createElement("div");l.className="modal-inner";const a=document.createElement("div");a.className="modal-header";const d=document.createElement("h2");d.className="modal-title";const n=document.createElement("button");n.className="modal-close",n.innerHTML="&times;",a.appendChild(d),a.appendChild(n);const s=document.createElement("div");s.className="modal-scroll";const c=document.createElement("div");c.className="modal-bd",s.appendChild(c);const r=document.createElement("div");r.className="modal-footer-slot",r.style.display="none",l.appendChild(a),l.appendChild(s),l.appendChild(r),t.appendChild(l);const m=t.querySelector(".modal-close");return m.addEventListener("click",()=>closeModal()),document.body.appendChild(t),t.classList.add("show"),updateModalZIndexes(),{path:e,element:t,title:t.querySelector(".modal-title"),body:t.querySelector(".modal-bd"),close:m,footerSlot:t.querySelector(".modal-footer-slot"),inner:t.querySelector(".modal-inner"),styles:[],scripts:[]}}backdrop.className="modal-backdrop",backdrop.style.display="none",backdrop.style.backdropFilter="blur(5px)",document.body.appendChild(backdrop);export function openModal(e){return new Promise(t=>{try{const o=createModalElement(e);new MutationObserver((e,l)=>!document.contains(o.element)&&(l.disconnect(),t())).observe(document.body,{childList:!0,subtree:!0}),o.body.textContent="";const l=document.createElement("div");l.className="loading",l.textContent="Loading...",o.body.appendChild(l);importComponent(e,o.body).then(t=>{if(o.title.textContent=t.title||e,t.html&&t.html.classList){const e=o.element.querySelector(".modal-inner");e&&e.classList.add(...t.html.classList)}t.body&&t.body.classList&&o.body.classList.add(...t.body.classList),requestAnimationFrame(()=>{const e=o.body.querySelector("[data-modal-footer]");e&&o.footerSlot&&(o.footerSlot.appendChild(e),o.footerSlot.style.display="block",o.inner.classList.add("modal-with-footer"))})}).catch(e=>{console.error("Error loading modal content:",e),o.body.textContent="";const t=document.createElement("div");t.className="error",t.textContent="Failed to load modal content: "+e.message,o.body.appendChild(t)}),o.path=e,modalStack.push(o),o.element.classList.add("show"),document.body.style.overflow="hidden",updateModalZIndexes()}catch(e){console.error("Error loading modal content:",e),t()}})}export function closeModal(e=null){if(0===modalStack.length)return;let t,o=modalStack.length-1;if(e){if(o=modalStack.findIndex(t=>t.path===e),-1===o)return;t=modalStack[o],modalStack.splice(o,1)}else t=modalStack.pop();t.styles.forEach(e=>{document.querySelector(`[data-modal-style="${e}"]`)?.remove()}),t.scripts.forEach(e=>{document.querySelector(`[data-modal-script="${e}"]`)?.remove()}),t.element.classList.remove("show"),t.element.parentNode&&t.element.parentNode.removeChild(t.element),0===modalStack.length?(backdrop.style.display="none",document.body.style.overflow=""):updateModalZIndexes()}export function scrollModal(e){if(!e)return;const t=modalStack[modalStack.length-1].element;if(!t)return;const o=t.querySelector(".modal-scroll"),l=t.querySelector(`#${e}`);o&&l&&o.scrollTo({top:l.offsetTop-20,behavior:"smooth"})}globalThis.scrollModal=scrollModal,document.addEventListener("click",async e=>{const t=e.target.closest("[data-modal-content]");if(t){if(e.preventDefault(),t.hasAttribute("disabled")||t.classList.contains("disabled"))return;const o=t.getAttribute("href");await openModal(o)}}),document.addEventListener("keydown",e=>{"Escape"===e.key&&modalStack.length>0&&closeModal()}),globalThis.openModal=openModal,globalThis.closeModal=closeModal,globalThis.scrollModal=scrollModal;