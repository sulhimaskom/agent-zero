const e={},t=new Map;export async function importComponent(o,n){const r=n.id||n.getAttribute("data-component-id")||n;if(!t.get(r)){t.set(r,!0);try{if(!n)throw new Error("Target element is required");n.textContent="";const t=document.createElement("div");t.className="loading",n.appendChild(t);const r=o.replace(/^\/+/,""),a=r.startsWith("components/")?r:"components/"+r;let s;if(e[a])s=e[a];else{const t=await fetch(a);if(!t.ok)throw new Error(`Error loading component ${o}: ${t.statusText}`);s=await t.text(),e[a]=s}const l=(new DOMParser).parseFromString(s,"text/html"),i=[...l.querySelectorAll("style"),...l.querySelectorAll("script"),...l.body.childNodes],c=[];let m=0;for(const t of i)if("SCRIPT"===t.nodeName){if("module"===t.type||"module"===t.getAttribute("type"))if(t.src){const o=new URL(t.src,globalThis.location.origin).toString();if(!e[o]){const t=import(o);e[o]=t,c.push(t)}}else{const o=`${a.replaceAll("/","_")}.${++m}.js`;if(!e[o]){let n=t.textContent.replace(/import\s+([^'"]+)\s+from\s+["']([^"']+)["']/g,(e,t,o)=>{if(!/^https?:\/\//.test(o)){return`import ${t} from "${new URL(o,globalThis.location.origin).href}"`}return e});n+=`\n//# sourceURL=${o}`;const r=new Blob([n],{type:"text/javascript"}),a=URL.createObjectURL(r),s=import(a).catch(e=>{throw console.error("Failed to load inline module",e),e}).finally(()=>URL.revokeObjectURL(a));e[o]=s,c.push(s)}}else{const e=document.createElement("script");if(Array.from(t.attributes||[]).forEach(t=>{e.setAttribute(t.name,t.value)}),e.textContent=t.textContent,e.src){const t=new Promise((t,o)=>{e.onload=t,e.onerror=o});c.push(t)}n.appendChild(e)}}else if("STYLE"===t.nodeName||"LINK"===t.nodeName&&"stylesheet"===t.rel){const e=t.cloneNode(!0);if("LINK"===e.tagName&&"stylesheet"===e.rel){const t=new Promise((t,o)=>{e.onload=t,e.onerror=o});c.push(t)}n.appendChild(e)}else{const e=t.cloneNode(!0);n.appendChild(e)}await Promise.all(c);const p=n.querySelector(":scope > .loading");return p&&n.removeChild(p),l}catch(e){throw console.error("Error importing component:",e),e}finally{t.delete(r)}}}export async function loadComponents(e=[document.documentElement]){try{const t=(Array.isArray(e)?e:[e]).flatMap(e=>Array.from(e.querySelectorAll("x-component")));if(0===t.length)return;await Promise.all(t.map(async e=>{const t=e.getAttribute("path");t?await importComponent(t,e):console.error("x-component missing path attribute:",e)}))}catch(e){console.error("Error loading components:",e)}}export function getParentAttributes(e){let t=e,o={};for(;t;){if("x-component"===t.tagName.toLowerCase())for(let e of t.attributes)try{o[e.name]=JSON.parse(e.value)}catch(t){o[e.name]=e.value}t=t.parentElement}return o}globalThis.xAttrs=getParentAttributes,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>loadComponents()):loadComponents();new MutationObserver(e=>{for(const t of e)for(const e of t.addedNodes)1===e.nodeType&&(e.matches?.("x-component")?importComponent(e.getAttribute("path"),e):e.querySelectorAll&&loadComponents([e]))}).observe(document.body,{childList:!0,subtree:!0});