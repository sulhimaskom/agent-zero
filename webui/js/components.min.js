const componentCache={},importLocks=new Map;export async function importComponent(e,t){const o=t.id||t.getAttribute("data-component-id")||t;if(!importLocks.get(o)){importLocks.set(o,!0);try{if(!t)throw new Error("Target element is required");t.textContent="";const o=document.createElement("div");o.className="loading",t.appendChild(o);const n=e.replace(/^\/+/,""),r=n.startsWith("components/")?n:"components/"+n;let a;if(componentCache[r])a=componentCache[r];else{const t=await fetch(r);if(!t.ok)throw new Error(`Error loading component ${e}: ${t.statusText}`);a=await t.text(),componentCache[r]=a}const c=(new DOMParser).parseFromString(a,"text/html"),s=[...c.querySelectorAll("style"),...c.querySelectorAll("script"),...c.body.childNodes],i=[];let l=0;for(const e of s)if("SCRIPT"===e.nodeName){if("module"===e.type||"module"===e.getAttribute("type"))if(e.src){const t=new URL(e.src,globalThis.location.origin).toString();if(!componentCache[t]){const e=import(t);componentCache[t]=e,i.push(e)}}else{const t=`${r.replaceAll("/","_")}.${++l}.js`;if(!componentCache[t]){let o=e.textContent.replace(/import\s+([^'"]+)\s+from\s+["']([^"']+)["']/g,(e,t,o)=>{if(!/^https?:\/\//.test(o)){return`import ${t} from "${new URL(o,globalThis.location.origin).href}"`}return e});o+=`\n//# sourceURL=${t}`;const n=new Blob([o],{type:"text/javascript"}),r=URL.createObjectURL(n),a=import(r).catch(e=>{throw console.error("Failed to load inline module",e),e}).finally(()=>URL.revokeObjectURL(r));componentCache[t]=a,i.push(a)}}else{const o=document.createElement("script");if(Array.from(e.attributes||[]).forEach(e=>{o.setAttribute(e.name,e.value)}),o.textContent=e.textContent,o.src){const e=new Promise((e,t)=>{o.onload=e,o.onerror=t});i.push(e)}t.appendChild(o)}}else if("STYLE"===e.nodeName||"LINK"===e.nodeName&&"stylesheet"===e.rel){const o=e.cloneNode(!0);if("LINK"===o.tagName&&"stylesheet"===o.rel){const e=new Promise((e,t)=>{o.onload=e,o.onerror=t});i.push(e)}t.appendChild(o)}else{const o=e.cloneNode(!0);t.appendChild(o)}await Promise.all(i);const m=t.querySelector(":scope > .loading");return m&&t.removeChild(m),c}catch(e){throw console.error("Error importing component:",e),e}finally{importLocks.delete(o)}}}export async function loadComponents(e=[document.documentElement]){try{const t=(Array.isArray(e)?e:[e]).flatMap(e=>Array.from(e.querySelectorAll("x-component")));if(0===t.length)return;await Promise.all(t.map(async e=>{const t=e.getAttribute("path");t?await importComponent(t,e):console.error("x-component missing path attribute:",e)}))}catch(e){console.error("Error loading components:",e)}}export function getParentAttributes(e){let t=e,o={};for(;t;){if("x-component"===t.tagName.toLowerCase())for(let e of t.attributes)try{o[e.name]=JSON.parse(e.value)}catch(t){o[e.name]=e.value}t=t.parentElement}return o}globalThis.xAttrs=getParentAttributes,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>loadComponents()):loadComponents();const observer=new MutationObserver(e=>{for(const t of e)for(const e of t.addedNodes)1===e.nodeType&&(e.matches?.("x-component")?importComponent(e.getAttribute("path"),e):e.querySelectorAll&&loadComponents([e]))});observer.observe(document.body,{childList:!0,subtree:!0});