import{TIMING as t,API_ENDPOINTS as e}from"./constants.min.js";import s from"./logger.min.js";const i={isOpen:!1,settings:{},resolvePromise:null,activeTab:"agent",provider:"cloudflared",get filteredSections(){if(!this.settings||!this.settings.sections)return[];const t=this.settings.sections.filter(t=>t.tab===this.activeTab);return 0===t.length?this.settings.sections:t},switchTab(t){if(this.activeTab=t,"undefined"!=typeof Alpine&&Alpine.store){const e=Alpine.store("root");e&&(e.activeTab=t)}try{localStorage.setItem("settingsActiveTab",t)}catch(t){}setTimeout(()=>{const e=document.querySelector(".settings-tab.active");if(e&&e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"}),"scheduler"===t){const t=document.querySelector('[x-data="schedulerSettings"]');if(t){const e=Alpine.$data(t);e&&("function"==typeof e.startPolling&&e.startPolling(),"function"==typeof e.initFlatpickr&&(e.isCreating?e.initFlatpickr("create"):e.isEditing&&e.initFlatpickr("edit")),"function"==typeof e.fetchTasks&&e.fetchTasks())}}},10)},async openModal(){const e=document.getElementById("settingsModal");if(!e||"undefined"==typeof Alpine||!Alpine.$data)return void s.error("Settings modal not ready - Alpine not initialized");const i=Alpine.$data(e);if("undefined"!=typeof Alpine&&Alpine.store){const t=Alpine.store("root");t&&(t.isOpen=!0)}try{const e={title:"Settings",buttons:[{id:"save",title:"Save",classes:"btn btn-ok"},{id:"cancel",title:"Cancel",type:"secondary",classes:"btn btn-cancel"}],sections:(await sendJsonData("/settings_get",null)).settings.sections};i.isOpen=!0,i.settings=e,setTimeout(()=>{let t="agent";try{t=localStorage.getItem("settingsActiveTab")||"agent"}catch(t){}if(i.activeTab=t,"undefined"!=typeof Alpine&&Alpine.store){const e=Alpine.store("root");e&&(e.activeTab=t)}try{localStorage.setItem("settingsActiveTab",t)}catch(t){}setTimeout(()=>{const t=document.querySelector(".settings-tab.active");if(t&&t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"}),"scheduler"===i.activeTab){const t=document.querySelector('[x-data="schedulerSettings"]');if(t){const e=Alpine.$data(t);e&&"function"==typeof e.startPolling&&(e.startPolling(),"function"==typeof e.fetchTasks&&e.fetchTasks())}}},10)},5);const s=document.querySelector('[x-data="schedulerSettings"]');if(s){const e=()=>{const t=Alpine.$data(s);if(t){const e=document.querySelector(".modal-footer button.btn-ok");e&&"scheduler"===i.activeTab&&(t.isCreating||t.isEditing)?(e.disabled=!0,e.classList.add("btn-disabled")):e&&(e.disabled=!1,e.classList.remove("btn-disabled"))}};new MutationObserver(e).observe(s,{attributes:!0,subtree:!0,childList:!0}),i.$watch("activeTab",e),setTimeout(e,t.CHECK_DELAY)}return new Promise(t=>{this.resolvePromise=t})}catch(t){window.toastFetchError("Error getting settings",t)}},async handleButton(t){if("save"===t){const t=document.getElementById("settingsModal"),e=Alpine.$data(t);try{resp=await window.sendJsonData("/settings_set",e.settings)}catch(t){return void window.toastFetchError("Error saving settings",t)}document.dispatchEvent(new CustomEvent("settings-updated",{detail:resp.settings})),this.resolvePromise({status:"saved",data:resp.settings})}else"cancel"===t&&this.handleCancel();if(this.stopSchedulerPolling(),this.isOpen=!1,"undefined"!=typeof Alpine&&Alpine.store){const t=Alpine.store("root");t&&setTimeout(()=>{t.isOpen=!1},10)}},async handleCancel(){if(this.resolvePromise({status:"cancelled",data:null}),this.stopSchedulerPolling(),this.isOpen=!1,"undefined"!=typeof Alpine&&Alpine.store){const t=Alpine.store("root");t&&setTimeout(()=>{t.isOpen=!1},10)}},stopSchedulerPolling(){const t=document.querySelector('[x-data="schedulerSettings"]');if(t){const e=Alpine.$data(t);e&&"function"==typeof e.stopPolling&&e.stopPolling()}},async handleFieldButton(t){"mcp_servers_config"===t.id?openModal("settings/mcp/client/mcp-servers.html"):"backup_create"===t.id?openModal("settings/backup/backup.html"):"backup_restore"===t.id?openModal("settings/backup/restore.html"):"show_a2a_connection"===t.id?openModal("settings/external/a2a-connection.html"):"external_api_examples"===t.id?openModal("settings/external/api-examples.html"):"memory_dashboard"===t.id&&openModal("settings/memory/memory-dashboard.html")}};function n(t,e="info"){if(!(window.Alpine&&window.Alpine.store&&window.Alpine.store("notificationStore")))return s.info(`SETTINGS ${e.toUpperCase()}: ${t}`),null;{const s=window.Alpine.store("notificationStore");switch(e.toLowerCase()){case"error":return s.frontendError(t,"Settings",5);case"success":case"info":default:return s.frontendInfo(t,"Settings",3);case"warning":return s.frontendWarning(t,"Settings",4)}}}document.addEventListener("alpine:init",function(){let t="agent";try{t=localStorage.getItem("settingsActiveTab")||"agent"}catch(t){}Alpine.store("root",{activeTab:t,isOpen:!1,toggleSettings(){this.isOpen=!this.isOpen}}),Alpine.data("settingsModal",function(){return{settingsData:{},filteredSections:[],activeTab:"agent",isLoading:!0,async init(){if("undefined"!=typeof Alpine&&Alpine.store){const t=Alpine.store("root");this.activeTab=t?.activeTab||"agent"}this.$watch("$store.root.activeTab",t=>{if(void 0!==t){this.activeTab=t;try{localStorage.setItem("settingsActiveTab",t)}catch(t){}this.updateFilteredSections()}}),await this.fetchSettings(),this.updateFilteredSections()},switchTab(t){if(this.activeTab=t,"undefined"!=typeof Alpine&&Alpine.store){const e=Alpine.store("root");e&&(e.activeTab=t)}},async fetchSettings(){try{this.isLoading=!0;const t=await fetchApi(e.SETTINGS_GET,{method:"POST",headers:{"Content-Type":"application/json"}});if(t.ok){const e=await t.json();e&&e.settings&&(this.settingsData=e.settings)}}catch(t){s.error("Error fetching settings:",t)}finally{this.isLoading=!1}},updateFilteredSections(){"agent"===this.activeTab?this.filteredSections=this.settingsData.sections?.filter(t=>"agent"===t.tab)||[]:"external"===this.activeTab?this.filteredSections=this.settingsData.sections?.filter(t=>"external"===t.tab)||[]:"developer"===this.activeTab?this.filteredSections=this.settingsData.sections?.filter(t=>"developer"===t.tab)||[]:"mcp"===this.activeTab?this.filteredSections=this.settingsData.sections?.filter(t=>"mcp"===t.tab)||[]:"backup"===this.activeTab?this.filteredSections=this.settingsData.sections?.filter(t=>"backup"===t.tab)||[]:this.filteredSections=[]},async saveSettings(){try{for(const t of this.settingsData.sections)for(const e of t.fields)if(e.required&&(!e.value||""===e.value.trim()))return void n(`${e.title} in ${t.title} is required`,"error");const t={};for(const e of this.settingsData.sections)for(const s of e.fields)t[s.id]=s.value;const s=await fetchApi(e.SETTINGS_SAVE,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok){const t=await s.json();throw new Error(t.error||"Failed to save settings")}n("Settings saved successfully","success"),await this.fetchSettings()}catch(t){s.error("Error saving settings:",t),n("Error saving settings","error")}},async handleButtonAction(t){s.warn("Unknown button action:",t.action)},async testConnection(t){try{t.testResult="Testing...",t.testStatus="loading";let s="";for(const e of this.settingsData.sections)for(const i of e.fields)if(i.id===t.target){s=i.value;break}if(!s)throw new Error("API key is required");const i=await fetchApi(e.TEST_CONNECTION,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:t.service,api_key:s})}),n=await i.json();if(!i.ok||!n.success)throw new Error(n.error||"Connection failed");t.testResult="Connection successful!",t.testStatus="success"}catch(e){s.error("Connection test failed:",e),t.testResult=`Failed: ${e.message}`,t.testStatus="error"}},revealToken(t){for(const e of this.settingsData.sections)for(const s of e.fields)if(s.id===t.target){s.type="password"===s.type?"text":"password",t.value="password"===s.type?"Show":"Hide";break}},generateToken(t){for(const e of this.settingsData.sections)for(const s of e.fields)if(s.id===t.target){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let s=0;s<32;s++)e+=t.charAt(Math.floor(Math.random()*t.length));s.value=e;break}},closeModal(){const t=document.querySelector('[x-data="schedulerSettings"]');if(t){const e=Alpine.$data(t);e&&"function"==typeof e.stopPolling&&e.stopPolling()}this.$store.root.isOpen=!1}}})}),globalThis.settingsModalProxy=i;