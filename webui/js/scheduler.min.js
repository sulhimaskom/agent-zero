import{formatDateTime as t,getUserTimezone as e}from"./time-utils.js";import{store as s}from"/components/sidebar/chats/chats-store.js";import{store as i}from"/components/notifications/notification-store.js";import{store as a}from"/components/projects/projects-store.js";import{TIMING as n}from"./constants.js";import r from"./logger.js";const o=function(t,e="info"){switch(e.toLowerCase()){case"error":return i.frontendError(t,"Scheduler",5);case"success":case"info":default:return i.frontendInfo(t,"Scheduler",3);case"warning":return i.frontendWarning(t,"Scheduler",4)}},l=function(){return{tasks:[],isLoading:!0,selectedTask:null,expandedTaskId:null,sortField:"name",sortDirection:"asc",filterType:"all",filterState:"all",pollingInterval:null,pollingActive:!1,editingTask:{name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:e()},token:"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[],project:null,dedicated_context:!0},projectOptions:[],selectedProjectSlug:"",isCreating:!1,isEditing:!1,showLoadingState:!1,viewMode:"list",selectedTaskForDetail:null,attachmentsText:"",filteredTasks:[],hasNoTasks:!0,init(){this.tasks=[],this.isLoading=!0,this.hasNoTasks=!0,this.filterType="all",this.filterState="all",this.sortField="name",this.sortDirection="asc",this.pollingInterval=null,this.pollingActive=!1,this.startPolling(),this.fetchTasks(),document.addEventListener("click",t=>{const e=t.target.closest(".settings-tab");e&&"scheduler"===e.getAttribute("data-tab")&&setTimeout(()=>{this.fetchTasks()},n.SETUP_DELAY)}),this.$watch("tasks",t=>{this.updateTasksUI()}),this.$watch("filterType",()=>{this.updateTasksUI()}),this.$watch("filterState",()=>{this.updateTasksUI()});try{this.viewMode=localStorage.getItem("scheduler_view_mode")||"list"}catch(t){this.viewMode="list"}this.selectedTask=null,this.expandedTaskId=null,this.editingTask={name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:e()},token:this.generateRandomToken?this.generateRandomToken():"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[],project:null,dedicated_context:!0},this.refreshProjectOptions(),this.$nextTick(()=>{setTimeout(()=>{this.isCreating?this.initFlatpickr("create"):this.isEditing&&this.initFlatpickr("edit")},n.SETUP_DELAY)}),this.$cleanup=()=>{r.debug("Cleaning up schedulerSettings component"),this.stopPolling();const t=document.getElementById("newPlannedTime-create");t&&t._flatpickr&&t._flatpickr.destroy();const e=document.getElementById("newPlannedTime-edit");e&&e._flatpickr&&e._flatpickr.destroy()}},startPolling(){this.pollingInterval?r.debug("Polling already active, not starting again"):(r.debug("Starting task polling"),this.pollingActive=!0,this.fetchTasks(),this.pollingInterval=setInterval(()=>{this.pollingActive&&this.fetchTasks()},n.SCHEDULER_POLL_INTERVAL))},stopPolling(){r.debug("Stopping task polling"),this.pollingActive=!1,this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)},async fetchTasks(){if((this.pollingActive||!this.pollingInterval)&&!this.isCreating&&!this.isEditing){this.isLoading=!0;try{const t=await fetchApi("/scheduler_tasks_list",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({timezone:e()})});if(!t.ok)throw new Error("Failed to fetch tasks");const s=await t.json();if(s&&s.tasks)if(Array.isArray(s.tasks)){const t=s.tasks.filter(t=>!(!t||"object"!=typeof t)&&(!!t.uuid&&(!!t.name&&!!t.type)));this.tasks=t,this.updateTasksUI()}else this.tasks=[];else this.tasks=[]}catch(t){t.message?.includes("CSRF token unavailable")||t.message?.includes("CSRF token endpoint returned")||t.message?.includes("backend not running")||t.message?.includes("Failed to fetch")||this.pollingInterval||o("Failed to fetch tasks: "+t.message,"error"),this.tasks=[]}finally{this.isLoading=!1}}},changeSort(t){this.sortField===t?this.sortDirection="asc"===this.sortDirection?"desc":"asc":(this.sortField=t,this.sortDirection="asc")},toggleTaskExpand(t){this.expandedTaskId===t?this.expandedTaskId=null:this.expandedTaskId=t},showTaskDetail(t){const e=this.tasks.find(e=>e.uuid===t);e?(this.selectedTaskForDetail=JSON.parse(JSON.stringify(e)),this.selectedTaskForDetail.attachments||(this.selectedTaskForDetail.attachments=[]),this.viewMode="detail"):o("Task not found","error")},closeTaskDetail(){this.selectedTaskForDetail=null,this.viewMode="list"},formatDate:e=>e?t(e,"full"):"Never",formatPlan(e){if(!e||!e.plan)return"No plan";const s=Array.isArray(e.plan.todo)?e.plan.todo.length:0,i=e.plan.in_progress?"Yes":"No",a=Array.isArray(e.plan.done)?e.plan.done.length:0;let n="";if(Array.isArray(e.plan.todo)&&e.plan.todo.length>0)try{const s=new Date(e.plan.todo[0]);n=isNaN(s.getTime())?"Invalid date":t(s,"short")}catch(t){n="Error"}else n="None";return`Next: ${n}\nTodo: ${s}\nIn Progress: ${i}\nDone: ${a}`},formatSchedule(t){if(!t.schedule)return"None";let e="";return"string"==typeof t.schedule?e=t.schedule:"object"==typeof t.schedule&&(e=`${t.schedule.minute||"*"} ${t.schedule.hour||"*"} ${t.schedule.day||"*"} ${t.schedule.month||"*"} ${t.schedule.weekday||"*"}`),e},getStateBadgeClass(t){switch(t){case"idle":return"scheduler-status-idle";case"running":return"scheduler-status-running";case"disabled":return"scheduler-status-disabled";case"error":return"scheduler-status-error";default:return""}},deriveActiveProject(){const t=s?.selectedContext||null;if(!t||!t.project)return null;const e=t.project;return{name:e.name||null,title:e.title||e.name||null,color:e.color||""}},formatProjectName(t){if(!t)return"No Project";return t.title||t.name||"No Project"},formatProjectLabel(t){return`Project: ${this.formatProjectName(t)}`},async refreshProjectOptions(){try{Array.isArray(a.projectList)&&a.projectList.length||"function"==typeof a.loadProjectsList&&await a.loadProjectsList()}catch(t){}const t=Array.isArray(a.projectList)?a.projectList:[];this.projectOptions=t.map(t=>({name:t.name,title:t.title||t.name,color:t.color||""}))},onProjectSelect(t){if(this.selectedProjectSlug=t||"",!t)return void(this.editingTask.project=null);const e=this.projectOptions.find(e=>e.name===t);this.editingTask.project=e?{...e}:{name:t,title:t,color:""}},extractTaskProject(t){if(!t)return null;const e=t.project_name||null,s=t.project||{},i=s.name||e,a=t.project_color||s.color||"";return e||i?{name:e,title:i||e,color:a}:null},formatTaskProject(t){return this.formatProjectName(this.extractTaskProject(t))},async startCreateTask(){this.isCreating=!0,this.isEditing=!1,document.querySelector('[x-data="schedulerSettings"]')?.setAttribute("data-editing-state","creating"),await this.refreshProjectOptions();const t=this.deriveActiveProject();let s=t?{...t}:null;!s&&this.projectOptions.length>0&&(s={...this.projectOptions[0]}),this.editingTask={name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:e()},token:this.generateRandomToken(),plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[],project:s,dedicated_context:!0},this.selectedProjectSlug=s&&s.name?s.name:"",this.$nextTick(()=>{this.initFlatpickr("create")})},async startEditTask(t){const s=this.tasks.find(e=>e.uuid===t);if(!s)return void o("Task not found","error");this.isCreating=!1,this.isEditing=!0,document.querySelector('[x-data="schedulerSettings"]')?.setAttribute("data-editing-state","editing"),this.editingTask=JSON.parse(JSON.stringify(s));const i=s.project_name||null,a=s.project&&s.project.name||i,n=s.project_color||(s.project?s.project.color:"")||"";if(this.editingTask.project=i||a?{name:i,title:a,color:n}:null,this.editingTask.dedicated_context=!!s.dedicated_context,this.selectedProjectSlug=this.editingTask.project&&this.editingTask.project.name?this.editingTask.project.name:"",r.debug("Task data for editing:",s),r.debug("Attachments from task:",s.attachments),this.editingTask.state||(this.editingTask.state="idle"),this.editingTask.schedule&&"string"!=typeof this.editingTask.schedule)this.editingTask.schedule.timezone||(this.editingTask.schedule.timezone=e());else{let t={minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:e()};if("string"==typeof this.editingTask.schedule){const e=this.editingTask.schedule.split(" ");e.length>=5&&(t.minute=e[0]||"*",t.hour=e[1]||"*",t.day=e[2]||"*",t.month=e[3]||"*",t.weekday=e[4]||"*")}this.editingTask.schedule=t}this.editingTask.attachments?"string"==typeof this.editingTask.attachments?this.editingTask.attachments=this.editingTask.attachments.split("\n").map(t=>t.trim()).filter(t=>t.length>0):Array.isArray(this.editingTask.attachments)||(this.editingTask.attachments=[]):this.editingTask.attachments=[],"scheduled"===this.editingTask.type?(this.editingTask.token||(this.editingTask.token=""),this.editingTask.plan||(this.editingTask.plan={todo:[],in_progress:null,done:[]})):"adhoc"===this.editingTask.type?(this.editingTask.token||(this.editingTask.token=this.generateRandomToken()),this.editingTask.plan||(this.editingTask.plan={todo:[],in_progress:null,done:[]})):"planned"===this.editingTask.type&&(this.editingTask.plan||(this.editingTask.plan={todo:[],in_progress:null,done:[]}),Array.isArray(this.editingTask.plan.todo)||(this.editingTask.plan.todo=[]),this.editingTask.token||(this.editingTask.token="")),this.$nextTick(()=>{this.initFlatpickr("edit")})},cancelEdit(){const t=t=>{const e=document.getElementById(t);if(e&&e._flatpickr){e._flatpickr.destroy();const t=e.closest(".scheduler-flatpickr-wrapper");t&&t.parentNode&&(t.parentNode.insertBefore(e,t),t.parentNode.removeChild(t)),e.classList.remove("scheduler-flatpickr-input")}};this.isCreating?t("newPlannedTime-create"):this.isEditing&&t("newPlannedTime-edit"),this.editingTask={name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:e()},token:"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[],project:null,dedicated_context:!0},this.selectedProjectSlug="",this.isCreating=!1,this.isEditing=!1,document.querySelector('[x-data="schedulerSettings"]')?.removeAttribute("data-editing-state")},async saveTask(){if(this.editingTask.name.trim()&&this.editingTask.prompt.trim())try{let t,s;if(s={name:this.editingTask.name,system_prompt:this.editingTask.system_prompt||"",prompt:this.editingTask.prompt||"",state:this.editingTask.state||"idle",timezone:e()},this.isCreating&&this.editingTask.project&&(this.editingTask.project.name&&(s.project_name=this.editingTask.project.name),this.editingTask.project.color&&(s.project_color=this.editingTask.project.color)),s.attachments=Array.isArray(this.editingTask.attachments)?this.editingTask.attachments.map(t=>"string"==typeof t?t.trim():t).filter(t=>t&&t.trim().length>0):[],"scheduled"===this.editingTask.type){if("string"==typeof this.editingTask.schedule){const t=this.editingTask.schedule.split(" ");s.schedule={minute:t[0]||"*",hour:t[1]||"*",day:t[2]||"*",month:t[3]||"*",weekday:t[4]||"*",timezone:e()}}else s.schedule={...this.editingTask.schedule,timezone:this.editingTask.schedule.timezone||e()};delete s.token,delete s.plan}else if("adhoc"===this.editingTask.type)this.editingTask.token||(this.editingTask.token=this.generateRandomToken()),s.token=this.editingTask.token,delete s.schedule,delete s.plan;else if("planned"===this.editingTask.type){this.editingTask.plan||(this.editingTask.plan={todo:[],in_progress:null,done:[]}),Array.isArray(this.editingTask.plan.todo)||(this.editingTask.plan.todo=[]),Array.isArray(this.editingTask.plan.done)||(this.editingTask.plan.done=[]);const t=[];for(const e of this.editingTask.plan.todo)try{const s=new Date(e);isNaN(s.getTime())||t.push(s.toISOString())}catch(t){}this.editingTask.plan.todo=t,this.editingTask.plan.todo.sort(),s.plan={todo:this.editingTask.plan.todo,in_progress:this.editingTask.plan.in_progress,done:this.editingTask.plan.done||[]},delete s.schedule,delete s.token}this.isCreating?t="/scheduler_task_create":(t="/scheduler_task_update",s.task_id=this.editingTask.uuid);const i=await fetchApi(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok){const t=await i.json();throw new Error(t.error||"Failed to save task")}const a=await i.json();o(this.isCreating?"Task created successfully":"Task updated successfully","success"),a&&a.task?(this.isCreating?this.tasks=[...this.tasks,a.task]:this.tasks=this.tasks.map(t=>t.uuid===a.task.uuid?a.task:t),this.updateTasksUI()):await this.fetchTasks();const n=t=>{const e=document.getElementById(t);e&&e._flatpickr&&e._flatpickr.destroy()};this.isCreating?n("newPlannedTime-create"):this.isEditing&&n("newPlannedTime-edit"),this.editingTask={name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:e()},token:"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[],project:null,dedicated_context:!0},this.isCreating=!1,this.isEditing=!1,document.querySelector('[x-data="schedulerSettings"]')?.removeAttribute("data-editing-state")}catch(t){o("Failed to save task: "+t.message,"error")}else alert("Task name and prompt are required")},async runTask(t){try{const s=await fetchApi("/scheduler_task_run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({task_id:t,timezone:e()})}),i=await s.json();if(!s.ok)throw new Error(i?.error||"Failed to run task");const a=i.warning||i.message||"Task started successfully",n=i.warning?"warning":"success";o(a,n),this.fetchTasks()}catch(t){o("Failed to run task: "+t.message,"error")}},async resetTaskState(t){try{const s=this.tasks.find(e=>e.uuid===t);if(!s)return void o("Task not found","error");if("idle"===s.state)return void o("Task is already in idle state","info");this.showLoadingState=!0;const i=await fetchApi("/scheduler_task_update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({task_id:t,state:"idle",timezone:e()})});if(!i.ok){const t=await i.json();throw new Error(t.error||"Failed to reset task state")}o("Task state reset to idle","success"),await this.fetchTasks(),this.showLoadingState=!1}catch(t){o("Failed to reset task state: "+t.message,"error"),this.showLoadingState=!1}},async deleteTask(t){if(confirm("Are you sure you want to delete this task? This action cannot be undone."))try{await s.switchFromContext(t);const i=await fetchApi("/scheduler_task_delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({task_id:t,timezone:e()})});if(!i.ok){const t=await i.json();throw new Error(t.error||"Failed to delete task")}o("Task deleted successfully","success"),this.selectedTaskForDetail&&this.selectedTaskForDetail.uuid===t&&this.closeTaskDetail(),this.tasks=this.tasks.filter(e=>e.uuid!==t),this.updateTasksUI()}catch(t){o("Failed to delete task: "+t.message,"error")}},initDateTimeInput(t){if(!t.target.value){const e=new Date;e.setMinutes(e.getMinutes()+30);const s=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");t.target.value=`${s}-${i}-${a}T${n}:${r}`,t.target._flatpickr&&t.target._flatpickr.setDate(t.target.value)}},generateRandomToken(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let s=0;s<16;s++)e+=t.charAt(Math.floor(62*Math.random()));return e},get filteredTasks(){if(!Array.isArray(this.tasks))return[];let t=[...this.tasks];return this.filterType&&"all"!==this.filterType&&(t=t.filter(t=>!!t.type&&String(t.type).toLowerCase()===this.filterType.toLowerCase())),this.filterState&&"all"!==this.filterState&&(t=t.filter(t=>!!t.state&&String(t.state).toLowerCase()===this.filterState.toLowerCase())),this.sortTasks(t)},sortTasks(t){return Array.isArray(t)&&0!==t.length?[...t].sort((t,e)=>{if(!this.sortField)return 0;const s=t[this.sortField],i=e[this.sortField];if(void 0===s&&void 0===i)return 0;if(void 0===s)return 1;if(void 0===i)return-1;if("createdAt"===this.sortField||"updatedAt"===this.sortField){const t=new Date(s).getTime(),e=new Date(i).getTime();return"asc"===this.sortDirection?t-e:e-t}return"string"==typeof s&&"string"==typeof i?"asc"===this.sortDirection?s.localeCompare(i):i.localeCompare(s):"asc"===this.sortDirection?s-i:i-s}):t},get attachmentsText(){return(Array.isArray(this.editingTask.attachments)?this.editingTask.attachments:[]).join("\n")},set attachmentsText(t){this.editingTask.attachments="string"==typeof t?t.split("\n"):[]},testFiltering(){},initFlatpickr(t="all"){const e=(t,e,s,i={})=>{let a=this.$refs[e];if(a||(a=document.getElementById(t)),!a)return r.warn(`Input element ${t} not found by ID or ref`),null;const n=document.createElement("div");n.className=s||"scheduler-flatpickr-wrapper",n.style.overflow="visible",a.parentNode.insertBefore(n,a),n.appendChild(a),a.classList.add("scheduler-flatpickr-input");const o={...{dateFormat:"Y-m-d H:i",enableTime:!0,time_24hr:!0,static:!1,appendTo:document.body,theme:"scheduler-theme",allowInput:!0,positionElement:n,onOpen:function(t,e,s){s.calendarContainer.style.zIndex="9999",s.calendarContainer.style.position="absolute",s.calendarContainer.style.visibility="visible",s.calendarContainer.style.opacity="1",s.calendarContainer.classList.add("scheduler-theme")},onReady:function(t,e,s){if(!e){const t=new Date;t.setMinutes(t.getMinutes()+30),s.setDate(t,!0)}}},...i},l=flatpickr(a,o),d=document.createElement("button");return d.className="scheduler-flatpickr-clear",d.innerHTML="Ã—",d.type="button",d.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),l&&l.clear()}),n.appendChild(d),l};if("all"===t||"create"===t){const t=document.getElementById("newPlannedTime-create");t&&t._flatpickr&&t._flatpickr.destroy()}if("all"===t||"edit"===t){const t=document.getElementById("newPlannedTime-edit");t&&t._flatpickr&&t._flatpickr.destroy()}"all"!==t&&"create"!==t||e("newPlannedTime-create","plannedTimeCreate","scheduler-flatpickr-wrapper",{minuteIncrement:5,defaultHour:(new Date).getHours(),defaultMinute:5*Math.ceil((new Date).getMinutes()/5)}),"all"!==t&&"edit"!==t||e("newPlannedTime-edit","plannedTimeEdit","scheduler-flatpickr-wrapper",{minuteIncrement:5,defaultHour:(new Date).getHours(),defaultMinute:5*Math.ceil((new Date).getMinutes()/5)})},updateTasksUI(){"function"==typeof this.updateFilteredTasks&&this.updateFilteredTasks(),this.$nextTick(()=>{const t=document.querySelector(".scheduler-empty"),e=document.querySelector(".scheduler-task-list"),s=Array.isArray(this.filteredTasks)&&this.filteredTasks.length>0;t&&(t.style.display=s?"none":""),e&&(e.style.display=s?"":"none")})}}};if(window.schedulerSettings){const t=window.schedulerSettings;window.schedulerSettings=function(){const e=t(),s=e.init||function(){};return e.init=function(){s.call(this);const t=l();Object.keys(t).forEach(e=>{"init"!==e&&"function"==typeof t[e]&&(this[e]=t[e])}),"function"==typeof this.refreshProjectOptions&&this.refreshProjectOptions(),window.deleteTaskGlobal=this.deleteTask.bind(this),this.filteredTasks=[],Array.isArray(this.tasks)||(this.tasks=[]),Array.isArray(this.projectOptions)||(this.projectOptions=[]),"string"!=typeof this.selectedProjectSlug&&(this.selectedProjectSlug=""),Object.getOwnPropertyDescriptor(this,"attachmentsText")?.get||Object.defineProperty(this,"attachmentsText",{get:function(){return(Array.isArray(this.editingTask?.attachments)?this.editingTask.attachments:[]).join("\n")},set:function(t){this.editingTask||(this.editingTask={attachments:[],project:null,dedicated_context:!0}),this.editingTask.attachments="string"==typeof t?t.split("\n"):[]}}),"function"!=typeof this.updateFilteredTasks&&(this.updateFilteredTasks=function(){if(!Array.isArray(this.tasks))return void(this.filteredTasks=[]);let t=[...this.tasks];this.filterType&&"all"!==this.filterType&&(t=t.filter(t=>!!t.type&&String(t.type).toLowerCase()===this.filterType.toLowerCase())),this.filterState&&"all"!==this.filterState&&(t=t.filter(t=>!!t.state&&String(t.state).toLowerCase()===this.filterState.toLowerCase())),"function"==typeof this.sortTasks&&(t=this.sortTasks(t)),this.filteredTasks=t}),this.$nextTick(()=>{this.$watch("tasks",()=>{this.updateFilteredTasks()}),this.$watch("filterType",()=>{this.updateFilteredTasks()}),this.$watch("filterState",()=>{this.updateFilteredTasks()}),this.$watch("sortField",()=>{this.updateFilteredTasks()}),this.$watch("sortDirection",()=>{this.updateFilteredTasks()}),this.updateFilteredTasks(),this.$watch("editingTask.type",t=>{"planned"===t&&this.$nextTick(()=>{this.isCreating?this.initFlatpickr("create"):this.isEditing&&this.initFlatpickr("edit")})}),this.$nextTick(()=>{"function"==typeof this.initFlatpickr&&this.initFlatpickr()})}),setTimeout(()=>{"function"==typeof this.fetchTasks&&this.fetchTasks()},n.SETUP_DELAY)},e}}else window.schedulerSettings=l;window.Alpine?window.Alpine.data("schedulerSettings",window.schedulerSettings):document.addEventListener("alpine:init",()=>{Alpine.data("schedulerSettings",window.schedulerSettings)}),document.addEventListener("DOMContentLoaded",function(){const t=()=>{const e=document.getElementById("settingsModal");e?document.addEventListener("click",function(t){if(t.target.closest('.settings-tab[title="Task Scheduler"]')){t.preventDefault(),t.stopPropagation();try{const t=Alpine.$data(e);"scheduler"!==t.activeTab&&t.switchTab("scheduler"),setTimeout(()=>{const t=document.querySelector('[x-data="schedulerSettings"]');if(t){const e=Alpine.$data(t);"function"==typeof e.fetchTasks&&e.fetchTasks(),"function"==typeof e.startPolling&&e.startPolling()}},n.SETUP_DELAY)}catch(t){r.error("Error handling scheduler tab click:",t)}}},!0):setTimeout(t,n.SETUP_DELAY)};t()});