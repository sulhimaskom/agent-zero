import{formatDateTime,getUserTimezone}from"./time-utils.js";import{store as chatsStore}from"/components/sidebar/chats/chats-store.min.js";import{store as notificationsStore}from"/components/notifications/notification-store.min.js";import{store as projectsStore}from"/components/projects/projects-store.min.js";import{TIMING}from"./constants.js";import Logger from"./logger.min.js";import{formatDate,formatPlan,formatSchedule,getStateBadgeClass}from"./stores/scheduler/formatting.js";import{generateRandomToken,initDateTimeInput,initFlatpickr as initFlatpickrModule}from"./stores/scheduler/datetime.js";import{startPolling as startPollingModule,stopPolling as stopPollingModule,fetchTasks as fetchTasksModule}from"./stores/scheduler/polling.js";import{changeSort as changeSortModule,toggleTaskExpand as toggleTaskExpandModule,showTaskDetail as showTaskDetailModule,closeTaskDetail as closeTaskDetailModule,sortTasks as sortTasksModule,getFilteredTasks,testFiltering as testFilteringModule,updateTasksUI as updateTasksUIModule,getAttachmentsText,setAttachmentsText}from"./stores/scheduler/ui.js";import{deriveActiveProject as deriveActiveProjectModule,formatProjectName as formatProjectNameModule,formatProjectLabel as formatProjectLabelModule,refreshProjectOptions as refreshProjectOptionsModule,onProjectSelect as onProjectSelectModule,extractTaskProject as extractTaskProjectModule,formatTaskProject as formatTaskProjectModule,startCreateTask as startCreateTaskModule,startEditTask as startEditTaskModule,cancelEdit as cancelEditModule,saveTask as saveTaskModule,runTask as runTaskModule,resetTaskState as resetTaskStateModule,deleteTask as deleteTaskModule}from"./stores/scheduler/tasks.js";const showToast=function(t,e="info"){switch(e.toLowerCase()){case"error":return notificationsStore.frontendError(t,"Scheduler",5);case"success":case"info":default:return notificationsStore.frontendInfo(t,"Scheduler",3);case"warning":return notificationsStore.frontendWarning(t,"Scheduler",4)}};import{setShowToast as setPollingToast}from"./stores/scheduler/polling.js";import{setShowToastUi as setUiToast}from"./stores/scheduler/ui.js";import{setShowToast as setTasksToast}from"./stores/scheduler/tasks.js";setPollingToast(showToast),setUiToast(showToast),setTasksToast(showToast);const fullComponentImplementation=function(){return{tasks:[],isLoading:!0,selectedTask:null,expandedTaskId:null,sortField:"name",sortDirection:"asc",filterType:"all",filterState:"all",pollingInterval:null,pollingActive:!1,editingTask:{name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:getUserTimezone()},token:"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[],project:null,dedicated_context:!0},projectOptions:[],selectedProjectSlug:"",isCreating:!1,isEditing:!1,showLoadingState:!1,viewMode:"list",selectedTaskForDetail:null,attachmentsText:"",filteredTasks:[],hasNoTasks:!0,init(){this.tasks=[],this.isLoading=!0,this.hasNoTasks=!0,this.filterType="all",this.filterState="all",this.sortField="name",this.sortDirection="asc",this.pollingInterval=null,this.pollingActive=!1,this.startPolling(),this.fetchTasks(),this._schedulerTabClickHandler=t=>{const e=t.target.closest(".settings-tab");e&&"scheduler"===e.getAttribute("data-tab")&&setTimeout(()=>{this.fetchTasks()},TIMING.SETUP_DELAY)},document.addEventListener("click",this._schedulerTabClickHandler),this.$watch("tasks",t=>{this.updateTasksUI()}),this.$watch("filterType",()=>{this.updateTasksUI()}),this.$watch("filterState",()=>{this.updateTasksUI()});try{this.viewMode=localStorage.getItem("scheduler_view_mode")||"list"}catch(t){this.viewMode="list"}this.selectedTask=null,this.expandedTaskId=null,this.editingTask={name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:getUserTimezone()},token:this.generateRandomToken?this.generateRandomToken():"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[],project:null,dedicated_context:!0},this.refreshProjectOptions(),this.$nextTick(()=>{setTimeout(()=>{this.isCreating?this.initFlatpickr("create"):this.isEditing&&this.initFlatpickr("edit")},TIMING.SETUP_DELAY)}),this.$cleanup=()=>{Logger.debug("Cleaning up schedulerSettings component"),this.stopPolling();const t=document.getElementById("newPlannedTime-create");t&&t._flatpickr&&t._flatpickr.destroy();const e=document.getElementById("newPlannedTime-edit");e&&e._flatpickr&&e._flatpickr.destroy(),this._schedulerTabClickHandler&&(document.removeEventListener("click",this._schedulerTabClickHandler),this._schedulerTabClickHandler=null)}},startPolling(){startPollingModule.call(this)},stopPolling(){stopPollingModule.call(this)},async fetchTasks(){await fetchTasksModule.call(this)},changeSort(t){changeSortModule.call(this,t)},toggleTaskExpand(t){toggleTaskExpandModule.call(this,t)},showTaskDetail(t){showTaskDetailModule.call(this,t)},closeTaskDetail(){closeTaskDetailModule.call(this)},formatDate:t=>formatDate(t),formatPlan:t=>formatPlan(t),formatSchedule:t=>formatSchedule(t),getStateBadgeClass:t=>getStateBadgeClass(t),deriveActiveProject(){return deriveActiveProjectModule.call(this)},formatProjectName(t){return formatProjectNameModule.call(this,t)},formatProjectLabel(t){return formatProjectLabelModule.call(this,t)},async refreshProjectOptions(){await refreshProjectOptionsModule.call(this)},onProjectSelect(t){onProjectSelectModule.call(this,t)},extractTaskProject(t){return extractTaskProjectModule.call(this,t)},formatTaskProject(t){return formatTaskProjectModule.call(this,t)},async startCreateTask(){await startCreateTaskModule.call(this)},async startEditTask(t){await startEditTaskModule.call(this,t)},cancelEdit(){cancelEditModule.call(this)},async saveTask(){await saveTaskModule.call(this)},async runTask(t){await runTaskModule.call(this,t)},async resetTaskState(t){await resetTaskStateModule.call(this,t)},async deleteTask(t){await deleteTaskModule.call(this,t)},initDateTimeInput(t){initDateTimeInput(t)},generateRandomToken:()=>generateRandomToken(),get filteredTasks(){return getFilteredTasks.call(this)},sortTasks(t){return sortTasksModule.call(this,t)},get attachmentsText(){return getAttachmentsText.call(this)},set attachmentsText(t){setAttachmentsText.call(this,t)},testFiltering(){testFilteringModule()},initFlatpickr(t="all"){initFlatpickrModule.call(this,t)},updateTasksUI(){updateTasksUIModule.call(this)}}};if(window.schedulerSettings){const t=window.schedulerSettings;window.schedulerSettings=function(){const e=t(),s=e.init||function(){};return e.init=function(){s.call(this);const t=fullComponentImplementation();Object.keys(t).forEach(e=>{"init"!==e&&"function"==typeof t[e]&&(this[e]=t[e])}),"function"==typeof this.refreshProjectOptions&&this.refreshProjectOptions(),window.deleteTaskGlobal=this.deleteTask.bind(this),this.filteredTasks=[],Array.isArray(this.tasks)||(this.tasks=[]),Array.isArray(this.projectOptions)||(this.projectOptions=[]),"string"!=typeof this.selectedProjectSlug&&(this.selectedProjectSlug=""),Object.getOwnPropertyDescriptor(this,"attachmentsText")?.get||Object.defineProperty(this,"attachmentsText",{get:function(){return(Array.isArray(this.editingTask?.attachments)?this.editingTask.attachments:[]).join("\n")},set:function(t){this.editingTask||(this.editingTask={attachments:[],project:null,dedicated_context:!0}),this.editingTask.attachments="string"==typeof t?t.split("\n"):[]}}),"function"!=typeof this.updateFilteredTasks&&(this.updateFilteredTasks=function(){if(!Array.isArray(this.tasks))return void(this.filteredTasks=[]);let t=[...this.tasks];this.filterType&&"all"!==this.filterType&&(t=t.filter(t=>!!t.type&&String(t.type).toLowerCase()===this.filterType.toLowerCase())),this.filterState&&"all"!==this.filterState&&(t=t.filter(t=>!!t.state&&String(t.state).toLowerCase()===this.filterState.toLowerCase())),"function"==typeof this.sortTasks&&(t=this.sortTasks(t)),this.filteredTasks=t}),this.$nextTick(()=>{this.$watch("tasks",()=>{this.updateFilteredTasks()}),this.$watch("filterType",()=>{this.updateFilteredTasks()}),this.$watch("filterState",()=>{this.updateFilteredTasks()}),this.$watch("sortField",()=>{this.updateFilteredTasks()}),this.$watch("sortDirection",()=>{this.updateFilteredTasks()}),this.updateFilteredTasks(),this.$watch("editingTask.type",t=>{"planned"===t&&this.$nextTick(()=>{this.isCreating?this.initFlatpickr("create"):this.isEditing&&this.initFlatpickr("edit")})}),this.$nextTick(()=>{"function"==typeof this.initFlatpickr&&this.initFlatpickr()})}),setTimeout(()=>{"function"==typeof this.fetchTasks&&this.fetchTasks()},TIMING.SETUP_DELAY)},e}}else window.schedulerSettings=fullComponentImplementation;window.Alpine?window.Alpine.data("schedulerSettings",window.schedulerSettings):document.addEventListener("alpine:init",()=>{Alpine.data("schedulerSettings",window.schedulerSettings)}),document.addEventListener("DOMContentLoaded",function(){const t=()=>{const e=document.getElementById("settingsModal");e?document.addEventListener("click",function(t){if(t.target.closest('.settings-tab[title="Task Scheduler"]')){t.preventDefault(),t.stopPropagation();try{const t=Alpine.$data(e);"scheduler"!==t.activeTab&&t.switchTab("scheduler"),setTimeout(()=>{const t=document.querySelector('[x-data="schedulerSettings"]');if(t){const e=Alpine.$data(t);"function"==typeof e.fetchTasks&&e.fetchTasks(),"function"==typeof e.startPolling&&e.startPolling()}},TIMING.SETUP_DELAY)}catch(t){Logger.error("Error handling scheduler tab click:",t)}}},!0):setTimeout(t,TIMING.SETUP_DELAY)};t()});